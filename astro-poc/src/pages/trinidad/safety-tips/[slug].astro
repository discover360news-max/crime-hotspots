---
/**
 * Individual Safety Tip — SSR with Cloudflare CDN caching
 * Resolves related story IDs from CSV at request time.
 */

import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import Hero from '../../../components/Hero.astro';
import TipCard from '../../../components/TipCard.astro';
import { getTrinidadCrimes } from '../../../lib/crimeData';
import { routes, buildRoute } from '../../../config/routes';

const { slug } = Astro.params;

const allTips = await getCollection('tips');
const tip = allTips.find(t => t.slug === slug);

if (!tip || tip.data.status !== 'published') {
  return new Response(null, { status: 404 });
}

Astro.response.headers.set('CDN-Cache-Control', 'max-age=86400');
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, must-revalidate');

// Resolve related crime headlines from story IDs
let relatedCrimes: Awaited<ReturnType<typeof getTrinidadCrimes>> = [];
if (tip.data.related_story_ids.length > 0) {
  const allCrimes = await getTrinidadCrimes();
  relatedCrimes = allCrimes.filter(c => c.storyId && tip.data.related_story_ids.includes(c.storyId));
}

// Related tips: same category or context, max 3, excluding self
const relatedTips = allTips
  .filter(t =>
    t.slug !== slug &&
    t.data.status === 'published' &&
    (t.data.category === tip.data.category || t.data.context === tip.data.context)
  )
  .slice(0, 3);

const { Content } = await tip.render();

const title = `${tip.data.title} | Safety Tips Trinidad — CrimeHotSpots.com`;
const description = `Safety tip for ${tip.data.category} in Trinidad & Tobago. Context: ${tip.data.context}. Actionable advice to keep you safer.`;

const severityBadge: Record<string, string> = {
  high:   'bg-rose-50 dark:bg-rose-950/50 text-rose-700 dark:text-rose-400 border border-rose-200 dark:border-rose-800/60',
  medium: 'bg-amber-50 dark:bg-amber-950/50 text-amber-700 dark:text-amber-400 border border-amber-200 dark:border-amber-800/60',
  low:    'bg-emerald-50 dark:bg-emerald-950/50 text-emerald-700 dark:text-emerald-400 border border-emerald-200 dark:border-emerald-800/60',
};
---

<Layout title={title} description={description} ogType="article">
  <script type="application/ld+json" slot="head" set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'Article',
    headline: tip.data.title,
    datePublished: tip.data.date_added.toISOString(),
    dateModified: (tip.data.date_updated || tip.data.date_added).toISOString(),
    description,
    url: `https://crimehotspots.com${buildRoute.safetyTip(tip.slug)}`,
    publisher: {
      '@type': 'Organization',
      name: 'Crime Hotspots',
      url: 'https://crimehotspots.com',
      logo: { '@type': 'ImageObject', url: 'https://crimehotspots.com/og-image.jpg' }
    }
  })} />

  <Hero
    compact
    narrowContainer={true}
    title={tip.data.title}
    subtitle={`${tip.data.category} · ${tip.data.context}${tip.data.area ? ` · ${tip.data.area}` : ''}`}
  >
    <Breadcrumbs items={[
      { label: 'Home', href: routes.home },
      { label: 'Trinidad & Tobago', href: routes.trinidad.dashboard },
      { label: 'Safety Tips', href: routes.trinidad.safetyTips },
      { label: tip.data.category, href: buildRoute.safetyTipsCategory(tip.data.category) },
      { label: tip.data.title }
    ]} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5">
    <div class="mb-3">
      <a href={routes.trinidad.safetyTips} class="inline-flex items-center gap-1.5 text-caption font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] hover:text-rose-600 dark:hover:text-rose-400 transition">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15 19l-7-7 7-7"/></svg>
        All Safety Tips
      </a>
    </div>

    <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-3xl shadow-md p-6 sm:p-8 border border-slate-100 dark:border-[hsl(0_0%_18%)]">

      <!-- Badges -->
      <div class="flex flex-wrap gap-2 mb-5">
        <a
          href={buildRoute.safetyTipsCategory(tip.data.category)}
          class="px-3 py-1 min-h-[22px] rounded-lg text-caption font-bold bg-rose-50 dark:bg-rose-950/50 text-rose-600 dark:text-rose-400 hover:bg-rose-100 dark:hover:bg-rose-950/70 transition"
        >
          {tip.data.category}
        </a>
        <a
          href={buildRoute.safetyTipsContext(tip.data.context)}
          class="px-3 py-1 min-h-[22px] rounded-lg text-caption font-bold bg-slate-100 dark:bg-[hsl(0_0%_12%)] text-slate-600 dark:text-[hsl(0_0%_65%)] hover:bg-slate-200 dark:hover:bg-[hsl(0_0%_15%)] transition"
        >
          {tip.data.context}
        </a>
        {tip.data.area && (
          <a
            href={buildRoute.safetyTipsArea(tip.data.area.toLowerCase().replace(/\s+/g, '-'))}
            class="px-3 py-1 min-h-[22px] rounded-lg text-caption font-bold bg-slate-100 dark:bg-[hsl(0_0%_12%)] text-slate-500 dark:text-[hsl(0_0%_60%)] hover:bg-slate-200 dark:hover:bg-[hsl(0_0%_15%)] transition"
          >
            {tip.data.area}
          </a>
        )}
        <span class={`px-3 py-1 min-h-[22px] rounded-lg text-caption font-bold ${severityBadge[tip.data.severity]}`}>
          {tip.data.severity.charAt(0).toUpperCase() + tip.data.severity.slice(1)} severity
        </span>
      </div>

      <!-- Tip body -->
      <div class="tip-body text-body text-slate-700 dark:text-[hsl(0_0%_85%)] leading-relaxed mb-5">
        <Content />
      </div>

      <!-- Meta -->
      <p class="text-caption text-slate-400 dark:text-[hsl(0_0%_50%)] mb-5">
        Added {tip.data.date_added.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
        {tip.data.date_updated && ` · Updated ${tip.data.date_updated.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`}
        · Source: {tip.data.source === 'community' ? 'Community (reviewed)' : 'Editorial'}
      </p>

      <!-- Related incidents -->
      {relatedCrimes.length > 0 && (
        <div class="mb-5 pt-5 border-t border-slate-100 dark:border-[hsl(0_0%_16%)]">
          <p class="text-caption font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] uppercase tracking-wider mb-3">
            Related incidents ({relatedCrimes.length})
          </p>
          <ul class="space-y-2">
            {relatedCrimes.map(crime => (
              <li>
                <a href={buildRoute.crime(crime.slug)} class="group flex items-start gap-2">
                  <span class="mt-1.5 flex-shrink-0 w-1.5 h-1.5 rounded-full bg-rose-400"></span>
                  <span>
                    <span class="text-caption font-bold text-slate-700 dark:text-[hsl(0_0%_85%)] group-hover:text-rose-600 dark:group-hover:text-rose-400 transition">{crime.headline}</span>
                    <span class="ml-2 text-caption text-slate-400 dark:text-[hsl(0_0%_50%)]">{crime.area} · {crime.dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</span>
                  </span>
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Share + back -->
      <div class="flex items-center justify-between pt-4 border-t border-slate-100 dark:border-[hsl(0_0%_16%)]">
        <div class="flex items-center gap-4">
          <a href={routes.trinidad.safetyTips} class="text-caption font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] hover:text-rose-600 dark:hover:text-rose-400 transition">
            ← All tips
          </a>
          <a href={routes.trinidad.safetyTipsSubmit} class="text-caption font-bold text-rose-600 dark:text-rose-400 hover:underline transition">
            Submit a tip →
          </a>
        </div>
        <button
          id="shareTipBtn"
          class="px-4 py-1.5 min-h-[22px] rounded-lg border border-slate-300 dark:border-[hsl(0_0%_22%)] text-caption font-bold text-slate-600 dark:text-[hsl(0_0%_65%)] hover:border-rose-500 dark:hover:border-rose-700 hover:text-rose-600 dark:hover:text-rose-400 transition"
        >
          Share
        </button>
      </div>
    </div>

    <!-- Related tips -->
    {relatedTips.length > 0 && (
      <section class="mt-6">
        <p class="text-caption font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] uppercase tracking-wider mb-3">Related tips</p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {relatedTips.map(t => <TipCard tip={t} />)}
        </div>
      </section>
    )}
  </main>
</Layout>

<style is:global>
  .tip-body p { margin-bottom: 1rem; }
  .tip-body p:last-child { margin-bottom: 0; }
  .tip-body strong { font-weight: 700; color: inherit; }
  .tip-body ul {
    list-style: disc;
    padding-left: 1.4rem;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .tip-body li { line-height: 1.6; }
</style>

<script is:inline>
  (function () {
    var btn = document.getElementById('shareTipBtn');
    if (!btn) return;
    btn.addEventListener('click', function () {
      if (navigator.share) {
        navigator.share({ title: document.title, url: window.location.href });
      } else {
        navigator.clipboard.writeText(window.location.href).then(function () {
          btn.textContent = 'Copied!';
          setTimeout(function () { btn.textContent = 'Share'; }, 2000);
        });
      }
    });
  })();
</script>
