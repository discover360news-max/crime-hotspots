---
export const prerender = true;

import { getCollection } from 'astro:content';
import Layout from '../../../../layouts/Layout.astro';
import Hero from '../../../../components/Hero.astro';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import TipCard from '../../../../components/TipCard.astro';
import { routes, buildRoute } from '../../../../config/routes';

export async function getStaticPaths() {
  const MIN_TIPS = 3;
  const allTips = await getCollection('tips', ({ data }) =>
    data.status === 'published' && !!data.area.trim()
  );
  const areaCounts: Record<string, { area: string; count: number }> = {};
  allTips.forEach(t => {
    const slug = t.data.area.trim().toLowerCase().replace(/\s+/g, '-');
    if (!areaCounts[slug]) areaCounts[slug] = { area: t.data.area.trim(), count: 0 };
    areaCounts[slug].count++;
  });
  return Object.entries(areaCounts)
    .filter(([, v]) => v.count >= MIN_TIPS)
    .map(([slug, v]) => ({ params: { area: slug }, props: { areaName: v.area } }));
}

const { area } = Astro.params;
const { areaName } = Astro.props as { areaName: string };

const tips = await getCollection('tips', ({ data }) =>
  data.status === 'published' &&
  data.area.trim().toLowerCase().replace(/\s+/g, '-') === area
);
tips.sort((a, b) => b.data.date_added.getTime() - a.data.date_added.getTime());
---

<Layout
  title={`Safety Tips for ${areaName}, Trinidad — CrimeHotSpots.com`}
  description={`${tips.length} crime safety tip${tips.length !== 1 ? 's' : ''} specific to ${areaName}, Trinidad & Tobago.`}
>
  <Hero
    compact
    narrowContainer={true}
    title={`Safety Tips: ${areaName}`}
    subtitle={`${tips.length} tip${tips.length !== 1 ? 's' : ''} specific to ${areaName}.`}
  >
    <Breadcrumbs items={[
      { label: 'Home', href: routes.home },
      { label: 'Trinidad & Tobago', href: routes.trinidad.dashboard },
      { label: 'Safety Tips', href: routes.trinidad.safetyTips },
      { label: areaName }
    ]} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5" data-pagefind-body>
    <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-lg shadow-sm p-4 sm:p-6 border border-slate-100 dark:border-[hsl(0_0%_18%)]">

      <div class="flex items-center justify-between mb-4">
        <p class="text-caption text-slate-500 dark:text-[hsl(0_0%_55%)]">
          {tips.length} tip{tips.length !== 1 ? 's' : ''} · <a href={buildRoute.area(area)} class="font-bold text-rose-600 dark:text-rose-400 hover:underline">View {areaName} crime profile →</a>
        </p>
        <a href={routes.trinidad.safetyTips} class="text-caption font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] hover:text-rose-600 dark:hover:text-rose-400 transition">
          All tips
        </a>
      </div>

      {tips.length === 0 ? (
        <p class="py-10 text-center text-body text-slate-500 dark:text-[hsl(0_0%_55%)]">No tips for this area yet.</p>
      ) : (
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {tips.map(tip => <TipCard tip={tip} />)}
        </div>
      )}
    </div>
  </main>
</Layout>
