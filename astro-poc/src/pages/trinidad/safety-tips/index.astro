---
export const prerender = true;

import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';
import Hero from '../../../components/Hero.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import TipCard from '../../../components/TipCard.astro';
import CategoryAccordion from '../../../components/CategoryAccordion.astro';
import { routes, buildRoute } from '../../../config/routes';
import { slugifyCategory } from '../../../lib/safetyTipsHelpers';

const allTips = await getCollection('tips', ({ data }) => data.status === 'published');

// Group by category, sort each group high→medium→low then newest first
const severityOrder: Record<string, number> = { high: 0, medium: 1, low: 2 };

const byCategory: Record<string, typeof allTips> = {};
allTips.forEach(tip => {
  const cat = tip.data.category;
  if (!byCategory[cat]) byCategory[cat] = [];
  byCategory[cat].push(tip);
});

Object.values(byCategory).forEach(tips => {
  tips.sort((a, b) => {
    const sev = severityOrder[a.data.severity] - severityOrder[b.data.severity];
    if (sev !== 0) return sev;
    return b.data.date_added.getTime() - a.data.date_added.getTime();
  });
});

// Categories sorted by tip count descending
const sortedCategories = Object.entries(byCategory).sort((a, b) => b[1].length - a[1].length);
---

<Layout
  title="Crime Safety Tips Trinidad & Tobago — CrimeHotSpots.com"
  description="Actionable crime safety tips for Trinidad & Tobago residents. Curated from real incident patterns to help you protect yourself from robbery, carjacking, home invasion and more."
>
  <Hero
    compact
    narrowContainer={true}
    title="Crime Safety Tips"
    subtitle="Practical, actionable advice curated from real crime incidents in Trinidad & Tobago."
    primaryCTA={{ text: 'Submit a Tip', href: routes.trinidad.safetyTipsSubmit }}
  >
    <Breadcrumbs items={[
      { label: 'Home', href: routes.home },
      { label: 'Trinidad & Tobago', href: routes.trinidad.dashboard },
      { label: 'Safety Tips' }
    ]} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5" data-pagefind-body>

    {allTips.length === 0 ? (
      <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-lg shadow-sm p-8 border border-slate-100 dark:border-[hsl(0_0%_18%)] text-center">
        <p class="text-body text-slate-500 dark:text-[hsl(0_0%_55%)]">No safety tips published yet — check back soon.</p>
        <a href={routes.trinidad.safetyTipsSubmit} class="mt-3 inline-block text-caption font-bold text-rose-600 dark:text-rose-400 hover:underline">
          Submit the first tip
        </a>
      </div>
    ) : (
      sortedCategories.map(([category, tips], i) => (
        <CategoryAccordion
          category={category}
          count={tips.length}
          categoryHref={buildRoute.safetyTipsCategory(slugifyCategory(category))}
          isExpanded={i === 0}
        >
          {tips.map(tip => <TipCard tip={tip} />)}
        </CategoryAccordion>
      ))
    )}

  </main>
</Layout>
