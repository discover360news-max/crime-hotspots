---
/**
 * Individual Crime Page — Full SSR with Cloudflare CDN caching
 * All crime pages are server-rendered on request, then cached at Cloudflare's edge for 24h.
 * This ensures ALL crime pages (new and old) are accessible and indexed by Google.
 * URL: /trinidad/crime/murder-port-of-spain-2025-12-10
 */

import Layout from '../../../layouts/Layout.astro';
import { getTrinidadCrimes, type Crime } from '../../../lib/crimeData';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import ReportIssueModal from '../../../components/ReportIssueModal.astro';
import SiteNotificationBanner from '../../../components/SiteNotificationBanner.astro';
import AreaNameTooltip from '../../../components/AreaNameTooltip.astro';
import SafetyContext from '../../../components/SafetyContext.astro';
import FeedbackToggle from '../../../components/FeedbackToggle.astro';
import RelatedCrimes from '../../../components/RelatedCrimes.astro';
import { dataUpdateNotice } from '../../../config/siteNotifications';
import { loadAreaAliases, getLocalName } from '../../../lib/areaAliases';
import { getCountryName } from '../../../data/countries';
import { getSafetyContext } from '../../../lib/safetyHelpers';
import { routes, buildRoute } from '../../../config/routes';

// Fetch all crimes once per request (used for slug lookup, navigation, and safety context)
const { slug } = Astro.params;
const allCrimes = await getTrinidadCrimes();
const crime = allCrimes.find(c => c.slug === slug);

// Return proper 404 for unknown slugs
if (!crime) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Sort for prev/next navigation
const sortedCrimes = [...allCrimes].sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());
const crimeIndex = sortedCrimes.findIndex(c => c.slug === slug);
const prevCrime = crimeIndex > 0 ? sortedCrimes[crimeIndex - 1] : null;
const nextCrime = crimeIndex < sortedCrimes.length - 1 ? sortedCrimes[crimeIndex + 1] : null;

// Load area aliases for tooltip
const areaAliases = await loadAreaAliases();
const localName = getLocalName(areaAliases, crime.area);

// Calculate safety context for this area (reuses allCrimes — no duplicate fetch)
const safetyContext = getSafetyContext(crime.area, allCrimes);

// CDN cache: Cloudflare caches SSR response for 24h, browser caches for 1h
Astro.response.headers.set('CDN-Cache-Control', 'max-age=86400');
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, must-revalidate');

// Truncate headline for breadcrumbs (first 3-5 words)
const truncatedHeadline = crime.headline.split(' ').slice(0, 5).join(' ') + (crime.headline.split(' ').length > 5 ? '...' : '');

// Format month name for breadcrumbs
const monthName = crime.dateObj.toLocaleDateString('en-US', { month: 'long' });

// SEO Meta Tags
const title = `${crime.headline} | Crime Hotspots Trinidad`;
const description = crime.summary || `${crime.crimeType} in ${crime.area} on ${crime.date}. View details, location, and related crimes.`;
---

<Layout title={title} description={description} includeTurnstile={true}>
  <!-- Schema.org NewsArticle Markup -->
  <script type="application/ld+json" slot="head">
    {
      JSON.stringify({
        "@context": "https://schema.org",
        "@type": "NewsArticle",
        "headline": crime.headline,
        "datePublished": crime.dateObj.toISOString(),
        "articleSection": crime.crimeType,
        "locationCreated": {
          "@type": "Place",
          "name": crime.area,
          "address": {
            "@type": "PostalAddress",
            "addressRegion": crime.region,
            "addressCountry": "TT"
          }
        },
        "description": crime.summary,
        "url": buildRoute.crimeAbsolute(crime.slug),
        "publisher": {
          "@type": "Organization",
          "name": "Crime Hotspots",
          "url": "https://crimehotspots.com"
        }
      })
    }
  </script>

  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumbs -->
    <Breadcrumbs items={[
      { label: 'Home', href: routes.home },
      { label: getCountryName('tt'), href: routes.trinidad.dashboard },
      { label: 'Archive', href: routes.trinidad.archive },
      { label: String(crime.year), href: buildRoute.archive(crime.year) },
      { label: monthName, href: buildRoute.archive(crime.year, String(crime.month).padStart(2, '0')) },
      { label: truncatedHeadline }
    ]} />

    <!-- Navigation Buttons with Share -->
    <div class="flex items-center justify-between gap-4 mb-6 flex-wrap">
      <!-- Left: Navigation Buttons -->
      <div class="flex gap-2">
        <a
          href={routes.trinidad.dashboard}
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs whitespace-nowrap"
        >
          Dashboard
        </a>
        <a
          href={routes.trinidad.headlines}
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs whitespace-nowrap"
        >
          Headlines
        </a>
      </div>

      <!-- Right: Share Section -->
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500 hidden sm:inline">Share:</span>
        <button id="shareTwitterBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 active:bg-slate-100 transition" title="Share on X (Twitter)" aria-label="Share on X (Twitter)">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
          </svg>
        </button>
        <button id="shareFacebookBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 active:bg-slate-100 transition" title="Share on Facebook" aria-label="Share on Facebook">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </button>
        <button id="shareWhatsAppBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 active:bg-slate-100 transition" title="Share on WhatsApp" aria-label="Share on WhatsApp">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Site Notification Banner -->
    <SiteNotificationBanner notification={dataUpdateNotice} />

    <article class="bg-white/70 rounded-lg shadow-sm border border-slate-200 p-6 sm:p-8">
      <!-- Two-column layout: Desktop only, stack on mobile -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- LEFT COLUMN: Crime Metadata (Row 1, Col 1) -->
        <div>
          <header>
            <h1 class="text-h1 font-bold text-slate-700 mb-4">{crime.headline}</h1>

            <!-- Date + Crime Type Badges -->
            <div class="flex flex-wrap items-center gap-3 text-xs mb-4">
              <time datetime={crime.dateObj.toISOString()} class="text-slate-500">
                {crime.dateObj.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
              </time>

              <!-- Primary Crime Type -->
              <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white font-medium" data-pagefind-ignore>
                {crime.crimeType}
              </span>

              <!-- Related Crime Types (2026+) -->
              {crime.relatedCrimeTypes && crime.relatedCrimeTypes.trim() && (
                <>
                  {crime.relatedCrimeTypes.split(',').map((relatedCrime) => (
                    <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-slate-300 text-slate-700 font-medium" data-pagefind-ignore>
                      {relatedCrime.trim()}
                    </span>
                  ))}
                </>
              )}
            </div>

            <!-- Location -->
            <div class="text-xs text-slate-700 mb-4" data-pagefind-ignore>
              <span class="font-semibold text-slate-500">Location: </span>
              {crime.street ? `${crime.street}, ` : ''}<AreaNameTooltip area={crime.area} localName={localName} />
            </div>

            <!-- Region & Source Details -->
            <dl class="space-y-2 text-xs mb-6" data-pagefind-ignore>
              <div>
                <dt class="inline font-semibold text-slate-500">Region: </dt>
                <dd class="inline text-slate-700">{crime.region}</dd>
              </div>

              {crime.source && (
                <div>
                  <dt class="inline font-semibold text-slate-500">Source: </dt>
                  <dd class="inline text-slate-700">
                    {crime.url ? (
                      <a
                        href={crime.url}
                        target="_blank"
                        rel="noopener"
                        class="text-rose-600 hover:text-rose-700 border-b border-dotted border-rose-600 hover:border-rose-700"
                      >
                        {crime.source}
                      </a>
                    ) : (
                      crime.source
                    )}
                  </dd>
                </div>
              )}
            </dl>
          </header>

          <!-- Related Crimes (desktop: in left column) -->
          <div class="hidden lg:block mt-6">
            <RelatedCrimes currentCrime={crime} allCrimes={allCrimes} maxCards={5} />
          </div>
        </div>

        <!-- RIGHT COLUMN: Summary & Report Issue (Row 1, Col 2) -->
        <div class="space-y-6">
          {crime.summary && (
            <div>
              <p class="text-body text-slate-700 leading-relaxed whitespace-pre-line">{crime.summary.replace(/\|\|/g, '\n\n')}</p>
            </div>
          )}

          <!-- Report Issue Section -->
          <div class="p-4 bg-white/70 rounded-lg border border-slate-200" data-pagefind-ignore>
            <div class="mb-3">
              <p class="text-sm font-semibold text-slate-700">Found incorrect information?</p>
              <p class="text-xs text-slate-500 mt-1">Help us keep our data accurate by reporting issues.</p>
            </div>
            <ReportIssueModal
              showButton={true}
              crimeSlug={crime.slug}
              crimeHeadline={crime.headline}
              crimeDate={crime.date}
              crimeType={crime.crimeType}
              crimeArea={crime.area}
              crimeRegion={crime.region}
              crimeStreet={crime.street}
              crimeSummary={crime.summary}
              crimeSource={crime.source}
              crimeUrl={crime.url}
            />
          </div>
        </div>

        <!-- Related Crimes (mobile only - shown after summary) -->
        <div class="lg:hidden">
          <RelatedCrimes currentCrime={crime} allCrimes={allCrimes} maxCards={4} />
        </div>
      </div>
    </article>

    <!-- Safety Context for Area -->
    <SafetyContext
      areaName={crime.area}
      score={safetyContext.score}
      level={safetyContext.level}
      tip={safetyContext.tip}
      positiveNote={safetyContext.positiveNote}
      primaryCrimeType={safetyContext.primaryCrimeType}
    />

    <FeedbackToggle
      areaName={crime.area}
      pageUrl={`https://crimehotspots.com/trinidad/crime/${crime.slug}`}
      pageTitle={crime.headline}
    />

    <!-- Previous/Next Crime Navigation -->
    {(prevCrime || nextCrime) && (
      <nav class="mt-6 grid grid-cols-2 gap-4" aria-label="Crime navigation">
        <!-- Previous Crime (Newer) -->
        <div class="text-left">
          {prevCrime && (
            <a
              href={`/trinidad/crime/${prevCrime.slug}/`}
              class="block p-4 bg-white/70 rounded-lg shadow-sm border border-slate-200 hover:border-rose-600 active:bg-rose-50 transition group"
            >
              <div class="text-xs text-slate-500 mb-1">← Previous Crime</div>
              <div class="text-sm font-medium text-slate-700 group-hover:text-rose-600 transition line-clamp-2">
                {prevCrime.headline}
              </div>
              <div class="text-xs text-slate-500 mt-1">
                {prevCrime.dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>
            </a>
          )}
        </div>

        <!-- Next Crime (Older) -->
        <div class="text-right">
          {nextCrime && (
            <a
              href={`/trinidad/crime/${nextCrime.slug}/`}
              class="block p-4 bg-white/70 rounded-lg shadow-sm border border-slate-200 hover:border-rose-600 active:bg-rose-50 transition group"
            >
              <div class="text-xs text-slate-500 mb-1">Next Crime →</div>
              <div class="text-sm font-medium text-slate-700 group-hover:text-rose-600 transition line-clamp-2">
                {nextCrime.headline}
              </div>
              <div class="text-xs text-slate-500 mt-1">
                {nextCrime.dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>
            </a>
          )}
        </div>
      </nav>
    )}
  </div>
</Layout>

<script define:vars={{ crimeHeadline: crime.headline, crimeSlug: crime.slug }}>
  // Share button functionality
  const shareTwitterBtn = document.getElementById('shareTwitterBtn');
  const shareFacebookBtn = document.getElementById('shareFacebookBtn');
  const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');

  const pageUrl = `https://crimehotspots.com/trinidad/crime/${crimeSlug}`;

  if (shareTwitterBtn) {
    shareTwitterBtn.addEventListener('click', () => {
      const text = encodeURIComponent(crimeHeadline);
      const url = encodeURIComponent(pageUrl);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
    });
  }

  if (shareFacebookBtn) {
    shareFacebookBtn.addEventListener('click', () => {
      const url = encodeURIComponent(pageUrl);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=420');
    });
  }

  if (shareWhatsAppBtn) {
    shareWhatsAppBtn.addEventListener('click', () => {
      const text = encodeURIComponent(`${crimeHeadline} - ${pageUrl}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    });
  }
</script>
