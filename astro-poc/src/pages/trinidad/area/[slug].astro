---
/**
 * Area Detail Page
 * Individual area crime statistics with risk level, headlines, and breakdown
 * Pre-renders only areas with crime data; SSR fallback for zero-crime areas
 *
 * Target keywords: "crime in {area}", "{area} crime statistics", "is {area} safe"
 */

export const prerender = true;

import Layout from '../../../layouts/Layout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import Hero from '../../../components/Hero.astro';
import StatCards from '../../../components/StatCards.astro';
import DataTable from '../../../components/DataTable.astro';
import SafetyContext from '../../../components/SafetyContext.astro';
import FeedbackToggle from '../../../components/FeedbackToggle.astro';
import NewsletterSignup from '../../../components/NewsletterSignup.astro';
import AreaNarrative from '../../../components/AreaNarrative.astro';
import { getTrinidadCrimes, generateNameSlug } from '../../../lib/crimeData';
import { loadFullAreaData } from '../../../lib/areaAliases';
import { getSafetyContext } from '../../../lib/safetyHelpers';
import { countCrimeType } from '../../../lib/dashboardHelpers';
import {
  TRACKED_CRIME_TYPES,
  calculatePercentChange,
  filterToSamePeriod,
} from '../../../lib/statisticsHelpers';
import { escapeHtml } from '../../../lib/escapeHtml';
import { routes, buildRoute } from '../../../config/routes';

// Pre-render only areas that have crime data
export async function getStaticPaths() {
  const allCrimes = await getTrinidadCrimes();
  const areaData = await loadFullAreaData();

  // Get areas with at least 1 crime
  const areasWithCrimes = new Set(allCrimes.map(c => c.area).filter(a => a));

  return areaData
    .filter(a => areasWithCrimes.has(a.area))
    .map(a => ({
      params: { slug: generateNameSlug(a.area) },
      props: {
        areaName: a.area,
        region: a.region,
        division: a.division,
        knownAs: a.knownAs,
      },
    }));
}

const { slug } = Astro.params;
const { areaName, region, division, knownAs } = Astro.props;

// Fetch all crimes
const allCrimes = await getTrinidadCrimes();
const areaData = await loadFullAreaData();

// Area crimes
const areaCrimes = allCrimes.filter(c => c.area === areaName);

// Date ranges
const currentYear = new Date().getFullYear();
const previousYear = currentYear - 1;
const cutoff90d = new Date();
cutoff90d.setDate(cutoff90d.getDate() - 90);
const cutoff30d = new Date();
cutoff30d.setDate(cutoff30d.getDate() - 30);

const recentCrimes90d = areaCrimes.filter(c => c.dateObj >= cutoff90d);
const recentCrimes30d = areaCrimes.filter(c => c.dateObj >= cutoff30d);

// 7-day and 14-day windows for AreaNarrative week-over-week
const cutoff7d = new Date();
cutoff7d.setDate(cutoff7d.getDate() - 7);
const cutoff14d = new Date();
cutoff14d.setDate(cutoff14d.getDate() - 14);
const thisWeekCrimes = areaCrimes.filter(c => c.dateObj >= cutoff7d);
const lastWeekCrimes = areaCrimes.filter(c => c.dateObj >= cutoff14d && c.dateObj < cutoff7d);

// Same 90-day window last year (for YoY comparison of the incidents card)
const cutoff90dPrevStart = new Date(cutoff90d);
cutoff90dPrevStart.setFullYear(cutoff90dPrevStart.getFullYear() - 1);
const cutoff90dPrevEnd = new Date();
cutoff90dPrevEnd.setFullYear(cutoff90dPrevEnd.getFullYear() - 1);
const recentCrimes90dPrev = areaCrimes.filter(c => c.dateObj >= cutoff90dPrevStart && c.dateObj <= cutoff90dPrevEnd);
const crimesCurrent = areaCrimes.filter(c => c.year === currentYear);
const crimesPrevious = areaCrimes.filter(c => c.year === previousYear);

// YTD comparison using same-period filter
const crimesCurrentYTD = filterToSamePeriod(crimesCurrent, currentYear);
const crimesPreviousYTD = filterToSamePeriod(crimesPrevious, previousYear);

// Safety context
const safety = getSafetyContext(areaName, allCrimes);

// Crime type breakdown for area
const crimeTypeBreakdown = TRACKED_CRIME_TYPES.map(type => {
  const currentCount = countCrimeType(crimesCurrentYTD, type);
  const previousCount = countCrimeType(crimesPreviousYTD, type);
  const change = calculatePercentChange(previousCount, currentCount);
  return {
    type,
    currentCount,
    previousCount,
    change,
    direction: change > 0.5 ? 'up' : change < -0.5 ? 'down' : 'same',
  };
}).filter(c => c.currentCount > 0 || c.previousCount > 0);

// Helper to build a YoY stat card
function makeYoYCard(label: string, currentCount: number, previousCount: number) {
  const yoyChange = calculatePercentChange(previousCount, currentCount);
  return {
    label,
    current: currentCount,
    previous: previousCount,
    yoyChange,
    direction: (currentCount > previousCount ? 'up' : currentCount < previousCount ? 'down' : 'flat') as 'up' | 'down' | 'flat',
  };
}

// Primary stat cards (visible)
const statCards = [
  makeYoYCard('Incidents (90d)', recentCrimes90d.length, recentCrimes90dPrev.length),
  { ...makeYoYCard('Murders (YTD)', countCrimeType(crimesCurrentYTD, 'Murder'), countCrimeType(crimesPreviousYTD, 'Murder')), highlight: true },
  makeYoYCard('Robberies (YTD)', countCrimeType(crimesCurrentYTD, 'Robbery'), countCrimeType(crimesPreviousYTD, 'Robbery')),
  {
    label: 'Risk Level',
    current: parseFloat(safety.score.toFixed(1)),
    subtitle: 'out of 10',
  },
];

// Extra stat cards for expandable tray (only show types with data)
const extraStatCards = [
  makeYoYCard('Shootings (YTD)', countCrimeType(crimesCurrentYTD, 'Shooting'), countCrimeType(crimesPreviousYTD, 'Shooting')),
  makeYoYCard('Home Invasions (YTD)', countCrimeType(crimesCurrentYTD, 'Home Invasion'), countCrimeType(crimesPreviousYTD, 'Home Invasion')),
  makeYoYCard('Assaults (YTD)', countCrimeType(crimesCurrentYTD, 'Assault'), countCrimeType(crimesPreviousYTD, 'Assault')),
  makeYoYCard('Burglaries (YTD)', countCrimeType(crimesCurrentYTD, 'Burglary'), countCrimeType(crimesPreviousYTD, 'Burglary')),
  makeYoYCard('Thefts (YTD)', countCrimeType(crimesCurrentYTD, 'Theft'), countCrimeType(crimesPreviousYTD, 'Theft')),
  makeYoYCard('Kidnappings (YTD)', countCrimeType(crimesCurrentYTD, 'Kidnapping'), countCrimeType(crimesPreviousYTD, 'Kidnapping')),
  makeYoYCard('Seizures (YTD)', countCrimeType(crimesCurrentYTD, 'Seizures'), countCrimeType(crimesPreviousYTD, 'Seizures')),
].filter(c => c.current > 0 || c.previous > 0);

// Group recent headlines by date for accordion
const headlinesByDate = new Map<string, typeof areaCrimes>();
recentCrimes30d.forEach(crime => {
  const dateKey = crime.dateObj.toLocaleDateString('en-TT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  if (!headlinesByDate.has(dateKey)) headlinesByDate.set(dateKey, []);
  headlinesByDate.get(dateKey)!.push(crime);
});

// Related areas (same region)
const relatedAreas = areaData
  .filter(a => a.region === region && a.area !== areaName)
  .slice(0, 6)
  .map(a => ({
    name: a.area,
    slug: generateNameSlug(a.area),
    knownAs: a.knownAs,
    hasCrimes: allCrimes.some(c => c.area === a.area),
  }));

// Suggested compare area: related area with most recent crime (for contextual compare CTA)
const suggestedCompare = relatedAreas
  .filter(a => a.hasCrimes)
  .map(a => ({
    ...a,
    recentCount: allCrimes.filter(c => c.area === a.name && c.dateObj >= cutoff90d).length,
  }))
  .sort((a, b) => b.recentCount - a.recentCount)[0];

// Random areas from other regions (for cross-linking / internal SEO)
const otherRegionAreas = areaData
  .filter(a => a.region !== region && a.area !== areaName && allCrimes.some(c => c.area === a.area))
  .sort(() => Math.random() - 0.5)
  .slice(0, 3)
  .map(a => ({
    name: a.area,
    slug: generateNameSlug(a.area),
    knownAs: a.knownAs,
    region: a.region,
  }));

// SEO
const subtitle = knownAs && knownAs !== areaName
  ? `${areaName} (${knownAs})`
  : areaName;

const pageTitle = `${areaName} Crime Statistics ${currentYear} - Risk Level ${safety.score.toFixed(1)}/10 | Crime Hotspots`;
const pageDescription = `Crime statistics for ${areaName}, ${region}. Risk Level: ${safety.score.toFixed(1)}/10. ${recentCrimes90d.length} incidents in the last 90 days. Updated daily.`;

// Schema.org
const schemaData = {
  "@context": "https://schema.org",
  "@type": "Place",
  "name": areaName,
  "description": pageDescription,
  "containedInPlace": {
    "@type": "AdministrativeArea",
    "name": region,
  },
  "additionalType": "https://schema.org/Dataset",
  "url": `https://crimehotspots.com/trinidad/area/${slug}/`,
};

const breadcrumbs = [
  { label: 'Home', href: routes.home },
  { label: 'Trinidad & Tobago', href: routes.trinidad.dashboard },
  { label: 'Areas', href: routes.trinidad.areas },
  { label: areaName },
];
---

<Layout title={pageTitle} description={pageDescription}>
  <script type="application/ld+json" set:html={JSON.stringify(schemaData)} />

  <Hero
    compact
    narrowContainer={true}
    title={subtitle}
    subtitle={`${region} Region • ${division} Division • ${areaCrimes.length} total recorded incidents`}
    badge="Updated daily"
    riskBadge={{
      level: safety.level,
      label: safety.level === 'high' ? `High Risk · ${safety.score.toFixed(1)}/10` : safety.level === 'low' ? `Low Risk · ${safety.score.toFixed(1)}/10` : `Stable · ${safety.score.toFixed(1)}/10`,
    }}
    primaryCTA={{ text: 'View Dashboard', href: routes.trinidad.dashboard, icon: 'dashboard' }}
    secondaryCTA={{ text: 'Compare Area', href: `${routes.trinidad.compare}?a=${slug}`, icon: 'arrow' }}
  >
    <Breadcrumbs items={breadcrumbs} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5" data-pagefind-body>

    <!-- Share Buttons -->
    <div class="flex items-center gap-2 mt-4">
      <span class="text-xs text-slate-500 dark:text-[hsl(0_0%_50%)]">Share:</span>
      <button id="area-shareTwitterBtn" class="p-2 rounded-lg border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-600 dark:text-[hsl(0_0%_55%)] hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] active:bg-slate-100 dark:active:bg-[hsl(0_0%_15%)] transition" title="Share on X (Twitter)" aria-label="Share on X (Twitter)">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
        </svg>
      </button>
      <button id="area-shareFacebookBtn" class="p-2 rounded-lg border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-600 dark:text-[hsl(0_0%_55%)] hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] active:bg-slate-100 dark:active:bg-[hsl(0_0%_15%)] transition" title="Share on Facebook" aria-label="Share on Facebook">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
        </svg>
      </button>
      <button id="area-shareWhatsAppBtn" class="p-2 rounded-lg border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-600 dark:text-[hsl(0_0%_55%)] hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] active:bg-slate-100 dark:active:bg-[hsl(0_0%_15%)] transition" title="Share on WhatsApp" aria-label="Share on WhatsApp">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
        </svg>
      </button>
    </div>

    <!-- Area Narrative — "This Week in [Area]" -->
    <AreaNarrative
      areaName={areaName}
      areaSlug={slug!}
      thisWeekCount={thisWeekCrimes.length}
      lastWeekCount={lastWeekCrimes.length}
      primaryCrimeType={safety.primaryCrimeType || 'General Crime'}
      total90d={recentCrimes90d.length}
      compareUrl={`${routes.trinidad.compare}?a=${slug}`}
    />

    <!-- Stat Cards -->
    <div class="mt-6">
      <StatCards stats={statCards} />

      {extraStatCards.length > 0 && (
        <div class="mt-2">
          <button
            id="moreStatsToggle"
            class="w-full flex items-center justify-center gap-1 py-2 text-xs font-medium text-slate-400 dark:text-[hsl(0_0%_50%)] hover:text-rose-600 transition cursor-pointer"
          >
            <span id="moreStatsLabel">More stats</span>
            <svg id="moreStatsChevron" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div id="moreStatsContent" class="more-stats-content mt-2">
            <StatCards stats={extraStatCards} />
          </div>
        </div>
      )}
    </div>

    <!-- Safety Context -->
    <SafetyContext
      areaName={areaName}
      score={safety.score}
      level={safety.level}
      tip={safety.tip}
      positiveNote={safety.positiveNote}
      primaryCrimeType={safety.primaryCrimeType}
    />

    <!-- Contextual Compare Prompt -->
    {suggestedCompare && (
      <a
        href={`${routes.trinidad.compare}?a=${slug}&b=${suggestedCompare.slug}`}
        class="block mt-4 p-3 rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] bg-white/70 dark:bg-[hsl(0_0%_5%)] hover:border-rose-300 dark:hover:border-rose-900/40 transition group"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600 dark:text-[hsl(0_0%_80%)]">
              See how <span class="text-slate-700 dark:text-[hsl(0_0%_90%)] font-bold">{areaName}</span> compares
              to <span class="text-slate-700 dark:text-[hsl(0_0%_90%)] font-bold">{suggestedCompare.name}</span>
            </p>
            <p class="text-xs text-slate-400 dark:text-[hsl(0_0%_50%)] mt-0.5">
              Side-by-side safety scores and crime breakdown
            </p>
          </div>
          <svg class="w-5 h-5 text-slate-400 dark:text-[hsl(0_0%_50%)] group-hover:text-rose-600 transition shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </a>
    )}

    <!-- Feedback + Email Signup -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-4 mb-6 items-start">
      <div class="sm:col-span-1">
        <FeedbackToggle
          areaName={areaName}
          pageUrl={`https://crimehotspots.com/trinidad/area/${slug}/`}
          pageTitle={`Crime Statistics for ${areaName}, Trinidad`}
        />
      </div>
      <div class="sm:col-span-2">
        <NewsletterSignup areaName={areaName} source="area-page" />
      </div>
    </div>

    <!-- Crime Type Breakdown -->
    {crimeTypeBreakdown.length > 0 && (
      <section class="mt-6">
        <h2 class="text-lg font-bold text-slate-800 dark:text-[hsl(0_0%_90%)] mb-4">Crime Breakdown (Year-to-Date)</h2>
        <DataTable headers={['Crime Type', String(currentYear), String(previousYear), 'Change']}>
          {crimeTypeBreakdown.map(row => (
            <tr class="hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_10%)]">
              <td class="px-4 py-3 text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_90%)]">{row.type}</td>
              <td class="px-4 py-3 text-sm text-right text-slate-700 dark:text-[hsl(0_0%_90%)]">{row.currentCount}</td>
              <td class="px-4 py-3 text-sm text-right text-slate-500 dark:text-[hsl(0_0%_55%)]">{row.previousCount}</td>
              <td class={`px-4 py-3 text-sm text-right font-medium ${
                row.direction === 'up' ? 'text-rose-600' :
                row.direction === 'down' ? 'text-emerald-600' :
                'text-slate-400'
              }`}>
                {row.direction === 'up' ? '↑' : row.direction === 'down' ? '↓' : '→'}
                {Math.abs(row.change).toFixed(1)}%
              </td>
            </tr>
          ))}
        </DataTable>
      </section>
    )}

    <!-- Recent Headlines (Last 30 Days) -->
    {recentCrimes30d.length > 0 && (
      <section class="mt-8">
        <h2 class="text-lg font-bold text-slate-800 dark:text-[hsl(0_0%_90%)] mb-4">
          Recent Headlines
          <span class="text-sm font-normal text-slate-500 dark:text-[hsl(0_0%_55%)] ml-2">Last 30 days</span>
        </h2>

        <div class="space-y-2">
          {Array.from(headlinesByDate.entries()).map(([dateStr, crimes]) => (
            <div class="bg-white dark:bg-[hsl(0_0%_8%)] rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] overflow-hidden">
              <!-- Accordion Header -->
              <button
                class="accordion-toggle w-full flex items-center justify-between px-4 py-3 hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_10%)] transition cursor-pointer"
                aria-expanded="false"
              >
                <div class="flex items-center gap-2">
                  <svg class="accordion-chevron w-4 h-4 text-slate-400 dark:text-[hsl(0_0%_50%)] transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                  <span class="text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_90%)]">{dateStr}</span>
                </div>
                <span class="text-xs text-slate-400 dark:text-[hsl(0_0%_50%)]">{crimes.length} incident{crimes.length !== 1 ? 's' : ''}</span>
              </button>

              <!-- Accordion Content -->
              <div class="accordion-content">
                <div class="border-t border-slate-100 dark:border-[hsl(0_0%_15%)] px-4 py-3 space-y-3">
                  {crimes.map(crime => (
                    <a
                      href={buildRoute.crime(crime.slug)}
                      data-crime-slug={crime.slug}
                      class="crime-card-link block p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] transition group"
                    >
                      <div class="text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_90%)] group-hover:text-rose-600 transition">
                        {escapeHtml(crime.headline)}
                      </div>
                      <div class="flex items-center gap-2 mt-1 text-xs text-slate-400 dark:text-[hsl(0_0%_50%)]">
                        <span class="px-1.5 py-0.5 rounded bg-slate-100 dark:bg-[hsl(0_0%_12%)] text-slate-500 dark:text-[hsl(0_0%_55%)]">{crime.primaryCrimeType || crime.crimeType}</span>
                        {crime.street && <span>{escapeHtml(crime.street)}</span>}
                      </div>
                    </a>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      </section>
    )}

    {recentCrimes30d.length === 0 && (
      <section class="mt-8">
        <div class="bg-slate-50 dark:bg-[hsl(0_0%_8%)] rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] p-6 text-center">
          <p class="text-sm text-slate-500 dark:text-[hsl(0_0%_55%)]">No incidents recorded in {areaName} in the last 30 days.</p>
        </div>
      </section>
    )}

    <!-- Related Areas -->
    {(relatedAreas.length > 0 || otherRegionAreas.length > 0) && (
      <div class="mt-8 bg-slate-50 dark:bg-[hsl(0_0%_5%)] rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] p-5 sm:p-6">
        {relatedAreas.length > 0 && (
          <section>
            <h2 class="text-lg font-bold text-slate-800 dark:text-[hsl(0_0%_90%)] mb-4">
              Other Areas in {region}
            </h2>
            <div class="grid grid-cols-2 gap-3">
              {relatedAreas.map(a => (
                <a
                  href={a.hasCrimes ? buildRoute.area(a.slug) : '#'}
                  class={`block px-4 py-3 rounded-lg border text-sm font-medium transition ${
                    a.hasCrimes
                      ? 'bg-white dark:bg-[hsl(0_0%_8%)] border-slate-200 dark:border-[hsl(0_0%_15%)] text-slate-700 dark:text-[hsl(0_0%_90%)] hover:border-rose-300 hover:text-rose-600'
                      : 'bg-white/50 dark:bg-[hsl(0_0%_8%)]/50 border-slate-100 dark:border-[hsl(0_0%_12%)] text-slate-400 dark:text-[hsl(0_0%_40%)] cursor-default'
                  }`}
                >
                  <span>{a.name}</span>
                  {a.knownAs && a.knownAs !== a.name && (
                    <span class="block text-xs text-slate-400 dark:text-[hsl(0_0%_50%)] mt-0.5">Also known as: {a.knownAs}</span>
                  )}
                </a>
              ))}
            </div>
          </section>
        )}

        {otherRegionAreas.length > 0 && (
          <section class={relatedAreas.length > 0 ? 'mt-6 pt-6 border-t border-slate-200 dark:border-[hsl(0_0%_18%)]' : ''}>
            <h2 class="text-lg font-bold text-slate-800 dark:text-[hsl(0_0%_90%)] mb-4">
              Other Areas in Trinidad
            </h2>
            <div class="grid grid-cols-2 gap-3">
              {otherRegionAreas.map(a => (
                <a
                  href={buildRoute.area(a.slug)}
                  class="block px-4 py-3 rounded-lg border bg-white dark:bg-[hsl(0_0%_8%)] border-slate-200 dark:border-[hsl(0_0%_15%)] text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_90%)] hover:border-rose-300 hover:text-rose-600 transition"
                >
                  <span>{a.name}</span>
                  <span class="block text-xs text-slate-400 dark:text-[hsl(0_0%_50%)] mt-0.5">
                    {a.region}{a.knownAs && a.knownAs !== a.name ? ` • ${a.knownAs}` : ''}
                  </span>
                </a>
              ))}
            </div>
          </section>
        )}
      </div>
    )}
  </main>
</Layout>

<style>
  /* height: auto is animatable because Layout.astro sets html { interpolate-size: allow-keywords } */
  .accordion-content,
  .more-stats-content {
    height: 0;
    overflow: hidden;
    transition: height 300ms ease;
  }
  .accordion-content.is-open,
  .more-stats-content.is-open {
    height: auto;
  }
</style>

{/* Data element — read by module script on every astro:page-load */}
<div id="areaPageData" class="hidden"
  data-slug={slug}
  data-name={subtitle}
  data-safety={safety.score.toFixed(1)}
></div>

<script>
  document.addEventListener('astro:page-load', () => {
    // --- Accordion toggle ---
    document.querySelectorAll('.accordion-toggle').forEach(button => {
      button.addEventListener('click', function() {
        const content = this.nextElementSibling;
        const chevron = this.querySelector('.accordion-chevron');
        const isOpen = this.getAttribute('aria-expanded') === 'true';
        this.setAttribute('aria-expanded', String(!isOpen));
        content.classList.toggle('is-open');
        chevron.style.transform = isOpen ? '' : 'rotate(90deg)';
      });
    });

    // --- More stats toggle ---
    const moreStatsToggle = document.getElementById('moreStatsToggle');
    const moreStatsContent = document.getElementById('moreStatsContent');
    const moreStatsLabel = document.getElementById('moreStatsLabel');
    const moreStatsChevron = document.getElementById('moreStatsChevron');
    if (moreStatsToggle && moreStatsContent && moreStatsLabel && moreStatsChevron) {
      moreStatsToggle.addEventListener('click', () => {
        const isOpen = moreStatsContent.classList.contains('is-open');
        moreStatsContent.classList.toggle('is-open');
        (moreStatsChevron as HTMLElement).style.transform = isOpen ? '' : 'rotate(180deg)';
        moreStatsLabel.textContent = isOpen ? 'More stats' : 'Less stats';
      });
    }

    // --- Share buttons ---
    const dataEl = document.getElementById('areaPageData');
    if (!dataEl) return;
    const slug = dataEl.dataset.slug || '';
    const areaName = dataEl.dataset.name || '';
    const safetyScore = dataEl.dataset.safety || '';

    const pageUrl = `https://crimehotspots.com/trinidad/area/${slug}/`;
    const shareText = `Crime stats for ${areaName}, Trinidad \u2014 Risk Level: ${safetyScore}/10. View details at Crime Hotspots.`;

    document.getElementById('area-shareTwitterBtn')?.addEventListener('click', () => {
      window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(pageUrl)}`, '_blank', 'width=550,height=420');
    });
    document.getElementById('area-shareFacebookBtn')?.addEventListener('click', () => {
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(pageUrl)}`, '_blank', 'width=550,height=420');
    });
    document.getElementById('area-shareWhatsAppBtn')?.addEventListener('click', () => {
      window.open(`https://wa.me/?text=${encodeURIComponent(shareText + ' ' + pageUrl)}`, '_blank');
    });

    // --- Visit tracking ---
    try {
      localStorage.setItem(`crimehotspots_area_visit_${slug}`, String(Date.now()));
    } catch(e) { /* localStorage unavailable */ }
  });
</script>
