---
/**
 * Trinidad & Tobago Crime Dashboard
 * Interactive dashboard with regional SVG map and Leaflet incidents map
 */

import Layout from '../../layouts/Layout.astro';
import { getTrinidadCrimes } from '../../lib/crimeData';
import Breadcrumbs from '../../components/Breadcrumbs.astro';

const crimes = await getTrinidadCrimes();

// Calculate insights
const calculateInsights = (crimeData: typeof crimes) => {
  // Get unique dates and calculate date range
  const dates = crimeData.map(c => new Date(c.date)).filter(d => !isNaN(d.getTime()));
  const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
  const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
  const daysDiff = Math.ceil((maxDate.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

  // Average crimes per day
  const avgPerDay = (crimeData.length / daysDiff).toFixed(1);

  // Most dangerous day of week
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const dayCount = new Map<string, number>();
  dates.forEach(date => {
    const day = dayNames[date.getDay()];
    dayCount.set(day, (dayCount.get(day) || 0) + 1);
  });
  const mostDangerousDay = Array.from(dayCount.entries())
    .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

  // Busiest month
  const monthCount = new Map<string, number>();
  dates.forEach(date => {
    const month = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    monthCount.set(month, (monthCount.get(month) || 0) + 1);
  });
  const busiestMonth = Array.from(monthCount.entries())
    .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

  // Regional stats
  const regionCount = new Map<string, number>();
  crimeData.forEach(crime => {
    const region = crime.region || 'Unknown';
    regionCount.set(region, (regionCount.get(region) || 0) + 1);
  });
  const regionArray = Array.from(regionCount.entries()).sort((a, b) => b[1] - a[1]);

  // Find safest region (exclude "Unknown" and empty values)
  const validRegions = regionArray.filter(([region]) => region && region !== 'Unknown' && region.trim() !== '');
  const safestRegion = validRegions[validRegions.length - 1]?.[0] || 'N/A';
  const safestRegionCount = validRegions[validRegions.length - 1]?.[1] || 0;

  const mostDangerousRegion = regionArray[0]?.[0] || 'N/A';
  const mostDangerousRegionCount = regionArray[0]?.[1] || 0;

  // Top 3 regions concentration
  const top3Count = regionArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
  const top3Percentage = ((top3Count / crimeData.length) * 100).toFixed(0);

  return {
    avgPerDay,
    mostDangerousDay,
    busiestMonth,
    safestRegion,
    safestRegionCount,
    mostDangerousRegion,
    mostDangerousRegionCount,
    top3Percentage,
    dayCount: daysDiff
  };
};

const insights = calculateInsights(crimes);

const title = "Trinidad & Tobago Crime Dashboard â€” Regional Statistics";
const description = "Real-time Trinidad crime statistics on our interactive map. View Port of Spain data and regional safety trends. Check the live dashboard now.";
---

<Layout title={title} description={description}>
  <!-- Background image and SVG styles -->
  <style>
    /* Desktop only: Show faded background image */
    @media (min-width: 768px) {
      body {
        background-image:
          linear-gradient(to bottom,
            rgba(241, 245, 249, 0.7) 0%,
            rgba(241, 245, 249, 0.85) 15%,
            #f1f5f9 30%
          ),
          url('/assets/images/trinidad-page-bg.png');

        background-repeat: no-repeat;
        background-position: top center;
        background-size: 100% auto;
        background-attachment: fixed;
      }
    }

    /* Trinidad SVG Map Styles */
    .region-path {
      fill: #e5e7eb;
      stroke: #9ca3af;
      stroke-width: 2;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .region-path:hover {
      fill: #d1d5db;
      stroke: #6b7280;
      stroke-width: 2.5;
    }
    .region-path.active {
      fill: #e11d48;
      stroke: #be123c;
      stroke-width: 3;
    }
    .region-label {
      fill: #374151;
      font-size: 12px;
      font-weight: 700;
      pointer-events: none;
      text-anchor: middle;
    }

    /* Fix map z-index to stay below header */
    #leafletMap {
      z-index: 1 !important;
      position: relative;
    }
    .leaflet-pane,
    .leaflet-map-pane {
      z-index: 1 !important;
    }
    .leaflet-control-container {
      z-index: 10 !important;
    }

    /* Horizontal scrolling cards */
    .stats-scroll-container {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 1rem;
      scrollbar-width: thin;
      scrollbar-color: #989092ff #f1f5f9;
      padding-bottom: 1rem;
    }
    .stats-scroll-container::-webkit-scrollbar {
      height: 6px;
    }
    .stats-scroll-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }
    .stats-scroll-container::-webkit-scrollbar-thumb {
      background: #e11d48;
      border-radius: 3px;
    }
    .stat-card {
      flex: 0 0 auto;
      min-width: 160px;
      scroll-snap-align: start;
    }
  </style>

  <div class="container mx-auto px-4 py-2 max-w-7xl">
    <!-- Page Header -->
    <div class="pt-4 mb-4">
      <Breadcrumbs items={[
        { label: 'Home', href: '/' },
        { label: 'Trinidad & Tobago ', href: '/dashboard' },
        { label: 'Dashboard' }
      ]} />
      <div class="flex items-start justify-between gap-10 pt-4">
        <div>
          <h1 class="text-2xl font-bold text-slate-700">Trinidad & Tobago</h1>
          <p class="text-xs text-slate-500 mt-1">Crime Statistics Dashboard</p>
        </div>
        <div class="flex-1 items-center gap-2 flex-shrink-0">
          
          <div class="mb-2">
            <a href="/trinidad/headlines"
              class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border-1 border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 transition font-medium text-xs whitespace-nowrap">
              Headlines
            </a>
          </div>

          <button id="filtersBtn"
              class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border-1 border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 transition font-medium text-xs whitespace-nowrap">
              Filters â€º
          </button>
        </div>
      </div>
    </div>

    <!-- Separator -->
    <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent mb-4"></div>

    <!-- Statistics Cards - Horizontal Scroll -->
    <div class="stats-scroll-container mb-4">
      <div class="stat-card bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-sm" id="totalIncidentsCard">
        <div class="text-3xl font-bold text-rose-600" id="totalIncidents">{crimes.length}</div>
        <div class="text-xs text-slate-500">Total Incidents</div>
      </div>

      <div class="stat-card bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-sm">
        <div class="text-3xl font-bold text-rose-600">{crimes.filter(c => c.crimeType === 'Murder').length}</div>
        <div class="text-xs text-slate-500">Murders</div>
      </div>

      <div class="stat-card bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-sm">
        <div class="text-3xl font-bold text-rose-600">{crimes.filter(c => c.crimeType === 'Robbery').length}</div>
        <div class="text-xs text-slate-500">Robberies</div>
      </div>

      <div class="stat-card bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-sm">
        <div class="text-3xl font-bold text-rose-600">{crimes.filter(c => c.crimeType === 'Home Invasion').length}</div>
        <div class="text-xs text-slate-500">Home Invasions</div>
      </div>

      <div class="stat-card bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-sm">
        <div class="text-3xl font-bold text-rose-600">{crimes.filter(c => c.crimeType === 'Theft').length}</div>
        <div class="text-xs text-slate-500">Thefts</div>
      </div>
    </div>

    <!-- Separator -->
        <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent mb-4"></div>

    <!-- Leaflet Map -->
    <div class="mb-6">
      <div class="flex items-center gap-4">
        <h2 class="text-h2 font-bold text-slate-700 pt-4 px-4 mb-4">Crime Incidents Map</h2>
        <div class="relative group cursor-pointer">
          <svg class="w-5 h-5 text-slate-500" cursor-pointer hover:text-slate-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>

          <div class="absolute left-1/2 transform -translate-x-1/2 mt-2 w-64 p-3 bg-white/70 backdrop-blur-md border border-slate-200 rounded-lg shadow-lg text-sm text-slate-500 opacity-0 invisible group-hover:opacity-100 group-hover:visible z-20 transition-all duration-300">
            <p class="font-semibold mb-1">Understanding the Map</p>
            <p class="mb-2">This map shows estimated/reported locations of crimes in and are updated daily.</p>
            <p class="font-semibold mb-1">How to Use:</p>
            <ul class="list-disc list-inside space-y-1 text-sm">
              <li>Click clusters to zoom in</li>
              <li>Click markers for incident details</li>
              <li>Use two fingers to pan map</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="relative">
        <div id="leafletMap" class="w-full h-150 rounded-lg"></div>
        <!-- Pan instruction overlay (shown on single finger touch) -->
      <div id="mapZoomHintTrinidad" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300" style="z-index: 1000;">
        <div class="bg-white/70 backdrop-blur-md rounded-lg px-6 py-4 shadow-xl max-w-xs text-center">
          <p class="text-small font-semibold text-slate-600">Use two fingers to move map</p>
          <p class="text-tiny text-slate-600 mt-1">One finger scrolls the page</p>
        </div>
      </div>
      </div>
    </div>

    <!-- Quick Insights & Top Regions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Quick Insights Card -->
      <div id="quickInsightsCard" class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <h3 class="text-h3 font-bold text-slate-600 mb-4">Quick Insights</h3>
        <div class="space-y-4">
          <!-- Daily Average -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            <div class="flex-1">
              <div class="text-xs text-slate-500 mb-1">Daily Average</div>
              <div id="avgPerDay" class="text-lg font-bold text-slate-600">{insights.avgPerDay} crimes/day</div>
            </div>
          </div>

          <!-- Most Dangerous Day -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <div class="flex-1">
              <div class="text-xs text-slate-500 mb-1">Peak Activity Day</div>
              <div id="mostDangerousDay" class="text-lg font-bold text-slate-600">{insights.mostDangerousDay}</div>
            </div>
          </div>

          <!-- Busiest Month -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <div class="flex-1">
              <div class="text-xs text-slate-500 mb-1">Busiest Month</div>
              <div id="busiestMonth" class="text-lg font-bold text-slate-600">{insights.busiestMonth}</div>
            </div>
          </div>

          <!-- Crime Concentration -->
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-rose-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <div class="flex-1">
              <div class="text-xs text-slate-500 mb-1">Crime Concentration</div>
              <div id="top3Percentage" class="text-lg font-bold text-slate-600">Top 3 regions: {insights.top3Percentage}%</div>
            </div>
          </div>

          <!-- Safety Indicators -->
          <div class="pt-2 border-t border-slate-200">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-xs text-slate-400 mb-1">Most Dangerous</div>
                <div id="mostDangerousRegion" class="text-sm font-semibold text-rose-600">{insights.mostDangerousRegion}</div>
                <div id="mostDangerousRegionCount" class="text-xs text-slate-500">{insights.mostDangerousRegionCount} incidents</div>
              </div>
              <div>
                <div class="text-xs text-slate-400 mb-1">Safest Area</div>
                <div id="safestRegion" class="text-sm font-semibold text-emerald-600">{insights.safestRegion}</div>
                <div id="safestRegionCount" class="text-xs text-slate-500">{insights.safestRegionCount} incidents</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Regions (Keep this) -->
      <div id="topRegionsCard" class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <h3 class="text-h3 font-bold text-slate-700 mb-4">Top Regions</h3>
        <div id="topRegionsContainer" class="space-y-2">
          {Array.from(
            crimes.reduce((acc, crime) => {
              const region = crime.region || 'Unknown';
              acc.set(region, (acc.get(region) || 0) + 1);
              return acc;
            }, new Map())
          )
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(([region, count]) => (
              <div class="flex justify-between items-center pb-2 border-b border-slate-200 last:border-0">
                <span class="text-xs text-slate-500">{region}</span>
                <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white text-xs font-medium">
                  {count}
                </span>
              </div>
            ))}
        </div>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Real-Time Data</h3>
            <p class="text-xs text-slate-400">Dashboard updates daily with the latest crime incidents from verified sources.</p>
          </div>
        </div>
      </div>

      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Regional Filtering</h3>
            <p class="text-xs text-slate-400">Click any region on the map to filter the dashboard and view area-specific crime data.</p>
          </div>
        </div>
      </div>

      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Mobile Optimized</h3>
            <p class="text-xs text-slate-400">Fully responsive dashboard works seamlessly on all devices and screen sizes.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Initialize Map -->
  <script>
    // CSV URLs - MUST match server-side crimeData.ts
    const TRINIDAD_CSV_URLS = {
      '2025': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1749261532&single=true&output=csv',
      // Current sheet (currently 2025, will be 2026 after archival)
      current: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1749261532&single=true&output=csv'
      // Test 2026: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1963637925&single=true&output=csv'
    };

    // Parse CSV line handling quoted commas
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Parse date string (M/D/YYYY format)
    function parseDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        const month = parseInt(parts[0]) - 1;
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
      }
      return new Date(dateStr);
    }

    // Generate slug from headline and date
    function generateSlug(headline, date) {
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const slugText = headline
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .substring(0, 80);
      return `${slugText}-${dateStr}`;
    }

    // Fetch and parse crimes from a CSV URL
    async function fetchCrimesFromURL(url) {
      try {
        const response = await fetch(url);
        const csvText = await response.text();
        const lines = csvText.split('\n');
        const crimes = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          const values = parseCSVLine(line);
          const date = values[0] || '';
          const headline = values[1] || '';
          const crimeType = values[2] || '';
          const street = values[3] || '';
          const area = values[5] || '';
          const region = values[6] || '';
          const url = values[8] || '';
          const source = values[9] || '';
          const latitude = values[10] || '';
          const longitude = values[11] || '';
          const summary = values[12] || '';

          if (!headline || !date) continue;

          const dateObj = parseDate(date);
          if (isNaN(dateObj.getTime())) {
            console.warn(`Skipping entry with invalid date: ${date} - ${headline}`);
            continue;
          }

          const slug = generateSlug(headline, dateObj);

          crimes.push({
            date,
            headline,
            crimeType,
            street,
            area,
            region,
            url,
            source,
            latitude: Number(latitude),
            longitude: Number(longitude),
            summary,
            slug,
            dateObj,
            year: dateObj.getFullYear(),
            month: dateObj.getMonth() + 1,
            day: dateObj.getDate()
          });
        }

        return crimes;
      } catch (error) {
        console.error('Error fetching crimes from URL:', url, error);
        return [];
      }
    }

    // Wait for DOM and load crimes data
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ðŸ” Loading crimes data from CSV...');

      // Fetch crimes, avoiding duplicates if URLs match
      let crimes2025 = [];
      let crimesCurrent = [];

      // Only fetch 2025 sheet if it's different from current sheet
      if (TRINIDAD_CSV_URLS['2025'] && TRINIDAD_CSV_URLS['2025'] !== TRINIDAD_CSV_URLS.current) {
        crimes2025 = await fetchCrimesFromURL(TRINIDAD_CSV_URLS['2025']);
        console.log(`Loaded ${crimes2025.length} crimes from 2025 sheet`);
      }

      // Always fetch current sheet
      crimesCurrent = await fetchCrimesFromURL(TRINIDAD_CSV_URLS.current);
      console.log(`Loaded ${crimesCurrent.length} crimes from current sheet`);

      // Combine all crimes (no deduplication needed - each crime only in one sheet)
      const crimes = [...crimes2025, ...crimesCurrent];
      crimes.sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());

      console.log(`âœ… Total crimes loaded: ${crimes.length}`);

      // Store ALL crimes globally for year filter script
      window.__crimesData = crimes;

      // Calculate current year (highest year)
      const availableYears = [...new Set(crimes.map(c => c.year))].sort((a, b) => b - a);
      const currentYear = availableYears[0];
      console.log(`ðŸŽ¯ Current year detected: ${currentYear}`);

      // Filter to show only current year by default
      const currentYearCrimes = crimes.filter(c => c.year === currentYear);
      console.log(`ðŸ“Š Showing ${currentYearCrimes.length} crimes from ${currentYear} (filtered from ${crimes.length} total)`);

    // Now initialize map with current year crimes only
    (function() {
      const crimes = currentYearCrimes; // Use filtered data for map

      // Load Leaflet scripts
      const leafletScript = document.createElement('script');
      leafletScript.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      leafletScript.onload = () => {
        // Load fullscreen plugin first
        const fullscreenScript = document.createElement('script');
        fullscreenScript.src = 'https://cdn.jsdelivr.net/npm/leaflet.fullscreen@3.0.1/Control.FullScreen.js';
        fullscreenScript.onload = () => {
          // Then load marker cluster
          const clusterScript = document.createElement('script');
          clusterScript.src = 'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js';
          clusterScript.onload = initMap;
          document.head.appendChild(clusterScript);
        };
        document.head.appendChild(fullscreenScript);
      };
      document.head.appendChild(leafletScript); // CRITICAL: Actually load Leaflet!

      function initMap() {
      // Check if map is already initialized
      const mapContainer = document.getElementById('leafletMap');
      if (mapContainer._leaflet_id) {
        console.log('âš ï¸ Map already initialized, skipping');
        return;
      }

      // Initialize map centered on Trinidad
      const map = L.map('leafletMap', {
        dragging: true,
        scrollWheelZoom: false,
        fullscreenControl: true
      }).setView([10.634963, -61.197207],9);

      // *** CRITICAL FIX: Force Leaflet to recalculate size ***
      // This resolves the "map in pieces" or "gray tiles" issue.
      map.invalidateSize();

      // Store map instance globally for year filter access
      window.__leafletMapInstance = map;

      // Two-finger scroll/zoom implementation
      const mapDiv = document.getElementById('leafletMap');
      const hint = document.getElementById('mapZoomHintTrinidad');
      let touchCount = 0;
      let touchStartPos = null;
      let hintTimeout = null;

      mapDiv.addEventListener('touchstart', (e) => {
        touchCount = e.touches.length;
        touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };

        if (touchCount === 2) {
          map.dragging.enable();
          map.scrollWheelZoom.enable();
        } else if (touchCount === 1) {
          map.dragging.disable();
          map.scrollWheelZoom.disable();
        }
      }, { passive: true });

      mapDiv.addEventListener('touchmove', (e) => {
        if (touchCount === 1 && touchStartPos) {
          const distance = Math.sqrt(
            Math.pow(e.touches[0].clientX - touchStartPos.x, 2) +
            Math.pow(e.touches[0].clientY - touchStartPos.y, 2)
          );

          if (distance > 10) {
            hint.style.opacity = '1';
            hint.style.pointerEvents = 'none';

            clearTimeout(hintTimeout);
            hintTimeout = setTimeout(() => {
              hint.style.opacity = '0';
            }, 2000);
          }
        }
      }, { passive: true });

      mapDiv.addEventListener('touchend', () => {
        touchCount = 0;
        map.dragging.enable();
      }, { passive: true });

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 18
      }).addTo(map);

      // Create marker cluster group
      const markers = L.markerClusterGroup({
        chunkedLoading: true,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        maxClusterRadius: 50,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let size = 'small';
          if (count > 50) size = 'large';
          else if (count > 10) size = 'medium';

          return L.divIcon({
            html: `<div class="cluster-${size}">${count}</div>`,
            className: 'custom-cluster-icon',
            iconSize: L.point(40, 40)
          });
        } 
      });

      // Custom marker icons by crime type
      const getCrimeIcon = (crimeType) => {
        const colors = {
          'Murder': '#e11d48',
          'Shooting': '#dc2626',
          'Robbery': '#f97316',
          'Home Invasion': '#9333ea',
          'Theft': '#06b6d4',
          'Kidnapping': '#ec4899',
          'Sexual Assault': '#c026d3',
          'Assault': '#8b5cf6',
          'Seizures': '#3b82f6',
          'Burglary': '#eab308'
        };

        const color = colors[crimeType] || '#64748b';

        return L.divIcon({
          html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
          className: 'custom-crime-marker',
          iconSize: [12, 12],
          iconAnchor: [6, 6],
          popupAnchor: [0, -6]
        });
      };

      // Add crime markers
      crimes.forEach(crime => {
        // 1. Validate that the crime object has valid coordinates
        // We check if crime.latitude and crime.longitude exist and are finite numbers.
        const latitude = Number(crime.latitude);
        const longitude = Number(crime.longitude);

        if (isNaN(latitude) || isNaN(longitude) || !isFinite(latitude) || !isFinite(longitude)) {
            // Optional: Log a message for incidents being skipped due to missing data
            // console.warn(`Skipping crime incident ${crime.slug} due to invalid coordinates: ${crime.latitude}, ${crime.longitude}`);
            return; // Skip this iteration if coordinates are invalid or missing
        }

        // 2. Use the actual coordinates from the crime object with custom icon
        const marker = L.marker([latitude, longitude], {
          icon: getCrimeIcon(crime.crimeType)
        });

        marker.bindPopup(`
          <div class="p-2">
            <div class="text-xs text-slate-500 mb-2">${crime.date}</div>
            <div class="text-xs bg-white/50 text-rose-600 mb-1">${crime.crimeType}</div>
            <div class="text-h3 font-bold text-slate-600 mb-4">${crime.headline}</div>
            <div class="text-xs text-slate-500 mb-1">${crime.street}</div>
            <div class="text-xs text-rose-600">${crime.area}</div>
            <a href="/trinidad/crime/${crime.slug}" class="text-tiny text-rose-600 hover:underline mt-4 inline-block">View Details â†’</a>
          </div>
        `);
        markers.addLayer(marker);
      });

      map.addLayer(markers);

      // Store markers group globally for year filter updates
      window.__leafletMarkersGroup = markers;
      }
    })(); // Invoke the IIFE
  }); // Close DOMContentLoaded
  </script>

  <!-- Year Filtering Script -->
  <script>
    console.log('ðŸš€ Year filter script starting...');

    // Wait for crimes data to be available
    function waitForCrimesData() {
      if (!window.__crimesData) {
        setTimeout(waitForCrimesData, 100);
        return;
      }

      initializeYearFilter(window.__crimesData);
    }

    function initializeYearFilter(crimes) {

    // Validate crimes data
    if (!crimes || !Array.isArray(crimes)) {
      console.error('âŒ Invalid crimes data');
      throw new Error('Crimes data is not an array');
    }

    console.log('ðŸ“… Year filter initialized with', crimes.length, 'crimes');

    // Store original crimes data
    const allCrimes = crimes;

    // Get available years from data
    const availableYears = [...new Set(allCrimes.map(c => new Date(c.date).getFullYear()))].sort((a, b) => b - a);
    console.log('Available years:', availableYears);

    // Default to current year (highest year number)
    const currentYear = availableYears[0];
    console.log('ðŸŽ¯ Defaulting to current year:', currentYear);

    // Filter to show only current year by default
    let filteredCrimes = allCrimes.filter(c => {
      const crimeYear = new Date(c.date).getFullYear();
      return crimeYear === currentYear;
    });
    console.log(`ðŸ“Š Showing ${filteredCrimes.length} crimes from ${currentYear}`);

    // Wait for DOM to be ready before attaching event listeners
    function initYearFilter() {
      console.log('ðŸ”§ Initializing year filter...');

      const yearFilterElement = document.getElementById('yearFilter');
      if (!yearFilterElement) {
        console.error('âŒ Year filter dropdown not found!');
        return;
      }

      console.log('âœ… Year filter dropdown found');

      // Populate dropdown with available years
      yearFilterElement.innerHTML = '';

      // Add current year option (selected by default)
      const currentOption = document.createElement('option');
      currentOption.value = currentYear.toString();
      currentOption.textContent = `${currentYear} Data`;
      currentOption.selected = true;
      yearFilterElement.appendChild(currentOption);

      // Add other years (if any)
      availableYears.forEach(year => {
        if (year !== currentYear) {
          const option = document.createElement('option');
          option.value = year.toString();
          option.textContent = `${year} Data`;
          yearFilterElement.appendChild(option);
        }
      });

      // Add "All Years" option
      const allOption = document.createElement('option');
      allOption.value = 'all';
      allOption.textContent = 'All Years';
      yearFilterElement.appendChild(allOption);

      console.log('âœ… Year filter dropdown populated');

      // Initial update with current year data
      updateStatsCards(filteredCrimes);
      updateQuickInsights(filteredCrimes);
      updateTopRegions(filteredCrimes);
      console.log('âœ… Initial dashboard updated with current year data');

      // Listen for year filter changes
      yearFilterElement.addEventListener('change', (e) => {
        const selectedValue = e.target.value;
        console.log('ðŸ”„ Year filter changed to:', selectedValue);

        // Filter crimes based on selection
        if (selectedValue === 'all') {
          filteredCrimes = allCrimes;
          console.log('Showing all years');
        } else {
          const selectedYears = selectedValue.split(',').map(y => parseInt(y.trim()));
          console.log('Selected years:', selectedYears);

          filteredCrimes = allCrimes.filter(crime => {
            const crimeYear = new Date(crime.date).getFullYear();
            return selectedYears.includes(crimeYear);
          });
        }

        console.log('Filtered to', filteredCrimes.length, 'crimes out of', allCrimes.length, 'total');

        // Update all dashboard components
        updateStatsCards(filteredCrimes);
        updateQuickInsights(filteredCrimes);
        updateTopRegions(filteredCrimes);
        updateLeafletMap(filteredCrimes);
      });

      console.log('âœ… Year filter event listener attached');
    }

  // Update stats cards
  function updateStatsCards(crimes) {
    document.getElementById('totalIncidents').textContent = crimes.length;

    // Update individual crime type cards (if they exist)
    const murders = crimes.filter(c => c.crimeType === 'Murder').length;
    const robberies = crimes.filter(c => c.crimeType === 'Robbery').length;
    const homeInvasions = crimes.filter(c => c.crimeType === 'Home Invasion').length;
    const thefts = crimes.filter(c => c.crimeType === 'Theft').length;

    // Find and update each stat card
    const statCards = document.querySelectorAll('.stat-card');
    const murdersEl = statCards[1]?.querySelector('.text-3xl');
    const robberiesEl = statCards[2]?.querySelector('.text-3xl');
    const homeInvasionsEl = statCards[3]?.querySelector('.text-3xl');
    const theftsEl = statCards[4]?.querySelector('.text-3xl');

    if (murdersEl) murdersEl.textContent = murders;
    if (robberiesEl) robberiesEl.textContent = robberies;
    if (homeInvasionsEl) homeInvasionsEl.textContent = homeInvasions;
    if (theftsEl) theftsEl.textContent = thefts;

    console.log('âœ… Stats cards updated');
  }

  // Update Quick Insights
  function updateQuickInsights(crimes) {
    if (crimes.length === 0) return;

    const dates = crimes.map(c => new Date(c.date)).filter(d => !isNaN(d.getTime()));
    const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
    const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
    const daysDiff = Math.ceil((maxDate.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

    const avgPerDay = (crimes.length / daysDiff).toFixed(1);

    // Most dangerous day
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayCount = new Map();
    dates.forEach(date => {
      const day = dayNames[date.getDay()];
      dayCount.set(day, (dayCount.get(day) || 0) + 1);
    });
    const mostDangerousDay = Array.from(dayCount.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

    // Busiest month
    const monthCount = new Map();
    dates.forEach(date => {
      const month = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      monthCount.set(month, (monthCount.get(month) || 0) + 1);
    });
    const busiestMonth = Array.from(monthCount.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

    // Regional stats
    const regionCount = new Map();
    crimes.forEach(crime => {
      const region = crime.region || 'Unknown';
      regionCount.set(region, (regionCount.get(region) || 0) + 1);
    });
    const regionArray = Array.from(regionCount.entries()).sort((a, b) => b[1] - a[1]);
    const top3Count = regionArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
    const top3Percentage = ((top3Count / crimes.length) * 100).toFixed(0);

    // Find safest region (exclude "Unknown" and empty values)
    const validRegions = regionArray.filter(([region]) => region && region !== 'Unknown' && region.trim() !== '');
    const safestRegion = validRegions[validRegions.length - 1]?.[0] || 'N/A';
    const safestRegionCount = validRegions[validRegions.length - 1]?.[1] || 0;

    const mostDangerousRegion = regionArray[0]?.[0] || 'N/A';
    const mostDangerousRegionCount = regionArray[0]?.[1] || 0;

    // Update DOM using IDs
    const avgPerDayEl = document.getElementById('avgPerDay');
    const mostDangerousDayEl = document.getElementById('mostDangerousDay');
    const busiestMonthEl = document.getElementById('busiestMonth');
    const top3PercentageEl = document.getElementById('top3Percentage');
    const mostDangerousRegionEl = document.getElementById('mostDangerousRegion');
    const mostDangerousRegionCountEl = document.getElementById('mostDangerousRegionCount');
    const safestRegionEl = document.getElementById('safestRegion');
    const safestRegionCountEl = document.getElementById('safestRegionCount');

    if (avgPerDayEl) avgPerDayEl.textContent = `${avgPerDay} crimes/day`;
    if (mostDangerousDayEl) mostDangerousDayEl.textContent = mostDangerousDay;
    if (busiestMonthEl) busiestMonthEl.textContent = busiestMonth;
    if (top3PercentageEl) top3PercentageEl.textContent = `Top 3 regions: ${top3Percentage}%`;
    if (mostDangerousRegionEl) mostDangerousRegionEl.textContent = mostDangerousRegion;
    if (mostDangerousRegionCountEl) mostDangerousRegionCountEl.textContent = `${mostDangerousRegionCount} incidents`;
    if (safestRegionEl) safestRegionEl.textContent = safestRegion;
    if (safestRegionCountEl) safestRegionCountEl.textContent = `${safestRegionCount} incidents`;

    console.log('âœ… Quick Insights updated');
  }

  // Update Top Regions
  function updateTopRegions(crimes) {
    const regionCount = new Map();
    crimes.forEach(crime => {
      const region = crime.region || 'Unknown';
      regionCount.set(region, (regionCount.get(region) || 0) + 1);
    });

    const topRegions = Array.from(regionCount.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    // Update using ID selector
    const container = document.getElementById('topRegionsContainer');
    if (container) {
      container.innerHTML = topRegions.map(([region, count]) => `
        <div class="flex justify-between items-center pb-2 border-b border-slate-200 last:border-0">
          <span class="text-xs text-slate-500">${region}</span>
          <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white text-xs font-medium">
            ${count}
          </span>
        </div>
      `).join('');
    }

    console.log('âœ… Top Regions updated');
  }

  // Update Leaflet Map
  function updateLeafletMap(crimes) {
    // Use global map reference
    const leafletMapInstance = window.__leafletMapInstance;

    if (!leafletMapInstance) {
      console.warn('âš ï¸ Leaflet map not ready yet');
      return;
    }

    // Clear existing markers
    if (window.__leafletMarkersGroup) {
      leafletMapInstance.removeLayer(window.__leafletMarkersGroup);
    }

    // Create new marker cluster group
    const leafletMarkersGroup = window.L.markerClusterGroup({
      chunkedLoading: true,
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,
      zoomToBoundsOnClick: true,
      maxClusterRadius: 50,
      iconCreateFunction: function(cluster) {
        const count = cluster.getChildCount();
        let size = 'small';
        if (count > 50) size = 'large';
        else if (count > 10) size = 'medium';

        return window.L.divIcon({
          html: `<div class="cluster-${size}">${count}</div>`,
          className: 'custom-cluster-icon',
          iconSize: window.L.point(40, 40)
        });
      }
    });

    // Add filtered crime markers
    crimes.forEach(crime => {
      const latitude = Number(crime.latitude);
      const longitude = Number(crime.longitude);

      if (isNaN(latitude) || isNaN(longitude) || !isFinite(latitude) || !isFinite(longitude)) {
        return;
      }

      const getCrimeIcon = (crimeType) => {
        const colors = {
          'Murder': '#e11d48',
          'Shooting': '#dc2626',
          'Robbery': '#f97316',
          'Home Invasion': '#9333ea',
          'Theft': '#06b6d4',
          'Kidnapping': '#ec4899',
          'Sexual Assault': '#c026d3',
          'Assault': '#8b5cf6',
          'Seizures': '#3b82f6',
          'Burglary': '#eab308'
        };
        const color = colors[crimeType] || '#64748b';
        return window.L.divIcon({
          html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
          className: 'custom-crime-marker',
          iconSize: [12, 12],
          iconAnchor: [6, 6],
          popupAnchor: [0, -6]
        });
      };

      const marker = window.L.marker([latitude, longitude], {
        icon: getCrimeIcon(crime.crimeType)
      });

      marker.bindPopup(`
        <div class="p-2">
          <div class="text-xs text-slate-500 mb-2">${crime.date}</div>
          <div class="text-xs bg-white/50 text-rose-600 mb-1">${crime.crimeType}</div>
          <div class="text-h3 font-bold text-slate-600 mb-4">${crime.headline}</div>
          <div class="text-xs text-slate-500 mb-1">${crime.street}</div>
          <div class="text-xs text-rose-600">${crime.area}</div>
          <a href="/trinidad/crime/${crime.slug}" class="text-tiny text-rose-600 hover:underline mt-4 inline-block">View Details â†’</a>
        </div>
      `);

      leafletMarkersGroup.addLayer(marker);
    });

    leafletMapInstance.addLayer(leafletMarkersGroup);

    // Store updated markers group globally
    window.__leafletMarkersGroup = leafletMarkersGroup;

    console.log('âœ… Leaflet map updated with', crimes.length, 'markers');
    }

    // Initialize year filter when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initYearFilter);
    } else {
      // DOM already loaded
      initYearFilter();
    }

    console.log('ðŸ“Œ Year filter setup complete');
  }

  // Start waiting for crimes data
  waitForCrimesData();
  </script>

  <!-- Filters Tray -->
  <div id="filtersTray" class="fixed inset-0 z-50 pointer-events-none">
    <!-- Backdrop -->
    <div id="filtersBackdrop" class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-none"></div>

    <!-- Tray Content -->
    <div id="filtersTrayContent" class="absolute right-0 top-0 h-full w-80 bg-white/60 rounded-l-2xl shadow-2xl transform translate-x-full transition-transform duration-300 pointer-events-auto">
      <div class="p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-lg font-bold text-slate-700">Filters</h2>
          <button id="closeFiltersBtn" class="text-slate-400 hover:text-slate-600 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Filter Options -->
        <div class="space-y-4">
          <!-- Year Filter -->
          <div>
            <label for="yearFilter" class="block text-sm font-medium text-slate-700 mb-2">Select Year</label>
            <select id="yearFilter" class="w-full px-4 py-2 border border-slate-300 text-slate-500 rounded-lg hover:bg-slate-50 transition font-medium text-xs bg-white/50">
              <!-- Options populated dynamically by JavaScript -->
            </select>
          </div>

          <!-- Future filters can be added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Tray Script -->
  <script>
    const filtersBtn = document.getElementById('filtersBtn');
    const filtersTray = document.getElementById('filtersTray');
    const filtersTrayContent = document.getElementById('filtersTrayContent');
    const filtersBackdrop = document.getElementById('filtersBackdrop');
    const closeFiltersBtn = document.getElementById('closeFiltersBtn');

    function openFiltersTray() {
      filtersTray.classList.remove('pointer-events-none');
      filtersBackdrop.classList.remove('pointer-events-none');
      setTimeout(() => {
        filtersBackdrop.classList.remove('opacity-0');
        filtersTrayContent.classList.remove('translate-x-full');
      }, 10);
    }

    function closeFiltersTray() {
      filtersBackdrop.classList.add('opacity-0');
      filtersTrayContent.classList.add('translate-x-full');
      setTimeout(() => {
        filtersTray.classList.add('pointer-events-none');
        filtersBackdrop.classList.add('pointer-events-none');
      }, 300);
    }

    filtersBtn.addEventListener('click', openFiltersTray);
    closeFiltersBtn.addEventListener('click', closeFiltersTray);
    filtersBackdrop.addEventListener('click', closeFiltersTray);

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !filtersTray.classList.contains('pointer-events-none')) {
        closeFiltersTray();
      }
    });
  </script>
</Layout>
