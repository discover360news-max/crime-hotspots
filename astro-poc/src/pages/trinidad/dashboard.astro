---
/**
 * Trinidad & Tobago Crime Dashboard
 * Interactive dashboard with regional SVG map and Leaflet incidents map
 */

import Layout from '../../layouts/Layout.astro';
import { getTrinidadCrimes } from '../../lib/crimeData';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import StatCard from '../../components/StatCard.astro';
import QuickInsightsCard from '../../components/QuickInsightsCard.astro';
import TopRegionsCard from '../../components/TopRegionsCard.astro';
import FiltersTray from '../../components/FiltersTray.astro';
import InfoPopup from '../../components/InfoPopup.astro';
import LoadingShimmer from '../../components/LoadingShimmer.astro';
import '../../styles/dashboard.css';

const crimes = await getTrinidadCrimes();

// Calculate insights
const calculateInsights = (crimeData: typeof crimes) => {
  // Get unique dates and calculate date range
  const dates = crimeData.map(c => new Date(c.date)).filter(d => !isNaN(d.getTime()));
  const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
  const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
  const daysDiff = Math.ceil((maxDate.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

  // Average crimes per day
  const avgPerDay = (crimeData.length / daysDiff).toFixed(1);

  // Most dangerous day of week
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const dayCount = new Map<string, number>();
  dates.forEach(date => {
    const day = dayNames[date.getDay()];
    dayCount.set(day, (dayCount.get(day) || 0) + 1);
  });
  const mostDangerousDay = Array.from(dayCount.entries())
    .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

  // Busiest month
  const monthCount = new Map<string, number>();
  dates.forEach(date => {
    const month = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    monthCount.set(month, (monthCount.get(month) || 0) + 1);
  });
  const busiestMonth = Array.from(monthCount.entries())
    .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

  // Area stats
  const areaCount = new Map<string, number>();
  crimeData.forEach(crime => {
    const area = crime.area || 'Unknown';
    areaCount.set(area, (areaCount.get(area) || 0) + 1);
  });
  const areaArray = Array.from(areaCount.entries()).sort((a, b) => b[1] - a[1]);

  // Find safest area (exclude "Unknown" and empty values)
  const validAreas = areaArray.filter(([area]) => area && area !== 'Unknown' && area.trim() !== '');
  const safestRegion = validAreas[validAreas.length - 1]?.[0] || 'N/A';
  const safestRegionCount = validAreas[validAreas.length - 1]?.[1] || 0;

  const mostDangerousRegion = areaArray[0]?.[0] || 'N/A';
  const mostDangerousRegionCount = areaArray[0]?.[1] || 0;

  // Top 3 areas concentration
  const top3Count = areaArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
  const top3Percentage = ((top3Count / crimeData.length) * 100).toFixed(0);

  return {
    avgPerDay,
    mostDangerousDay,
    busiestMonth,
    safestRegion,
    safestRegionCount,
    mostDangerousRegion,
    mostDangerousRegionCount,
    top3Percentage,
    dayCount: daysDiff
  };
};

const insights = calculateInsights(crimes);

const title = "Trinidad & Tobago Crime Dashboard â€” Regional Statistics";
const description = "Real-time Trinidad crime statistics on our interactive map. View Port of Spain data and regional safety trends. Check the live dashboard now.";
---

<Layout title={title} description={description}>

  <div class="container mx-auto px-4 py-2 max-w-7xl">
    <!-- Page Header -->
    <div class="pt-4 mb-4">
      <Breadcrumbs items={[
        { label: 'Home', href: '/' },
        { label: 'Trinidad & Tobago ', href: '/dashboard' },
        { label: 'Dashboard' }
      ]} />
      <div class="flex items-start justify-between gap-10 pt-4">
        <div>
          <h1 class="text-2xl font-bold text-slate-700">Trinidad & Tobago</h1>
          <p class="text-small text-slate-500">Crime Statistics Dashboard</p>
        </div>
        <div class="flex flex-col gap-2">
          <a href="/trinidad/headlines"
            class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 transition font-medium text-xs whitespace-nowrap">
            Headlines
          </a>

          <button id="filtersBtn"
            class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 transition font-medium text-xs whitespace-nowrap">
            Filters â€º
          </button>
        </div>
      </div>
    </div>

    <!-- Separator -->
    <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent mb-4"></div>

    <!-- Statistics Cards - Horizontal Scroll -->
    <div class="stats-wrapper">
      <!-- Stats Shimmer (shown during loading) -->
      <div id="statsShimmer" class="flex gap-4 overflow-x-auto pb-4">
        {[...Array(10)].map(() => (
          <div class="flex-shrink-0" style="width: 180px;">
            <LoadingShimmer height="120px" />
          </div>
        ))}
      </div>

      <!-- Actual Stats (hidden initially) -->
      <div class="stats-scroll-container opacity-0 transition-opacity duration-300">
        <StatCard value={crimes.length} label="Total Incidents" id="totalIncidents" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Murder').length} label="Murders" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Robbery').length} label="Robberies" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Home Invasion').length} label="Home Invasions" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Theft').length} label="Thefts" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Shooting').length} label="Shootings" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Assault').length} label="Assaults" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Burglary').length} label="Burglaries" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Seizures').length} label="Seizures" />
        <StatCard value={crimes.filter(c => c.crimeType === 'Kidnapping').length} label="Kidnappings" />
      </div>
    </div>

    <!-- Separator -->
        <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-300 to-transparent mb-4"></div>

    <!-- Leaflet Map -->
    <div class="mb-6">
      <div class="flex items-center gap-2">
        <h2 class="text-h2 font-bold text-slate-700 pt-4 px-4 mb-4">Crime Incidents Map</h2>
        <InfoPopup id="map-info">
          <p class="font-semibold mb-2 text-slate-700">Understanding the Map</p>
          <p class="mb-3">This map shows estimated/reported locations of crimes and is updated daily.</p>
          <p class="font-semibold mb-2 text-slate-700">How to Use:</p>
          <ul class="list-disc list-inside space-y-1">
            <li>Click clusters to zoom in</li>
            <li>Click markers for incident details</li>
            <li>Use two fingers to pan map</li>
          </ul>
        </InfoPopup>
      </div>
      <div class="relative">
        <!-- Map Shimmer (shown during loading) -->
        <div id="mapShimmer" class="w-full">
          <LoadingShimmer height="600px" />
        </div>

        <!-- Actual Map (hidden initially) -->
        <div id="leafletMap" class="w-full h-150 rounded-lg opacity-0 transition-opacity duration-300"></div>

        <!-- Pan instruction overlay (shown on single finger touch) -->
        <div id="mapZoomHintTrinidad" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
          <div class="bg-white/70 backdrop-blur-md rounded-lg px-6 py-4 shadow-xl max-w-xs text-center">
            <p class="text-small font-semibold text-slate-600">Use two fingers to move map</p>
            <p class="text-tiny text-slate-600 mt-1">One finger scrolls the page</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Insights & Top Regions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
      <!-- Insight Cards Shimmer (shown during loading) -->
      <div id="insightsShimmer" class="contents">
        <LoadingShimmer height="400px" />
        <LoadingShimmer height="400px" />
      </div>

      <!-- Actual Insight Cards (hidden initially) -->
      <div id="insightsCards" class="contents opacity-0 transition-opacity duration-300">
        <QuickInsightsCard insights={insights} />
        <TopRegionsCard crimes={crimes} />
      </div>
    </div>

    <!-- Info Cards -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Real-Time Data</h3>
            <p class="text-xs text-slate-400">Dashboard updates daily with the latest crime incidents from verified sources.</p>
          </div>
        </div>
      </div>

      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Regional Filtering</h3>
            <p class="text-xs text-slate-400">Click any region on the map to filter the dashboard and view area-specific crime data.</p>
          </div>
        </div>
      </div>

      <div class="bg-white/50 backdrop-blur-md rounded-lg p-4 shadow-md">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
          </svg>
          <div>
            <h3 class="font-semibold text-slate-600 mb-2">Mobile Optimized</h3>
            <p class="text-xs text-slate-400">Fully responsive dashboard works seamlessly on all devices and screen sizes.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Initialize Map -->
  <script>
    // CSV URLs - MUST match server-side crimeData.ts
    const TRINIDAD_CSV_URLS = {
      '2025': 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1749261532&single=true&output=csv',
      // Current sheet (currently 2025, will be 2026 after archival)
      current: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1749261532&single=true&output=csv'
      // Test 2026: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTB-ktijzh1ySAy3NpfrcPEEEEs90q-0F0V8UxZxCTlTTbk4Qsa1cbLhlPwh38ie2_bGJYQX8n5vy8v/pub?gid=1963637925&single=true&output=csv'
    };

    // Parse CSV line handling quoted commas
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    // Parse date string (M/D/YYYY format)
    function parseDate(dateStr) {
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        const month = parseInt(parts[0]) - 1;
        const day = parseInt(parts[1]);
        const year = parseInt(parts[2]);
        return new Date(year, month, day);
      }
      return new Date(dateStr);
    }

    // Generate slug from headline and date
    function generateSlug(headline, date) {
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      const slugText = headline
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .substring(0, 80);
      return `${slugText}-${dateStr}`;
    }

    // Fetch and parse crimes from a CSV URL
    async function fetchCrimesFromURL(url) {
      try {
        const response = await fetch(url);
        const csvText = await response.text();
        const lines = csvText.split('\n');
        const crimes = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i];
          if (!line.trim()) continue;

          const values = parseCSVLine(line);
          const date = values[0] || '';
          const headline = values[1] || '';
          const crimeType = values[2] || '';
          const street = values[3] || '';
          const area = values[5] || '';
          const region = values[6] || '';
          const url = values[8] || '';
          const source = values[9] || '';
          const latitude = values[10] || '';
          const longitude = values[11] || '';
          const summary = values[12] || '';

          if (!headline || !date) continue;

          const dateObj = parseDate(date);
          if (isNaN(dateObj.getTime())) {
            console.warn(`Skipping entry with invalid date: ${date} - ${headline}`);
            continue;
          }

          const slug = generateSlug(headline, dateObj);

          crimes.push({
            date,
            headline,
            crimeType,
            street,
            area,
            region,
            url,
            source,
            latitude: Number(latitude),
            longitude: Number(longitude),
            summary,
            slug,
            dateObj,
            year: dateObj.getFullYear(),
            month: dateObj.getMonth() + 1,
            day: dateObj.getDate()
          });
        }

        return crimes;
      } catch (error) {
        console.error('Error fetching crimes from URL:', url, error);
        return [];
      }
    }

    // Shimmer control with minimum display time (global scope)
    const MINIMUM_SHIMMER_TIME = 500; // milliseconds

    window.hideShimmerWithMinTime = async function(shimmerEl, contentEl, shimmerStartTime) {
      const elapsed = Date.now() - shimmerStartTime;
      const remaining = Math.max(0, MINIMUM_SHIMMER_TIME - elapsed);

      // Wait for minimum time if needed
      if (remaining > 0) {
        await new Promise(resolve => setTimeout(resolve, remaining));
      }

      // Hide shimmer, show content
      if (shimmerEl) shimmerEl.style.display = 'none';
      if (contentEl) {
        contentEl.style.opacity = '1';
      }
    }

    // Wait for DOM and load crimes data
    window.addEventListener('DOMContentLoaded', async () => {
      // Track when shimmers started
      const shimmerStartTime = Date.now();

      console.log('ðŸ” Loading crimes data from CSV...');

      // Fetch crimes, avoiding duplicates if URLs match
      let crimes2025 = [];
      let crimesCurrent = [];

      // Only fetch 2025 sheet if it's different from current sheet
      if (TRINIDAD_CSV_URLS['2025'] && TRINIDAD_CSV_URLS['2025'] !== TRINIDAD_CSV_URLS.current) {
        crimes2025 = await fetchCrimesFromURL(TRINIDAD_CSV_URLS['2025']);
        console.log(`Loaded ${crimes2025.length} crimes from 2025 sheet`);
      }

      // Always fetch current sheet
      crimesCurrent = await fetchCrimesFromURL(TRINIDAD_CSV_URLS.current);
      console.log(`Loaded ${crimesCurrent.length} crimes from current sheet`);

      // Combine all crimes (no deduplication needed - each crime only in one sheet)
      const crimes = [...crimes2025, ...crimesCurrent];
      crimes.sort((a, b) => b.dateObj.getTime() - a.dateObj.getTime());

      console.log(`âœ… Total crimes loaded: ${crimes.length}`);

      // Store ALL crimes globally for year filter script
      window.__crimesData = crimes;

      // Calculate current year (highest year)
      const availableYears = [...new Set(crimes.map(c => c.year))].sort((a, b) => b - a);
      const currentYear = availableYears[0];
      console.log(`ðŸŽ¯ Current year detected: ${currentYear}`);

      // Filter to show only current year by default
      const currentYearCrimes = crimes.filter(c => c.year === currentYear);
      console.log(`ðŸ“Š Showing ${currentYearCrimes.length} crimes from ${currentYear} (filtered from ${crimes.length} total)`);

      // Hide stats and insights shimmers with minimum display time
      await window.hideShimmerWithMinTime(
        document.getElementById('statsShimmer'),
        document.querySelector('.stats-scroll-container'),
        shimmerStartTime
      );

      await window.hideShimmerWithMinTime(
        document.getElementById('insightsShimmer'),
        document.getElementById('insightsCards'),
        shimmerStartTime
      );

    // Map will be initialized by separate script below
  }); // Close DOMContentLoaded
  </script>

  <!-- Leaflet Map Initialization -->
  <script>
    import { initializeLeafletMap } from '../../scripts/leafletMap';

    // Track when map shimmer started
    const mapShimmerStartTime = Date.now();

    // Wait for crimes data to be available
    function waitForMapData() {
      if (!window.__crimesData) {
        setTimeout(waitForMapData, 100);
        return;
      }

      // Get current year
      const availableYears = [...new Set(window.__crimesData.map((c: any) => c.year))].sort((a: number, b: number) => b - a);
      const currentYear = availableYears[0];
      const currentYearCrimes = window.__crimesData.filter((c: any) => c.year === currentYear);

      initializeLeafletMap('leafletMap', currentYearCrimes, {
        center: [10.634963, -61.197207],
        zoom: 9,
        country: 'Trinidad',
        crimeDetailPath: '/trinidad/crime/',
        onMapReady: async () => {
          // Hide map shimmer with minimum display time (500ms)
          const elapsed = Date.now() - mapShimmerStartTime;
          const remaining = Math.max(0, 500 - elapsed);

          if (remaining > 0) {
            await new Promise(resolve => setTimeout(resolve, remaining));
          }

          const mapShimmer = document.getElementById('mapShimmer');
          const leafletMap = document.getElementById('leafletMap');

          if (mapShimmer) mapShimmer.style.display = 'none';
          if (leafletMap) leafletMap.style.opacity = '1';

          console.log('âœ… Map shimmer hidden, map visible');
        }
      });
    }

    waitForMapData();
  </script>

  <!-- Year Filtering Script -->
  <script>
    import { initializeYearFilter } from '../../scripts/yearFilter';
    import { updateLeafletMap } from '../../scripts/leafletMap';

    console.log('ðŸš€ Year filter script starting...');

    // Wait for crimes data to be available
    function waitForCrimesData() {
      if (!window.__crimesData) {
        setTimeout(waitForCrimesData, 100);
        return;
      }

      // Initialize year filter with callbacks
      initializeYearFilter(window.__crimesData, {
        updateStatsCards: (crimes) => {
          // Show shimmer before update
          const statsShimmer = document.getElementById('statsShimmer');
          const statsContainer = document.querySelector('.stats-scroll-container');

          if (statsShimmer) statsShimmer.style.display = 'flex';
          if (statsContainer) statsContainer.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateStatsCards(crimes);

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(statsShimmer, statsContainer, updateStart);
          }, 100);
        },
        updateQuickInsights: (crimes) => {
          // Show shimmer before update
          const insightsShimmer = document.getElementById('insightsShimmer');
          const insightsCards = document.getElementById('insightsCards');

          if (insightsShimmer) insightsShimmer.style.display = 'contents';
          if (insightsCards) insightsCards.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateQuickInsights(crimes);
            updateTopRegions(crimes);

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(insightsShimmer, insightsCards, updateStart);
          }, 100);
        },
        updateTopRegions: () => {}, // Already handled in updateQuickInsights
        updateLeafletMap: (crimes) => {
          // Show shimmer before update
          const mapShimmer = document.getElementById('mapShimmer');
          const leafletMap = document.getElementById('leafletMap');

          if (mapShimmer) mapShimmer.style.display = 'block';
          if (leafletMap) leafletMap.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateLeafletMap(crimes, '/trinidad/crime/');

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(mapShimmer, leafletMap, updateStart);
          }, 100);
        }
      });
    }

  // Update stats cards
  function updateStatsCards(crimes) {
    // Update Total Incidents - target the value element inside the card
    const totalIncidentsCard = document.getElementById('totalIncidents');
    if (totalIncidentsCard) {
      const valueEl = totalIncidentsCard.querySelector('.text-3xl');
      if (valueEl) valueEl.textContent = crimes.length;
    }

    // Update individual crime type cards
    const murders = crimes.filter(c => c.crimeType === 'Murder').length;
    const robberies = crimes.filter(c => c.crimeType === 'Robbery').length;
    const homeInvasions = crimes.filter(c => c.crimeType === 'Home Invasion').length;
    const thefts = crimes.filter(c => c.crimeType === 'Theft').length;
    const shootings = crimes.filter(c => c.crimeType === 'Shooting').length;
    const assaults = crimes.filter(c => c.crimeType === 'Assault').length;
    const burglaries = crimes.filter(c => c.crimeType === 'Burglary').length;
    const seizures = crimes.filter(c => c.crimeType === 'Seizures').length;
    const kidnappings = crimes.filter(c => c.crimeType === 'Kidnapping').length;

    // Find and update each stat card by index
    const statCards = document.querySelectorAll('.stat-card');
    const murdersEl = statCards[1]?.querySelector('.text-3xl');
    const robberiesEl = statCards[2]?.querySelector('.text-3xl');
    const homeInvasionsEl = statCards[3]?.querySelector('.text-3xl');
    const theftsEl = statCards[4]?.querySelector('.text-3xl');
    const shootingsEl = statCards[5]?.querySelector('.text-3xl');
    const assaultsEl = statCards[6]?.querySelector('.text-3xl');
    const burglariesEl = statCards[7]?.querySelector('.text-3xl');
    const seizuresEl = statCards[8]?.querySelector('.text-3xl');
    const kidnappingsEl = statCards[9]?.querySelector('.text-3xl');

    if (murdersEl) murdersEl.textContent = murders;
    if (robberiesEl) robberiesEl.textContent = robberies;
    if (homeInvasionsEl) homeInvasionsEl.textContent = homeInvasions;
    if (theftsEl) theftsEl.textContent = thefts;
    if (shootingsEl) shootingsEl.textContent = shootings;
    if (assaultsEl) assaultsEl.textContent = assaults;
    if (burglariesEl) burglariesEl.textContent = burglaries;
    if (seizuresEl) seizuresEl.textContent = seizures;
    if (kidnappingsEl) kidnappingsEl.textContent = kidnappings;

    console.log('âœ… Stats cards updated');
  }

  // Update Quick Insights
  function updateQuickInsights(crimes) {
    if (crimes.length === 0) return;

    const dates = crimes.map(c => new Date(c.date)).filter(d => !isNaN(d.getTime()));
    const minDate = new Date(Math.min(...dates.map(d => d.getTime())));
    const maxDate = new Date(Math.max(...dates.map(d => d.getTime())));
    const daysDiff = Math.ceil((maxDate.getTime() - minDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

    const avgPerDay = (crimes.length / daysDiff).toFixed(1);

    // Most dangerous day
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const dayCount = new Map();
    dates.forEach(date => {
      const day = dayNames[date.getDay()];
      dayCount.set(day, (dayCount.get(day) || 0) + 1);
    });
    const mostDangerousDay = Array.from(dayCount.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

    // Busiest month
    const monthCount = new Map();
    dates.forEach(date => {
      const month = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      monthCount.set(month, (monthCount.get(month) || 0) + 1);
    });
    const busiestMonth = Array.from(monthCount.entries()).sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

    // Area stats
    const areaCount = new Map();
    crimes.forEach(crime => {
      const area = crime.area || 'Unknown';
      areaCount.set(area, (areaCount.get(area) || 0) + 1);
    });
    const areaArray = Array.from(areaCount.entries()).sort((a, b) => b[1] - a[1]);
    const top3Count = areaArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
    const top3Percentage = ((top3Count / crimes.length) * 100).toFixed(0);

    // Find safest area (exclude "Unknown" and empty values)
    const validAreas = areaArray.filter(([area]) => area && area !== 'Unknown' && area.trim() !== '');
    const safestRegion = validAreas[validAreas.length - 1]?.[0] || 'N/A';
    const safestRegionCount = validAreas[validAreas.length - 1]?.[1] || 0;

    const mostDangerousRegion = areaArray[0]?.[0] || 'N/A';
    const mostDangerousRegionCount = areaArray[0]?.[1] || 0;

    // Update DOM using IDs
    const avgPerDayEl = document.getElementById('avgPerDay');
    const mostDangerousDayEl = document.getElementById('mostDangerousDay');
    const busiestMonthEl = document.getElementById('busiestMonth');
    const top3PercentageEl = document.getElementById('top3Percentage');
    const mostDangerousRegionEl = document.getElementById('mostDangerousRegion');
    const mostDangerousRegionCountEl = document.getElementById('mostDangerousRegionCount');
    const safestRegionEl = document.getElementById('safestRegion');
    const safestRegionCountEl = document.getElementById('safestRegionCount');

    if (avgPerDayEl) avgPerDayEl.textContent = `${avgPerDay} crimes/day`;
    if (mostDangerousDayEl) mostDangerousDayEl.textContent = mostDangerousDay;
    if (busiestMonthEl) busiestMonthEl.textContent = busiestMonth;
    if (top3PercentageEl) top3PercentageEl.textContent = `Top 3 areas: ${top3Percentage}%`;
    if (mostDangerousRegionEl) mostDangerousRegionEl.textContent = mostDangerousRegion;
    if (mostDangerousRegionCountEl) mostDangerousRegionCountEl.textContent = `${mostDangerousRegionCount} incidents`;
    if (safestRegionEl) safestRegionEl.textContent = safestRegion;
    if (safestRegionCountEl) safestRegionCountEl.textContent = `${safestRegionCount} incidents`;

    console.log('âœ… Quick Insights updated');
  }

  // Update Top Areas
  function updateTopRegions(crimes) {
    const areaCount = new Map();
    crimes.forEach(crime => {
      const area = crime.area || 'Unknown';
      areaCount.set(area, (areaCount.get(area) || 0) + 1);
    });

    const topAreas = Array.from(areaCount.entries())
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10);

    // Update using ID selector
    const container = document.getElementById('topRegionsContainer');
    if (container) {
      container.innerHTML = topAreas.map(([area, count]) => `
        <div class="flex justify-between items-center pb-2 border-b border-slate-200 last:border-0">
          <span class="text-xs text-slate-500">${area}</span>
          <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white text-xs font-medium">
            ${count}
          </span>
        </div>
      `).join('');
    }

    console.log('âœ… Top Areas updated');
  }

    // Start waiting for crimes data
    waitForCrimesData();
  </script>

  <!-- Filters Tray Component -->
  <FiltersTray showYearFilter={true} />

  <!-- Mouse Wheel Horizontal Scroll for Stats Cards -->
  <script>
    import { initializeStatsScroll } from '../../scripts/statsScroll';
    initializeStatsScroll();
  </script>
</Layout>
