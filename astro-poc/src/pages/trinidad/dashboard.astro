---
/**
 * Trinidad & Tobago Crime Dashboard
 * Interactive dashboard with regional SVG map and Leaflet incidents map
 */

// Keep dashboard static (pre-rendered at build time)
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
import { getTrinidadCrimes } from '../../lib/crimeData';
import { countCrimeType, calculateInsights } from '../../lib/dashboardHelpers';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import StatCard from '../../components/StatCard.astro';
import QuickInsightsCard from '../../components/QuickInsightsCard.astro';
import TopRegionsCard from '../../components/TopRegionsCard.astro';
import DashboardInfoCards from '../../components/DashboardInfoCards.astro';
import FiltersTray from '../../components/FiltersTray.astro';
import InfoPopup from '../../components/InfoPopup.astro';
import LoadingShimmer from '../../components/LoadingShimmer.astro';
import SiteNotificationBanner from '../../components/SiteNotificationBanner.astro';
import DashboardStory from '../../components/DashboardStory.astro';
import { dataUpdateNotice } from '../../config/siteNotifications';
import { getCountryName } from '../../data/countries';
import { routes } from '../../config/routes';
import '../../styles/dashboard.css';

// Get all crimes (will be used for year filtering on client-side)
const allCrimes = await getTrinidadCrimes();

// Get available years for dropdown (sorted descending)
const availableYears = [...new Set(allCrimes.map(c => c.year))].sort((a, b) => b - a);

// Use the highest year in the data as "current" (not calendar year)
// This ensures we show the latest data, even if it's from a different year
const currentYear = availableYears[0];

// Filter to current year by default (server-side initial render)
const crimes = allCrimes.filter(crime => crime.year === currentYear);

// Calculate insights using imported helper
const insights = calculateInsights(crimes);

// Region / Area filter data
const dashboardRegions = [...new Set(allCrimes.map(c => c.region).filter(Boolean))].sort();
const dashboardAreas = [...new Set(allCrimes.map(c => c.area).filter(Boolean))].sort();
const dashboardRegionToAreas: Record<string, string[]> = {};
allCrimes.forEach(c => {
  if (c.region && c.area) {
    if (!dashboardRegionToAreas[c.region]) dashboardRegionToAreas[c.region] = [];
    if (!dashboardRegionToAreas[c.region].includes(c.area)) dashboardRegionToAreas[c.region].push(c.area);
  }
});
Object.values(dashboardRegionToAreas).forEach(arr => (arr as string[]).sort());

// Most recent crime date for freshness indicator
const latestCrimeDate = crimes[0]?.dateObj ?? new Date();
const freshnessText = latestCrimeDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });

const title = "Trinidad Crime Dashboard 2026 - Murder Count, Statistics & Live Map";
const description = "Track Trinidad & Tobago crime statistics for 2026. Live murder count, robbery rates, and incident map. Updated daily with the latest crime data.";
---


<Layout title={title} description={description} includeLeaflet={true} includeTurnstile={true}>

  <!-- Hero section â€” cohesive with Headlines page (Hero.astro compact pattern) -->
  <section class="w-full bg-gradient-to-br from-rose-50 via-white to-slate-50 dark:from-rose-950/30 dark:via-[hsl(0_0%_5%)] dark:to-[hsl(0_0%_5%)] px-4 sm:px-6 lg:px-8 py-6 sm:py-8" data-pagefind-ignore>
    <div class="mx-auto max-w-3xl">
      <Breadcrumbs items={[
        { label: 'Home', href: '/' },
        { label: getCountryName('tt') }
      ]} />
      <div class="pt-3">
        <h1 class="font-bold text-slate-800 dark:text-[hsl(0_0%_95%)] text-heading leading-snug mb-2">
          Trinidad & Tobago
        </h1>
        <p class="text-body text-slate-600 dark:text-[hsl(0_0%_75%)] leading-relaxed mb-0.5">
          Crime Statistics Dashboard <span id="dashboardYear" class="font-medium">for {currentYear}</span>
        </p>
        <p id="dataFreshness" class="text-xs text-slate-400 dark:text-[hsl(0_0%_50%)] flex items-center gap-1 mb-3">
          <svg class="w-3 h-3 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          Data as of {freshnessText}
        </p>
        <!-- CTAs row: Headlines (primary) â†’ Murder Count (secondary) â†’ Filters | Clear -->
        <div class="flex gap-4 items-center flex-row flex-wrap">
          <a href={routes.trinidad.headlines}
            class="px-4 py-1.5 min-h-[22px] inline-flex items-center gap-2 rounded-lg bg-rose-600 text-white hover:bg-rose-700 active:bg-rose-800 transition font-medium text-xs shadow-sm hover:shadow-md whitespace-nowrap">
            Headlines
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
          </a>
          <a href={routes.trinidad.murderCount}
            class="px-4 py-1.5 min-h-[22px] inline-flex items-center gap-2 rounded-lg border-2 border-slate-300 dark:border-[hsl(0_0%_30%)] text-slate-700 dark:text-[hsl(0_0%_85%)] hover:border-rose-600 dark:hover:border-rose-500 hover:text-rose-600 dark:hover:text-rose-400 active:bg-rose-50 dark:active:bg-rose-950/40 transition font-medium text-xs whitespace-nowrap">
            Murder Count
          </a>
          <div class="flex items-center gap-2">
            <button
              id="filtersBtn"
              class="px-4 py-1.5 min-h-[22px] inline-flex items-center justify-center border-2 border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-700 dark:text-[hsl(0_0%_85%)] hover:border-rose-600 hover:text-rose-600 active:bg-rose-50 dark:active:bg-rose-950/30 rounded-lg transition font-medium text-xs whitespace-nowrap"
            >
              <span id="filtersBtnText">Filters â€º</span>
            </button>
            <button
              id="clearFiltersInline"
              class="hidden text-xs text-rose-600 hover:text-rose-700 font-medium whitespace-nowrap transition"
            >
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <div class="container mx-auto px-4 sm:px-6 py-4 max-w-3xl" data-pagefind-ignore>

    <!-- Site Notification Banner -->
    <SiteNotificationBanner notification={dataUpdateNotice} />

    <!-- Dashboard Story â€” narrative summary -->
    <DashboardStory allCrimes={allCrimes} />

    <!-- Statistics Cards - Horizontal Scroll -->
    <div class="flex items-center gap-1 mb-2">
      <h2 class="sr-only">Crime Statistics</h2>
      <InfoPopup id="crime-types-info">
        <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">Crime Type Definitions</p>
        <ul class="space-y-1.5">
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Murder</span> â€” Fatal violent crime</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Robbery</span> â€” Theft with force or threat of force</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Shooting</span> â€” Firearm discharge incident</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Home Invasion</span> â€” Forced entry into an occupied residence</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Seizures</span> â€” Confiscation of drugs, firearms, or contraband</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Assault</span> â€” Physical attack causing bodily harm</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Burglary</span> â€” Unlawful entry with intent to steal (unoccupied)</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Theft</span> â€” Property taken without force</li>
          <li><span class="font-bold text-slate-700 dark:text-[hsl(0_0%_85%)]">Kidnapping</span> â€” Unlawful abduction or restraint</li>
        </ul>
      </InfoPopup>
    </div>
    <div class="stats-wrapper relative min-h-[140px] overflow-hidden">
      <!-- Stats Shimmer (shown during loading) -->
      <div id="statsShimmer" class="absolute inset-0 flex gap-4 overflow-x-auto pb-4 transition-opacity duration-300">
        {[...Array(10)].map(() => (
          <div class="flex-shrink-0" style="width: 180px;">
            <LoadingShimmer height="120px" />
          </div>
        ))}
      </div>

      <!-- Actual Stats (hidden initially) -->
      <div class="stats-scroll-container absolute inset-0 opacity-0 transition-opacity duration-300">
        <StatCard value={crimes.length} label="Total Incidents" id="totalIncidents" crimeType="All" />
        <StatCard value={countCrimeType(crimes, 'Murder')} label="Murders" crimeType="Murder" />
        <StatCard value={countCrimeType(crimes, 'Robbery')} label="Robberies" crimeType="Robbery" />
        <StatCard value={countCrimeType(crimes, 'Home Invasion')} label="Home Invasions" crimeType="Home Invasion" />
        <StatCard value={countCrimeType(crimes, 'Theft')} label="Thefts" crimeType="Theft" />
        <StatCard value={countCrimeType(crimes, 'Shooting')} label="Shootings" crimeType="Shooting" />
        <StatCard value={countCrimeType(crimes, 'Assault')} label="Assaults" crimeType="Assault" />
        <StatCard value={countCrimeType(crimes, 'Burglary')} label="Burglaries" crimeType="Burglary" />
        <StatCard value={countCrimeType(crimes, 'Seizures')} label="Seizures" crimeType="Seizures" />
        <StatCard value={countCrimeType(crimes, 'Kidnapping')} label="Kidnappings" crimeType="Kidnapping" />
      </div>

      <!-- Fade gradient + pulsing arrow (right side) -->
      <div id="statsScrollHint" class="absolute right-0 top-0 bottom-4 w-16 bg-gradient-to-l from-white via-white/90 to-transparent dark:from-[hsl(0_0%_3%)] dark:via-[hsl(0_0%_3%_/_0.9)] pointer-events-none flex items-center justify-end pr-2 opacity-0 transition-opacity duration-300">
        <svg class="w-4 h-4 text-rose-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- Separator -->
        <div class="w-full h-px bg-gradient-to-r from-transparent via-slate-300 dark:via-[hsl(0_0%_20%)] to-transparent mb-4"></div>

    <!-- Quick Insights -->
    <div class="mb-6">
      <h2 id="quickInsightsTitle" class="text-body font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] pt-4 px-4 mb-4">Quick Insights</h2>
      <div class="relative min-h-[280px]">
        <div id="insightsShimmer" class="absolute inset-0 transition-opacity duration-300">
          <LoadingShimmer height="280px" />
        </div>
        <div id="insightsCards" class="absolute inset-0 opacity-0 transition-opacity duration-300">
          <QuickInsightsCard insights={insights} />
        </div>
      </div>
    </div>

    <!-- Leaflet Map -->
    <div class="mb-6">
      <div class="flex items-center gap-2">
        <h2 class="text-body font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] pt-4 px-4 mb-4">Crime Incidents Map</h2>
        <InfoPopup id="map-info">
          <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">Understanding the Map</p>
          <p class="mb-3">This map shows estimated/reported locations of crimes and is updated daily.</p>
          <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">How to Use:</p>
          <ul class="list-disc list-inside space-y-1">
            <li>Click clusters to zoom in</li>
            <li>Click markers for incident details</li>
            <li>Use two fingers to pan map</li>
          </ul>
        </InfoPopup>
      </div>
      <!-- Map (full width) -->
      <div id="mapContainer" class="relative h-[450px]">
        <!-- Map Shimmer (shown during loading) -->
        <div id="mapShimmer" class="absolute inset-0 w-full transition-opacity duration-300">
          <LoadingShimmer height="100%" />
        </div>

        <!-- Actual Map (hidden initially) -->
        <div id="leafletMap" class="absolute inset-0 w-full rounded-lg opacity-0 transition-opacity duration-300"></div>

        <!-- Pan instruction overlay (shown on single finger touch) -->
        <div id="mapZoomHintTrinidad" class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 z-10">
          <div class="bg-white/85 dark:bg-[hsl(0_0%_8%)]/85 backdrop-blur-md rounded-lg px-6 py-4 shadow-xl max-w-xs text-center">
            <p class="text-caption font-bold text-slate-600 dark:text-[hsl(0_0%_90%)]">Use two fingers to move map</p>
            <p class="text-caption text-slate-600 dark:text-[hsl(0_0%_55%)] mt-1">One finger scrolls the page</p>
          </div>
        </div>
      </div>

      <!-- Collapsible Legend -->
      <details class="mt-3 group bg-white/85 dark:bg-[hsl(0_0%_8%)]/85 backdrop-blur-md border border-slate-200 dark:border-[hsl(0_0%_15%)] rounded-lg">
        <summary class="px-4 py-2.5 cursor-pointer list-none flex items-center justify-between select-none">
          <h3 class="text-xs font-semibold text-slate-700 dark:text-[hsl(0_0%_90%)]">
            <span class="group-open:hidden">View Legend</span>
            <span class="hidden group-open:block">Legend</span>
          </h3>
          <svg class="w-4 h-4 text-slate-400 dark:text-[hsl(0_0%_50%)] transition-transform duration-200 group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7 7" />
          </svg>
        </summary>
        <div class="px-4 pb-3 pt-2 grid grid-cols-2 sm:grid-cols-5 gap-x-4 gap-y-2 border-t border-slate-100 dark:border-[hsl(0_0%_18%)]">
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#e11d48"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Murder</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#dc2626"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Shooting</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#f97316"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Robbery</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#9333ea"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Home Invasion</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#06b6d4"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Theft</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#ec4899"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Kidnapping</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#c026d3"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Sexual Assault</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#8b5cf6"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Assault</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#3b82f6"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Seizures</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-2.5 h-2.5 rounded-full border border-white dark:border-[hsl(0_0%_15%)] shadow-sm shrink-0" style="background:#eab308"></span>
            <span class="text-xs text-slate-600 dark:text-[hsl(0_0%_55%)]">Burglary</span>
          </div>
        </div>
      </details>
    </div>

    <!-- Top Areas -->
    <div class="mb-6">
      <!-- Header with InfoPopup (outside card to avoid backdrop-blur containment) -->
      <div class="flex items-center gap-2 pt-4 mb-4 px-4">
        <h3 class="text-body font-bold text-slate-500 dark:text-[hsl(0_0%_55%)]">Top Areas</h3>
        <a href={routes.trinidad.areas} class="ml-auto text-xs text-rose-600 hover:text-rose-700 active:text-rose-800 font-medium transition">
          View all
          <svg class="w-3 h-3 inline-block ml-0.5 -mt-px" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
        <InfoPopup id="top-areas-risk-info">
          <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">Understanding Risk Assessment</p>
          <p class="mb-3">Each area's risk level is calculated based on crime severity and victim impact.</p>
          <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">How It Works:</p>
          <ul class="list-disc list-inside space-y-1 mb-3">
            <li>Each crime type has a severity weight (Murder=10, Theft=2, etc.)</li>
            <li>Victim counts multiply risk for serious crimes</li>
            <li>Area risk = sum of all crime risk scores</li>
            <li>Bar shows percentage relative to highest-risk area</li>
          </ul>
          <p class="font-bold mb-2 text-slate-700 dark:text-[hsl(0_0%_90%)]">Color Guide:</p>
          <ul class="list-disc list-inside space-y-1">
            <li><span class="text-green-600 font-medium">Green</span>: Low risk (0-33%)</li>
            <li><span class="text-yellow-600 font-medium">Yellow</span>: Medium risk (34-66%)</li>
            <li><span class="text-rose-600 font-medium">Red</span>: High risk (67-100%)</li>
          </ul>
        </InfoPopup>
      </div>

      <div class="relative">
        <div id="topRegionsShimmer" class="absolute inset-0 z-10 transition-opacity duration-300">
          <LoadingShimmer height="100%" />
        </div>
        <div id="topRegionsCard" class="opacity-0 transition-opacity duration-300">
          <TopRegionsCard crimes={crimes} />
        </div>
      </div>
    </div>

    <!-- Info Cards -->
    <DashboardInfoCards />

    <!-- Related Resources -->
    <div class="mt-8">
      <h2 class="text-body font-bold text-slate-500 dark:text-[hsl(0_0%_55%)] pt-4 px-4 mb-4">Related Resources</h2>
      <div class="grid sm:grid-cols-2 gap-3">
        <a href={routes.trinidad.statistics} class="block bg-white/85 dark:bg-[hsl(0_0%_8%)]/85 backdrop-blur-md rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] p-4 hover:border-rose-300 dark:hover:border-rose-800 hover:shadow-sm transition">
          <h3 class="font-semibold text-slate-800 dark:text-[hsl(0_0%_90%)] text-sm">Crime Statistics & Rate</h3>
          <p class="text-xs text-slate-500 dark:text-[hsl(0_0%_55%)] mt-1">Comprehensive statistics with year-over-year analysis and crime rate calculations</p>
        </a>
        <a href={routes.trinidad.murderCount} class="block bg-rose-50 dark:bg-rose-950/40 rounded-lg border border-rose-200 dark:border-rose-900/50 p-4 hover:border-rose-400 dark:hover:border-rose-700 hover:shadow-md transition">
          <div class="flex items-center gap-1.5 mb-1">
            <svg class="w-4 h-4 text-rose-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 23c-3.6 0-8-3.13-8-8.46C4 9.5 9.04 3.18 11.14.97a1.15 1.15 0 011.72 0C15 3.18 20 9.5 20 14.54 20 19.87 15.6 23 12 23zm0-19.73C9.64 6.1 6 11.47 6 14.54 6 18.62 9.07 21 12 21s6-2.38 6-6.46c0-3.07-3.64-8.44-6-11.27z"/><path d="M12 19a3.5 3.5 0 01-3.5-3.5c0-1.56 1.84-3.88 3.08-5.12a.58.58 0 01.84 0c1.24 1.24 3.08 3.56 3.08 5.12A3.5 3.5 0 0112 19z"/></svg>
            <h3 class="font-semibold text-rose-700 dark:text-rose-400 text-sm">Murder Count {currentYear}</h3>
          </div>
          <p class="text-xs text-rose-600/70 dark:text-rose-400/70">Live murder count with year-over-year comparison</p>
        </a>
      </div>
    </div>
  </div>

  <!-- Initialize Dashboard Data -->
  <script>
    import { initializeDashboardData } from '../../scripts/dashboardDataLoader';

    // Wait for DOM and load crimes data
    window.addEventListener('DOMContentLoaded', initializeDashboardData);
  </script>

  <!-- Leaflet Map Initialization -->
  <script>
    import { initializeLeafletMap } from '../../scripts/leafletMap';

    // Track when map shimmer started
    const mapShimmerStartTime = Date.now();

    // Wait for crimes data to be available
    function waitForMapData() {
      if (!window.__crimesData) {
        setTimeout(waitForMapData, 100);
        return;
      }

      // Get current year
      const availableYears = [...new Set(window.__crimesData.map((c: any) => c.year))].sort((a: number, b: number) => b - a);
      const currentYear = availableYears[0];
      const currentYearCrimes = window.__crimesData.filter((c: any) => c.year === currentYear);

      initializeLeafletMap('leafletMap', currentYearCrimes, {
        center: [10.634963, -61.197207],
        zoom: 8,
        country: 'Trinidad',
        crimeDetailPath: '/trinidad/crime/',
        onMapReady: async () => {
          // Hide map shimmer with minimum display time (500ms)
          const elapsed = Date.now() - mapShimmerStartTime;
          const remaining = Math.max(0, 500 - elapsed);

          if (remaining > 0) {
            await new Promise(resolve => setTimeout(resolve, remaining));
          }

          const mapShimmer = document.getElementById('mapShimmer');
          const leafletMap = document.getElementById('leafletMap');

          if (mapShimmer) mapShimmer.style.display = 'none';
          if (leafletMap) leafletMap.style.opacity = '1';

          console.log('âœ… Map shimmer hidden, map visible');
        }
      });
    }

    waitForMapData();
  </script>

  <!-- Year Filtering Script -->
  <script>
    import { initializeYearFilter } from '../../scripts/yearFilter';
    import { updateLeafletMap } from '../../scripts/leafletMap';
    import { updateStatsCards, updateQuickInsights, updateTopRegions } from '../../scripts/dashboardUpdates';
    import { initializeStatCardFiltering, initializeTraySync } from '../../scripts/statCardFiltering';

    console.log('ðŸš€ Year filter script starting...');

    // Wait for crimes data to be available
    function waitForCrimesData() {
      if (!window.__crimesData) {
        setTimeout(waitForCrimesData, 100);
        return;
      }

      // Initialize year filter with callbacks
      initializeYearFilter(window.__crimesData, {
        updateStatsCards: (crimes) => {
          // Show shimmer before update
          const statsShimmer = document.getElementById('statsShimmer');
          const statsContainer = document.querySelector('.stats-scroll-container');

          if (statsShimmer) { statsShimmer.style.opacity = '1'; statsShimmer.style.pointerEvents = ''; }
          if (statsContainer) statsContainer.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateStatsCards(crimes, window.__crimesData);

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(statsShimmer, statsContainer, updateStart);
          }, 100);
        },
        updateQuickInsights: (crimes) => {
          // Show shimmer before update
          const insightsShimmer = document.getElementById('insightsShimmer');
          const insightsCards = document.getElementById('insightsCards');

          if (insightsShimmer) { insightsShimmer.style.opacity = '1'; insightsShimmer.style.pointerEvents = ''; }
          if (insightsCards) insightsCards.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateQuickInsights(crimes);

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(insightsShimmer, insightsCards, updateStart);
          }, 100);
        },
        updateTopRegions: (crimes) => {
          // Show shimmer before update (absolute overlay - opacity transition)
          const topRegionsShimmer = document.getElementById('topRegionsShimmer');
          const topRegionsCard = document.getElementById('topRegionsCard');

          if (topRegionsShimmer) { topRegionsShimmer.style.opacity = '1'; topRegionsShimmer.style.pointerEvents = ''; }
          if (topRegionsCard) topRegionsCard.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateTopRegions(crimes);

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(topRegionsShimmer, topRegionsCard, updateStart);
          }, 100);
        },
        updateLeafletMap: (crimes) => {
          // Show shimmer before update
          const mapShimmer = document.getElementById('mapShimmer');
          const leafletMap = document.getElementById('leafletMap');

          if (mapShimmer) { mapShimmer.style.opacity = '1'; mapShimmer.style.pointerEvents = ''; }
          if (leafletMap) leafletMap.style.opacity = '0';

          // Update after short delay
          setTimeout(async () => {
            const updateStart = Date.now();
            updateLeafletMap(crimes, '/trinidad/crime/');

            // Hide shimmer with minimum time
            await window.hideShimmerWithMinTime(mapShimmer, leafletMap, updateStart);
          }, 100);
        },
        updateSubtitleYear: (selectedValue) => {
          const dashboardYear = document.getElementById('dashboardYear');
          if (!dashboardYear) return;

          // Update year display based on selection
          if (selectedValue === 'all') {
            dashboardYear.textContent = '(All Years)';
          } else {
            dashboardYear.textContent = `for ${selectedValue}`;
          }

          // Update data freshness indicator
          const freshness = document.getElementById('dataFreshness');
          if (freshness && window.__crimesData) {
            const filtered = selectedValue === 'all'
              ? window.__crimesData
              : window.__crimesData.filter((c: any) => {
                  const y = new Date(c.date).getFullYear();
                  return selectedValue.split(',').map(Number).includes(y);
                });
            if (filtered.length > 0) {
              const newest = filtered.reduce((a: any, b: any) => new Date(a.date) > new Date(b.date) ? a : b);
              const d = new Date(newest.date);
              freshness.innerHTML = `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg> Data as of ${d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`;
            }
          }
        }
      });
    }

    // Start waiting for crimes data
    waitForCrimesData();

    // Initialize stat card filtering after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        initializeStatCardFiltering({
          updateQuickInsights,
          updateTopRegions,
          updateLeafletMap
        });
      });
    } else {
      initializeStatCardFiltering({
        updateQuickInsights,
        updateTopRegions,
        updateLeafletMap
      });
    }
  </script>

  <!-- Filters Tray Component -->
  <FiltersTray showYearFilter={true} showCrimeTypeFilter={true}>
    <!-- Region Filter (injected via slot) -->
    <div>
      <label for="regionFilter" class="block text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_85%)] mb-2">Region</label>
      <select
        id="regionFilter"
        class="filter-select w-full pl-4 pr-10 py-2.5 border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-500 dark:text-[hsl(0_0%_55%)] rounded-lg hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] transition font-medium text-xs bg-white/50 dark:bg-[hsl(0_0%_10%)]"
      >
        <option value="">All Regions</option>
        {dashboardRegions.map(region => (
          <option value={region}>{region}</option>
        ))}
      </select>
    </div>

    <!-- Area Filter â€” cascades based on region (injected via slot) -->
    <div>
      <label for="areaFilter" class="block text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_85%)] mb-2">Area</label>
      <select
        id="areaFilter"
        class="filter-select w-full pl-4 pr-10 py-2.5 border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-500 dark:text-[hsl(0_0%_55%)] rounded-lg hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] transition font-medium text-xs bg-white/50 dark:bg-[hsl(0_0%_10%)]"
      >
        <option value="">All Areas</option>
        {dashboardAreas.map(area => (
          <option value={area}>{area}</option>
        ))}
      </select>
    </div>
  </FiltersTray>

  <!-- Expose region/area data to window for the location filter script below -->
  <script is:inline define:vars={{ dashboardRegionToAreas, dashboardAllAreas: dashboardAreas, dashboardDefaultYear: String(currentYear) }}>
    window.__dashboardRegionToAreas = dashboardRegionToAreas;
    window.__dashboardAllAreas = dashboardAllAreas;
    window.__dashboardDefaultYear = dashboardDefaultYear;
  </script>

  <!-- Region / Area filter for dashboard (module script â€” can use imports) -->
  <script>
    import { updateStatsCards, updateQuickInsights, updateTopRegions } from '../../scripts/dashboardUpdates';
    import { updateLeafletMap } from '../../scripts/leafletMap';

    // Cascade: repopulate area dropdown when region changes
    function updateDashboardAreaOptions(selectedRegion: string) {
      const areaSelect = document.getElementById('areaFilter') as HTMLSelectElement | null;
      if (!areaSelect) return;
      const currentArea = areaSelect.value;
      areaSelect.innerHTML = '<option value="">All Areas</option>';
      const regionToAreas = (window as any).__dashboardRegionToAreas || {};
      const allAreas: string[] = (window as any).__dashboardAllAreas || [];
      const areasToShow: string[] = selectedRegion ? (regionToAreas[selectedRegion] || []) : allAreas;
      areasToShow.forEach(area => {
        const opt = document.createElement('option');
        opt.value = area;
        opt.textContent = area;
        if (area === currentArea && (!selectedRegion || (regionToAreas[selectedRegion] || []).includes(currentArea))) {
          opt.selected = true;
        }
        areaSelect.appendChild(opt);
      });
    }

    // Apply region + area filters on top of current year selection and fire all callbacks
    function applyDashboardLocationFilter() {
      if (!(window as any).__crimesData) return;

      const yearEl = document.getElementById('yearFilter') as HTMLSelectElement | null;
      const regionEl = document.getElementById('regionFilter') as HTMLSelectElement | null;
      const areaEl = document.getElementById('areaFilter') as HTMLSelectElement | null;
      if (!yearEl || !regionEl || !areaEl) return;

      const selectedYear = yearEl.value;
      const selectedRegion = regionEl.value;
      const selectedArea = areaEl.value;

      // Start from year-filtered base (same logic as yearFilter.ts)
      let crimes = selectedYear === 'all' || !selectedYear
        ? (window as any).__crimesData
        : (window as any).__crimesData.filter((c: any) => String(c.year) === selectedYear);

      // Apply region filter
      if (selectedRegion) crimes = crimes.filter((c: any) => c.region === selectedRegion);

      // Apply area filter
      if (selectedArea) crimes = crimes.filter((c: any) => c.area === selectedArea);

      // Fire all dashboard callbacks with shimmer transitions
      const statsShimmer = document.getElementById('statsShimmer');
      const statsContainer = document.querySelector('.stats-scroll-container') as HTMLElement | null;
      if (statsShimmer) { (statsShimmer as HTMLElement).style.opacity = '1'; (statsShimmer as HTMLElement).style.pointerEvents = ''; }
      if (statsContainer) statsContainer.style.opacity = '0';
      setTimeout(async () => {
        const t = Date.now();
        updateStatsCards(crimes, (window as any).__crimesData);
        await (window as any).hideShimmerWithMinTime(statsShimmer, statsContainer, t);
      }, 100);

      const insightsShimmer = document.getElementById('insightsShimmer');
      const insightsCards = document.getElementById('insightsCards') as HTMLElement | null;
      if (insightsShimmer) { (insightsShimmer as HTMLElement).style.opacity = '1'; (insightsShimmer as HTMLElement).style.pointerEvents = ''; }
      if (insightsCards) insightsCards.style.opacity = '0';
      setTimeout(async () => {
        const t = Date.now();
        updateQuickInsights(crimes);
        await (window as any).hideShimmerWithMinTime(insightsShimmer, insightsCards, t);
      }, 100);

      const topRegionsShimmer = document.getElementById('topRegionsShimmer');
      const topRegionsCard = document.getElementById('topRegionsCard') as HTMLElement | null;
      if (topRegionsShimmer) { (topRegionsShimmer as HTMLElement).style.opacity = '1'; (topRegionsShimmer as HTMLElement).style.pointerEvents = ''; }
      if (topRegionsCard) topRegionsCard.style.opacity = '0';
      setTimeout(async () => {
        const t = Date.now();
        updateTopRegions(crimes);
        await (window as any).hideShimmerWithMinTime(topRegionsShimmer, topRegionsCard, t);
      }, 100);

      const mapShimmer = document.getElementById('mapShimmer');
      const leafletMap = document.getElementById('leafletMap') as HTMLElement | null;
      if (mapShimmer) { (mapShimmer as HTMLElement).style.opacity = '1'; (mapShimmer as HTMLElement).style.pointerEvents = ''; }
      if (leafletMap) leafletMap.style.opacity = '0';
      setTimeout(async () => {
        const t = Date.now();
        updateLeafletMap(crimes, '/trinidad/crime/');
        await (window as any).hideShimmerWithMinTime(mapShimmer, leafletMap, t);
      }, 100);
    }

    // â”€â”€ Filter Active State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showDashboardFilterActive() {
      const btn = document.getElementById('filtersBtn') as HTMLElement | null;
      const text = document.getElementById('filtersBtnText');
      const clearBtn = document.getElementById('clearFiltersInline');
      if (text) text.textContent = 'Filters Active â€º';
      if (btn) {
        btn.style.borderColor = '#e11d48';
        btn.style.color = '#e11d48';
        btn.style.backgroundColor = 'color-mix(in srgb, #e11d48 10%, transparent)';
      }
      if (clearBtn) clearBtn.classList.remove('hidden');
    }

    function hideDashboardFilterActive() {
      const btn = document.getElementById('filtersBtn') as HTMLElement | null;
      const text = document.getElementById('filtersBtnText');
      const clearBtn = document.getElementById('clearFiltersInline');
      if (text) text.textContent = 'Filters â€º';
      if (btn) { btn.style.borderColor = ''; btn.style.color = ''; btn.style.backgroundColor = ''; }
      if (clearBtn) clearBtn.classList.add('hidden');
    }

    function checkDashboardFilterState() {
      const yearEl = document.getElementById('yearFilter') as HTMLSelectElement | null;
      const crimeTypeEl = document.getElementById('crimeTypeFilter') as HTMLSelectElement | null;
      const regionEl = document.getElementById('regionFilter') as HTMLSelectElement | null;
      const areaEl = document.getElementById('areaFilter') as HTMLSelectElement | null;
      const defaultYear = (window as any).__dashboardDefaultYear || '';
      const active =
        (yearEl ? (yearEl.value !== defaultYear && yearEl.value !== '') : false) ||
        (crimeTypeEl ? crimeTypeEl.value !== '' : false) ||
        (regionEl ? regionEl.value !== '' : false) ||
        (areaEl ? areaEl.value !== '' : false);
      if (active) showDashboardFilterActive(); else hideDashboardFilterActive();
    }

    function clearDashboardFilters() {
      const yearEl = document.getElementById('yearFilter') as HTMLSelectElement | null;
      const crimeTypeEl = document.getElementById('crimeTypeFilter') as HTMLSelectElement | null;
      const regionEl = document.getElementById('regionFilter') as HTMLSelectElement | null;
      const areaEl = document.getElementById('areaFilter') as HTMLSelectElement | null;
      const defaultYear = (window as any).__dashboardDefaultYear || '';
      if (yearEl && yearEl.value !== defaultYear) {
        yearEl.value = defaultYear;
        yearEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (crimeTypeEl && crimeTypeEl.value !== '') {
        crimeTypeEl.value = '';
        crimeTypeEl.dispatchEvent(new Event('change', { bubbles: true }));
      }
      if (regionEl) regionEl.value = '';
      if (areaEl) areaEl.value = '';
      updateDashboardAreaOptions('');
      applyDashboardLocationFilter();
      hideDashboardFilterActive();
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function waitForLocationFilterElements() {
      const regionEl = document.getElementById('regionFilter') as HTMLSelectElement | null;
      const areaEl = document.getElementById('areaFilter') as HTMLSelectElement | null;
      if (!regionEl || !areaEl) { setTimeout(waitForLocationFilterElements, 100); return; }

      regionEl.addEventListener('change', () => {
        updateDashboardAreaOptions(regionEl!.value);
        applyDashboardLocationFilter();
        checkDashboardFilterState();
      });
      areaEl.addEventListener('change', () => {
        applyDashboardLocationFilter();
        checkDashboardFilterState();
      });

      // Also track year and crime type filter changes for the active indicator
      const yearEl = document.getElementById('yearFilter') as HTMLSelectElement | null;
      const crimeTypeEl = document.getElementById('crimeTypeFilter') as HTMLSelectElement | null;
      if (yearEl) yearEl.addEventListener('change', checkDashboardFilterState);
      if (crimeTypeEl) crimeTypeEl.addEventListener('change', checkDashboardFilterState);

      // Wire the Clear button
      const clearBtn = document.getElementById('clearFiltersInline');
      if (clearBtn) clearBtn.addEventListener('click', clearDashboardFilters);

      // Check initial state (in case filters are pre-set)
      checkDashboardFilterState();
    }

    waitForLocationFilterElements();
  </script>

  <!-- Sync Stat Cards with Tray Checkboxes -->
  <script>
    import { initializeTraySync } from '../../scripts/statCardFiltering';

    // Initialize after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeTraySync);
    } else {
      initializeTraySync();
    }
  </script>

  <!-- Mouse Wheel Horizontal Scroll for Stats Cards -->
  <script>
    import { initializeStatsScroll } from '../../scripts/statsScroll';
    initializeStatsScroll();
  </script>
</Layout>
