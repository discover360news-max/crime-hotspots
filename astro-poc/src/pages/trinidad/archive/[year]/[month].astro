---
/**
 * Monthly Archive Page
 * Auto-generates archive pages for each month that has crimes
 * URL: /trinidad/archive/2025/12
 */

import Layout from '../../../../layouts/Layout.astro';
import { getTrinidadCrimes, type Crime } from '../../../../lib/crimeData';

export async function getStaticPaths() {
  const crimes = await getTrinidadCrimes();

  // Group crimes by year/month
  const monthsMap = new Map<string, Crime[]>();

  crimes.forEach(crime => {
    const key = `${crime.year}-${String(crime.month).padStart(2, '0')}`;
    if (!monthsMap.has(key)) {
      monthsMap.set(key, []);
    }
    monthsMap.get(key)!.push(crime);
  });

  // Generate paths
  return Array.from(monthsMap.entries()).map(([key, crimes]) => {
    const [year, month] = key.split('-');
    return {
      params: { year, month },
      props: { crimes, year: parseInt(year), month: parseInt(month) },
    };
  });
}

interface Props {
  crimes: Crime[];
  year: number;
  month: number;
}

const { crimes, year, month } = Astro.props;

const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long' });
const title = `${monthName} ${year} Crime Report | Trinidad & Tobago`;
const description = `Complete list of ${crimes.length} crimes reported in Trinidad & Tobago during ${monthName} ${year}. View details, statistics, and trends.`;

// Group by crime type for stats
const crimesByType = crimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

// Group by region for stats
const crimesByRegion = crimes.reduce((acc, crime) => {
  if (crime.region) {
    acc[crime.region] = (acc[crime.region] || 0) + 1;
  }
  return acc;
}, {} as Record<string, number>);

const topRegions = Object.entries(crimesByRegion)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);
---

<Layout title={title} description={description}>
  <!-- Breadcrumb Schema.org -->
  <script type="application/ld+json" slot="head">
    {
      JSON.stringify({
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "https://crimehotspots.com/"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "Trinidad Archives",
            "item": "https://crimehotspots.com/trinidad/archive"
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": `${monthName} ${year}`,
            "item": `https://crimehotspots.com/trinidad/archive/${year}/${String(month).padStart(2, '0')}`
          }
        ]
      })
    }
  </script>

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumbs -->
    <nav aria-label="Breadcrumb" class="mb-6">
      <ol class="flex items-center gap-2 text-xs text-slate-500">
        <li><a href="/" class="hover:text-rose-600 transition">Home</a></li>
        <li>/</li>
        <li><a href="/trinidad/archive" class="hover:text-rose-600 transition">Trinidad Archives</a></li>
        <li>/</li>
        <li class="text-rose-600 font-medium">{monthName} {year}</li>
      </ol>
    </nav>

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-display font-bold text-slate-700 mb-2">{monthName} {year} Crime Report</h1>
      <p class="text-body text-slate-500">Trinidad & Tobago</p>
    </div>

    <!-- Statistics Cards -->
    <section class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
      <div class="bg-white-100/50 rounded-lg shadow-sm border border-slate-200 p-6 text-center">
        <div class="text-display font-bold text-rose-600">{crimes.length}</div>
        <div class="text-xs text-slate-500 mt-2">Total Crimes</div>
      </div>

      <div class="bg-white-100/50 rounded-lg shadow-sm border border-slate-200 p-6 text-center">
        <div class="text-display font-bold text-rose-600">{Object.keys(crimesByType).length}</div>
        <div class="text-xs text-slate-500 mt-2">Crime Types</div>
      </div>

      <div class="bg-white-100/50 rounded-lg shadow-sm border border-slate-200 p-6 text-center">
        <div class="text-display font-bold text-rose-600">{Object.keys(crimesByRegion).length}</div>
        <div class="text-xs text-slate-500 mt-2">Regions Affected</div>
      </div>
    </section>

    <!-- Crime Breakdown -->
    <section class="mb-8">
      <h2 class="text-h2 font-bold text-slate-700 mb-4">Crime Breakdown</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white-100/50 rounded-lg shadow-sm border border-slate-200 p-6">
          <h3 class="text-h3 font-semibold text-slate-500 mb-4">By Type</h3>
          <ul class="space-y-2">
            {Object.entries(crimesByType)
              .sort(([, a], [, b]) => b - a)
              .map(([type, count]) => (
                <li class="flex justify-between items-center pb-2 border-b border-slate-200 last:border-0">
                  <a href={`/trinidad/archive`} class="text-xs text-rose-600 hover:text-rose-700 hover:underline">
                    {type}
                  </a>
                  <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white text-xs font-medium">
                    {count}
                  </span>
                </li>
              ))
            }
          </ul>
        </div>

        <div class="bg-white-100/50 rounded-lg shadow-sm border border-slate-200 p-6">
          <h3 class="text-h3 font-semibold text-slate-700 mb-4">Top 5 Regions</h3>
          <ul class="space-y-2">
            {topRegions.map(([region, count]) => (
              <li class="flex justify-between items-center pb-2 border-b border-slate-200 last:border-0">
                <a href={`/trinidad/archive`} class="text-xs text-rose-600 hover:text-rose-700 hover:underline">
                  {region}
                </a>
                <span class="px-3 py-1 min-h-[22px] flex items-center justify-center rounded-full bg-rose-600 text-white text-xs font-medium">
                  {count}
                </span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </section>

    <!-- Crime List -->
    <section>
      <h2 class="text-h2 font-bold text-slate-700 mb-4">All ({crimes.length}) Crime Headlines</h2>

      <div class="grid gap-8 sm:grid-cols-1 lg:grid-cols-2">
        {crimes.map(crime => (
          <a
            href={`/trinidad/crime/${crime.slug}`}
            class="bg-white/50 backdrop-blur-md rounded-lg shadow-md p-5 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 border-2 border-transparent hover:border-rose-200 group block"
          >
            <!-- Date and Crime Type -->
            <div class="flex justify-between items-center mb-3">
              <span class="text-xs text-slate-500">{crime.date}</span>
              <div class="flex items-center gap-1 bg-white/50 shadow-sm px-4 py-2 rounded-full text-xs font-semibold text-rose-600 uppercase">
                {crime.crimeType}
              </div>
            </div>

            <!-- Headline -->
            <h3 class="mb-4 text-small text-slate-900 line-clamp-2 font-bold">
              {crime.headline}
            </h3>

            <!-- Street Address -->
            {crime.street && (
              <p class="text-xs text-slate-500 mb-2"><strong>Location:</strong> {crime.street}</p>
            )}

            <!-- Area -->
            <div class="flex items-center gap-1 text-xs text-rose-600">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              {crime.area}
            </div>

            <!-- Read hint (appears on hover) -->
            <div class="mt-3 pt-3 border-t border-slate-100 text-xs text-rose-600 font-medium flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <span>View Details</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Navigation -->
    <nav class="flex flex-wrap justify-between items-center gap-4 mt-8 pt-8 border-t border-slate-200">
      <a
        href={`/trinidad/archive/${month === 1 ? year - 1 : year}/${month === 1 ? '12' : String(month - 1).padStart(2, '0')}`}
        class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg border-2 border-rose-600 text-rose-600 hover:bg-rose-50 transition text-nav font-medium"
      >
        ← Previous Month
      </a>
      <a
        href="/trinidad/archive"
        class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg border-2 border-slate-300 text-slate-700 hover:border-rose-600 hover:text-rose-600 transition text-nav font-medium"
      >
        All Archives
      </a>
      <a
        href={`/trinidad/archive/${month === 12 ? year + 1 : year}/${month === 12 ? '01' : String(month + 1).padStart(2, '0')}`}
        class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg border-2 border-rose-600 text-rose-600 hover:bg-rose-50 transition text-nav font-medium"
      >
        Next Month →
      </a>
    </nav>
  </div>
</Layout>
