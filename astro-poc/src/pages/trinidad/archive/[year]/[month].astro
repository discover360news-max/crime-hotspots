---
/**
 * Monthly Archive Page - Redesigned with Dashboard-Style Insights
 * Auto-generates archive pages for each month that has crimes
 * URL: /trinidad/archive/2025/12
 */

// Keep archive pages static (pre-rendered at build time)
export const prerender = true;

import Layout from '../../../../layouts/Layout.astro';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import SiteNotificationBanner from '../../../../components/SiteNotificationBanner.astro';
import QuickInsightsCard from '../../../../components/QuickInsightsCard.astro';
import CrimeDetailModal from '../../../../components/CrimeDetailModal.astro';
import CrimeCard from '../../../../components/CrimeCard.astro';
import AreaNameTooltip from '../../../../components/AreaNameTooltip.astro';
import { getTrinidadCrimes, type Crime } from '../../../../lib/crimeData';
import { dataUpdateNotice } from '../../../../config/siteNotifications';
import { loadAreaAliases, getLocalName } from '../../../../lib/areaAliases';
import { getCountryName } from '../../../../data/countries';
import { routes, buildRoute } from '../../../../config/routes';
import { usesVictimCount } from '../../../../config/crimeTypeConfig';

export async function getStaticPaths() {
  const crimes = await getTrinidadCrimes();

  // Group crimes by year/month
  const monthsMap = new Map<string, Crime[]>();

  crimes.forEach(crime => {
    const key = `${crime.year}-${String(crime.month).padStart(2, '0')}`;
    if (!monthsMap.has(key)) {
      monthsMap.set(key, []);
    }
    monthsMap.get(key)!.push(crime);
  });

  // Generate paths with all crimes for comparisons
  return Array.from(monthsMap.entries()).map(([key, monthCrimes]) => {
    const [year, month] = key.split('-');
    return {
      params: { year, month },
      props: {
        crimes: monthCrimes,
        allCrimes: crimes, // Need all crimes for comparisons
        year: parseInt(year),
        month: parseInt(month)
      },
    };
  });
}

interface Props {
  crimes: Crime[];
  allCrimes: Crime[];
  year: number;
  month: number;
}

const { crimes, allCrimes, year, month } = Astro.props;

// Load area aliases for tooltips
const areaAliases = await loadAreaAliases();

const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long' });
const title = `${monthName} ${year} Crime Archive | Trinidad & Tobago`;
const description = `${crimes.length} crimes reported in Trinidad & Tobago during ${monthName} ${year}. Month-over-month trends, year-over-year comparisons, and detailed statistics.`;

// Group by crime type
const crimesByType = crimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const topCrimeTypes = Object.entries(crimesByType)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

// Get previous month's data for comparison
const prevMonth = month === 1 ? 12 : month - 1;
const prevYear = month === 1 ? year - 1 : year;
const prevMonthCrimes = allCrimes.filter(c => c.year === prevYear && c.month === prevMonth);

// Get same month from previous year
const lastYearCrimes = allCrimes.filter(c => c.year === year - 1 && c.month === month);

// Calculate month-over-month change
const momChange = crimes.length - prevMonthCrimes.length;
const momPercent = prevMonthCrimes.length > 0
  ? Math.round((momChange / prevMonthCrimes.length) * 100)
  : 0;

// Calculate year-over-year change
const yoyChange = crimes.length - lastYearCrimes.length;
const yoyPercent = lastYearCrimes.length > 0
  ? Math.round((yoyChange / lastYearCrimes.length) * 100)
  : 0;

// Find deadliest day
const crimesByDay = crimes.reduce((acc, crime) => {
  const day = new Date(crime.date).getDate();
  acc[day] = (acc[day] || 0) + 1;
  return acc;
}, {} as Record<number, number>);

const deadliestDay = Object.entries(crimesByDay)
  .sort(([, a], [, b]) => b - a)[0];

// Calculate top trending crime type (biggest increase from prev month)
const prevMonthByType = prevMonthCrimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const trendingCrime = Object.entries(crimesByType)
  .map(([type, count]) => {
    const prevCount = prevMonthByType[type] || 0;
    const change = count - prevCount;
    const percent = prevCount > 0 ? ((change / prevCount) * 100) : 0;
    return { type, count, change, percent };
  })
  .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))[0];

// Calculate insights for QuickInsightsCard component
const daysInMonth = new Date(year, month, 0).getDate();
const avgPerDay = (crimes.length / daysInMonth).toFixed(1);

// Calculate total victims (respecting victimCount for configured crime types)
const totalVictims = crimes.reduce((sum, crime) => {
  const primaryType = crime.primaryCrimeType || crime.crimeType;
  if (primaryType && usesVictimCount(primaryType)) {
    return sum + (crime.victimCount || 1);
  }
  return sum + 1;
}, 0);
const victimsPerDay = Math.round(totalVictims / daysInMonth);

// Most dangerous day of week
const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const dayOfWeekCount = new Map<string, number>();
crimes.forEach(crime => {
  const date = new Date(crime.date);
  const dayName = dayNames[date.getDay()];
  dayOfWeekCount.set(dayName, (dayOfWeekCount.get(dayName) || 0) + 1);
});
const mostDangerousDay = Array.from(dayOfWeekCount.entries())
  .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

// Deadliest day of the month (actual date with most crimes)
const busiestMonth = deadliestDay
  ? `${monthName} ${deadliestDay[0]}`
  : 'N/A';

// Area stats
const areaCount = new Map<string, number>();
crimes.forEach(crime => {
  const area = crime.area || 'Unknown';
  areaCount.set(area, (areaCount.get(area) || 0) + 1);
});
const areaArray = Array.from(areaCount.entries()).sort((a, b) => b[1] - a[1]);

// Top 3 areas concentration
const top3Count = areaArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
const top3Percentage = crimes.length > 0 ? ((top3Count / crimes.length) * 100).toFixed(0) : '0';

// Most dangerous and safest regions
const validAreas = areaArray.filter(([area]) => area && area !== 'Unknown' && area.trim() !== '');
const mostDangerousRegion = validAreas[0]?.[0] || 'N/A';
const mostDangerousRegionCount = validAreas[0]?.[1] || 0;
const safestRegion = validAreas[validAreas.length - 1]?.[0] || 'N/A';
const safestRegionCount = validAreas[validAreas.length - 1]?.[1] || 0;

const insights = {
  avgPerDay,
  victimsPerDay,
  mostDangerousDay,
  busiestMonth,
  top3Percentage,
  mostDangerousRegion,
  mostDangerousRegionCount,
  safestRegion,
  safestRegionCount
};

// Group crimes by date for accordion display
const crimesByDate = new Map<string, Crime[]>();
crimes.forEach(crime => {
  const dateKey = crime.date;
  if (!crimesByDate.has(dateKey)) {
    crimesByDate.set(dateKey, []);
  }
  crimesByDate.get(dateKey)!.push(crime);
});

// Sort dates descending (most recent first)
const sortedDates = Array.from(crimesByDate.keys()).sort((a, b) =>
  new Date(b).getTime() - new Date(a).getTime()
);

// Helper to calculate victim count for a group
function calculateVictimCount(groupCrimes: Crime[]): number {
  return groupCrimes.reduce((total, crime) => {
    const vc = crime.victimCount && crime.victimCount > 0 ? crime.victimCount : 1;
    return total + vc;
  }, 0);
}

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', href: routes.home },
  { label: getCountryName('tt'), href: routes.trinidad.dashboard },
  { label: 'Archive', href: routes.trinidad.archive },
  { label: String(year), href: routes.trinidad.archive },
  { label: monthName }
];
---

<Layout title={title} description={description} includeTurnstile={true}>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5" data-pagefind-ignore>
    <!-- Breadcrumbs -->
    <Breadcrumbs items={breadcrumbs} />

    <!-- Navigation Buttons -->
    <div class="flex gap-2 mb-6">
      <a
        href={routes.trinidad.dashboard}
        class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs whitespace-nowrap"
      >
        Dashboard
      </a>
      <a
        href={routes.trinidad.headlines}
        class="px-4 py-1.5 min-h-[22px] flex items-center justify-center border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs whitespace-nowrap"
      >
        Headlines
      </a>
    </div>

    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-display font-bold text-slate-700 mb-2">{monthName} {year} Archive</h1>
      <p class="text-body text-slate-500">{crimes.length} crimes reported in Trinidad & Tobago</p>
    </div>

    <!-- Site Notification Banner -->
    <SiteNotificationBanner notification={dataUpdateNotice} />

    <!-- Horizontal Scroll Stats Cards (Dashboard Style) -->
    <div class="relative mb-8">
      <div class="flex items-center gap-4 overflow-x-auto pb-4 snap-x snap-mandatory hide-scrollbar">
        <!-- Total Crimes Card -->
        <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
          <div class="text-xs font-semibold text-slate-500 mb-2">Total Crimes</div>
          <div class="text-display font-bold text-slate-700">{crimes.length}</div>
          {prevMonthCrimes.length > 0 && (
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={momChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {momChange >= 0 ? '↑' : '↓'} {Math.abs(momChange)} ({Math.abs(momPercent)}%)
              </span>
              <span>vs prev month</span>
            </div>
          )}
        </div>

        <!-- Year-over-Year Card -->
        {lastYearCrimes.length > 0 && (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">vs {monthName} {year - 1}</div>
            <div class="text-display font-bold text-slate-700">{lastYearCrimes.length}</div>
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={yoyChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {yoyChange >= 0 ? '↑' : '↓'} {Math.abs(yoyChange)} ({Math.abs(yoyPercent)}%)
              </span>
              <span>year-over-year</span>
            </div>
          </div>
        )}

        <!-- Top Crime Types (scrollable cards) -->
        {topCrimeTypes.map(([type, count]) => (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">{type}</div>
            <div class="text-display font-bold text-slate-700">{count}</div>
            {prevMonthByType[type] && (
              <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                {(() => {
                  const prevCount = prevMonthByType[type] || 0;
                  const change = count - prevCount;
                  const percent = prevCount > 0 ? Math.round((change / prevCount) * 100) : 0;
                  return (
                    <span class={change >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                      {change >= 0 ? '↑' : '↓'} {Math.abs(change)} ({Math.abs(percent)}%)
                    </span>
                  );
                })()}
                <span>vs prev month</span>
              </div>
            )}
          </div>
        ))}
      </div>

      <!-- Scroll Hint (right side) -->
      <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-slate-100 via-slate-100/90 to-transparent pointer-events-none flex items-center justify-end pr-2">
        <svg class="w-4 h-4 text-rose-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- Quick Insights Section -->
    <div class="mb-8">
      <QuickInsightsCard insights={insights} busiestLabel="Deadliest Day" />
    </div>

    <!-- Crime Headlines by Date -->
    <section>
      <h2 class="text-heading font-bold text-slate-700 mb-4">All Headlines ({crimes.length})</h2>

      <div id="crimeAccordions">
        {sortedDates.map((date, index) => {
          const dateCrimes = crimesByDate.get(date)!;
          const incidentCount = dateCrimes.length;
          const victimCount = calculateVictimCount(dateCrimes);
          const isExpanded = index === 0;
          const formattedDate = new Date(date).toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric',
            year: 'numeric'
          });

          return (
            <div class="date-accordion mb-4" data-date={date}>
              <button
                class={`accordion-header w-full px-4 py-3 bg-white/70 backdrop-blur-md rounded-lg hover:bg-white/90 transition flex items-center justify-between group ${isExpanded ? 'border border-rose-600' : 'border border-slate-200'}`}
                aria-expanded={isExpanded}
              >
                <div class="flex items-center gap-3">
                  <svg
                    class={`chevron w-5 h-5 text-slate-400 transition-transform duration-200 ${isExpanded ? 'rotate-90' : ''}`}
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>

                  <div class="text-left">
                    <h3 class={`accordion-title text-small font-semibold ${isExpanded ? 'text-rose-600' : 'text-slate-700'}`}>{formattedDate}</h3>
                    <p class="text-xs text-slate-500">{incidentCount} {incidentCount === 1 ? 'incident' : 'incidents'} affecting {victimCount} {victimCount === 1 ? 'victim' : 'victims'}</p>
                  </div>
                </div>

                <span class="px-3 py-1 rounded-full bg-rose-100 text-rose-600 text-xs font-medium">
                  {incidentCount}
                </span>
              </button>

              <div class={`accordion-content overflow-hidden transition-all duration-300 ${isExpanded ? 'max-h-[10000px] mt-3' : 'max-h-0'}`}>
                <!-- Mobile Timeline View -->
                <div class="relative pl-8 pb-4 sm:hidden">
                  <div class="absolute left-3 top-0 bottom-4 w-px border-l-2 border-dotted border-slate-300"></div>
                  <div class="space-y-4">
                    {dateCrimes.map(crime => (
                      <div class="relative">
                        <div class="absolute -left-[23px] top-4 w-1.5 h-1.5 rounded-full bg-rose-600"></div>
                        <CrimeCard crime={crime} localName={getLocalName(areaAliases, crime.area)} />
                      </div>
                    ))}
                  </div>
                </div>

                <!-- Desktop Grid View -->
                <div class="hidden sm:grid gap-4 sm:grid-cols-2 lg:grid-cols-3 pb-4">
                  {dateCrimes.map(crime => (
                    <CrimeCard crime={crime} localName={getLocalName(areaAliases, crime.area)} />
                  ))}
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </section>
  </main>

  <!-- Crime Detail Modal -->
  <CrimeDetailModal />
</Layout>

<script define:vars={{ crimes }}>
  // Expose crimes data globally for modal safety context
  window.__crimesData = crimes;

  document.addEventListener('DOMContentLoaded', () => {
    // Accordion toggle listeners
    const headers = document.querySelectorAll('.accordion-header');
    headers.forEach(header => {
      header.addEventListener('click', () => {
        const accordion = header.closest('.date-accordion');
        const content = accordion?.querySelector('.accordion-content');
        const chevron = header.querySelector('.chevron');
        const title = header.querySelector('.accordion-title');
        const isExpanded = header.getAttribute('aria-expanded') === 'true';

        if (content && chevron && title) {
          if (isExpanded) {
            header.setAttribute('aria-expanded', 'false');
            content.classList.remove('max-h-[10000px]', 'mt-3');
            content.classList.add('max-h-0');
            chevron.classList.remove('rotate-90');
            header.classList.remove('border-rose-600');
            header.classList.add('border-slate-200');
            title.classList.remove('text-rose-600');
            title.classList.add('text-slate-700');
          } else {
            header.setAttribute('aria-expanded', 'true');
            content.classList.add('max-h-[10000px]', 'mt-3');
            content.classList.remove('max-h-0');
            chevron.classList.add('rotate-90');
            header.classList.remove('border-slate-200');
            header.classList.add('border-rose-600');
            title.classList.remove('text-slate-700');
            title.classList.add('text-rose-600');
          }
        }
      });
    });

    // Event delegation for crime card clicks
    const container = document.getElementById('crimeAccordions');
    if (container) {
      container.addEventListener('click', (e) => {
        if (e.target.closest('a')) return;
        if (e.target.closest('.accordion-header')) return;

        const card = e.target.closest('.crime-card');
        if (card) {
          const slug = card.dataset.crimeSlug;
          const crime = crimes.find(c => c.slug === slug);
          if (crime && window.openCrimeModal) {
            window.openCrimeModal(crime);
          }
        }
      });
    }
  });
</script>

<style>
  /* Hide scrollbar on touch devices, show on desktop */
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }

  /* Show styled scrollbar on devices with hover (desktop) */
  @media (hover: hover) {
    .hide-scrollbar {
      -ms-overflow-style: auto;
      scrollbar-width: thin;
      scrollbar-color: #fda4af transparent;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: block;
      height: 6px;
    }
    .hide-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }
    .hide-scrollbar::-webkit-scrollbar-thumb {
      background-color: #fda4af;
      border-radius: 3px;
    }
    .hide-scrollbar::-webkit-scrollbar-thumb:hover {
      background-color: #fb7185;
    }
  }
</style>
