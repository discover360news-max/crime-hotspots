---
/**
 * Monthly Archive Page - Redesigned with Dashboard-Style Insights
 * Auto-generates archive pages for each month that has crimes
 * URL: /trinidad/archive/2025/12
 */

import Layout from '../../../../layouts/Layout.astro';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import SiteNotificationBanner from '../../../../components/SiteNotificationBanner.astro';
import QuickInsightsCard from '../../../../components/QuickInsightsCard.astro';
import CrimeDetailModal from '../../../../components/CrimeDetailModal.astro';
import { getTrinidadCrimes, type Crime } from '../../../../lib/crimeData';
import { dataUpdateNotice } from '../../../../config/siteNotifications';

export async function getStaticPaths() {
  const crimes = await getTrinidadCrimes();

  // Group crimes by year/month
  const monthsMap = new Map<string, Crime[]>();

  crimes.forEach(crime => {
    const key = `${crime.year}-${String(crime.month).padStart(2, '0')}`;
    if (!monthsMap.has(key)) {
      monthsMap.set(key, []);
    }
    monthsMap.get(key)!.push(crime);
  });

  // Generate paths with all crimes for comparisons
  return Array.from(monthsMap.entries()).map(([key, monthCrimes]) => {
    const [year, month] = key.split('-');
    return {
      params: { year, month },
      props: {
        crimes: monthCrimes,
        allCrimes: crimes, // Need all crimes for comparisons
        year: parseInt(year),
        month: parseInt(month)
      },
    };
  });
}

interface Props {
  crimes: Crime[];
  allCrimes: Crime[];
  year: number;
  month: number;
}

const { crimes, allCrimes, year, month } = Astro.props;

const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long' });
const title = `${monthName} ${year} Crime Archive | Trinidad & Tobago`;
const description = `${crimes.length} crimes reported in Trinidad & Tobago during ${monthName} ${year}. Month-over-month trends, year-over-year comparisons, and detailed statistics.`;

// Group by crime type
const crimesByType = crimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const topCrimeTypes = Object.entries(crimesByType)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

// Get previous month's data for comparison
const prevMonth = month === 1 ? 12 : month - 1;
const prevYear = month === 1 ? year - 1 : year;
const prevMonthCrimes = allCrimes.filter(c => c.year === prevYear && c.month === prevMonth);

// Get same month from previous year
const lastYearCrimes = allCrimes.filter(c => c.year === year - 1 && c.month === month);

// Calculate month-over-month change
const momChange = crimes.length - prevMonthCrimes.length;
const momPercent = prevMonthCrimes.length > 0
  ? Math.round((momChange / prevMonthCrimes.length) * 100)
  : 0;

// Calculate year-over-year change
const yoyChange = crimes.length - lastYearCrimes.length;
const yoyPercent = lastYearCrimes.length > 0
  ? Math.round((yoyChange / lastYearCrimes.length) * 100)
  : 0;

// Find deadliest day
const crimesByDay = crimes.reduce((acc, crime) => {
  const day = new Date(crime.date).getDate();
  acc[day] = (acc[day] || 0) + 1;
  return acc;
}, {} as Record<number, number>);

const deadliestDay = Object.entries(crimesByDay)
  .sort(([, a], [, b]) => b - a)[0];

// Calculate top trending crime type (biggest increase from prev month)
const prevMonthByType = prevMonthCrimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const trendingCrime = Object.entries(crimesByType)
  .map(([type, count]) => {
    const prevCount = prevMonthByType[type] || 0;
    const change = count - prevCount;
    const percent = prevCount > 0 ? ((change / prevCount) * 100) : 0;
    return { type, count, change, percent };
  })
  .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))[0];

// Calculate insights for QuickInsightsCard component
const daysInMonth = new Date(year, month, 0).getDate();
const avgPerDay = (crimes.length / daysInMonth).toFixed(1);

// Most dangerous day of week
const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const dayOfWeekCount = new Map<string, number>();
crimes.forEach(crime => {
  const date = new Date(crime.date);
  const dayName = dayNames[date.getDay()];
  dayOfWeekCount.set(dayName, (dayOfWeekCount.get(dayName) || 0) + 1);
});
const mostDangerousDay = Array.from(dayOfWeekCount.entries())
  .sort((a, b) => b[1] - a[1])[0]?.[0] || 'N/A';

// Deadliest day of the month (actual date with most crimes)
const busiestMonth = deadliestDay
  ? `${monthName} ${deadliestDay[0]}`
  : 'N/A';

// Area stats
const areaCount = new Map<string, number>();
crimes.forEach(crime => {
  const area = crime.area || 'Unknown';
  areaCount.set(area, (areaCount.get(area) || 0) + 1);
});
const areaArray = Array.from(areaCount.entries()).sort((a, b) => b[1] - a[1]);

// Top 3 areas concentration
const top3Count = areaArray.slice(0, 3).reduce((sum, [_, count]) => sum + count, 0);
const top3Percentage = crimes.length > 0 ? ((top3Count / crimes.length) * 100).toFixed(0) : '0';

// Most dangerous and safest regions
const validAreas = areaArray.filter(([area]) => area && area !== 'Unknown' && area.trim() !== '');
const mostDangerousRegion = validAreas[0]?.[0] || 'N/A';
const mostDangerousRegionCount = validAreas[0]?.[1] || 0;
const safestRegion = validAreas[validAreas.length - 1]?.[0] || 'N/A';
const safestRegionCount = validAreas[validAreas.length - 1]?.[1] || 0;

const insights = {
  avgPerDay,
  mostDangerousDay,
  busiestMonth,
  top3Percentage,
  mostDangerousRegion,
  mostDangerousRegionCount,
  safestRegion,
  safestRegionCount
};

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Trinidad & Tobago', href: '/trinidad/dashboard' },
  { label: 'Archives', href: '/trinidad/archive' },
  { label: `${monthName} ${year}` }
];
---

<Layout title={title} description={description}>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5" data-pagefind-ignore>
    <!-- Breadcrumbs -->
    <Breadcrumbs items={breadcrumbs} />

    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-h1 font-bold text-slate-700 mb-2">{monthName} {year} Archive</h1>
      <p class="text-body text-slate-500">{crimes.length} crimes reported in Trinidad & Tobago</p>
    </div>

    <!-- Site Notification Banner -->
    <SiteNotificationBanner notification={dataUpdateNotice} />

    <!-- Horizontal Scroll Stats Cards (Dashboard Style) -->
    <div class="relative mb-8">
      <div class="flex items-center gap-4 overflow-x-auto pb-4 snap-x snap-mandatory hide-scrollbar">
        <!-- Total Crimes Card -->
        <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
          <div class="text-xs font-semibold text-slate-500 mb-2">Total Crimes</div>
          <div class="text-display font-bold text-slate-700">{crimes.length}</div>
          {prevMonthCrimes.length > 0 && (
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={momChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {momChange >= 0 ? '↑' : '↓'} {Math.abs(momChange)} ({Math.abs(momPercent)}%)
              </span>
              <span>vs prev month</span>
            </div>
          )}
        </div>

        <!-- Year-over-Year Card -->
        {lastYearCrimes.length > 0 && (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">vs {monthName} {year - 1}</div>
            <div class="text-display font-bold text-slate-700">{lastYearCrimes.length}</div>
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={yoyChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {yoyChange >= 0 ? '↑' : '↓'} {Math.abs(yoyChange)} ({Math.abs(yoyPercent)}%)
              </span>
              <span>year-over-year</span>
            </div>
          </div>
        )}

        <!-- Top Crime Types (scrollable cards) -->
        {topCrimeTypes.map(([type, count]) => (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">{type}</div>
            <div class="text-display font-bold text-slate-700">{count}</div>
            {prevMonthByType[type] && (
              <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                {(() => {
                  const prevCount = prevMonthByType[type] || 0;
                  const change = count - prevCount;
                  const percent = prevCount > 0 ? Math.round((change / prevCount) * 100) : 0;
                  return (
                    <span class={change >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                      {change >= 0 ? '↑' : '↓'} {Math.abs(change)} ({Math.abs(percent)}%)
                    </span>
                  );
                })()}
                <span>vs prev month</span>
              </div>
            )}
          </div>
        ))}
      </div>

      <!-- Scroll Hint (right side) -->
      <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-slate-100 via-slate-100/90 to-transparent pointer-events-none flex items-center justify-end pr-2">
        <svg class="w-4 h-4 text-rose-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- Quick Insights Section -->
    <div class="mb-8">
      <QuickInsightsCard insights={insights} busiestLabel="Deadliest Day" />
    </div>

    <!-- Crime Headlines List -->
    <section>
      <h2 class="text-h2 font-bold text-slate-700 mb-4">All Headlines ({crimes.length})</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {crimes.map(crime => {
          const formattedDate = new Date(crime.date).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });

          return (
            <article class="crime-card bg-white/70 backdrop-blur-md rounded-xl shadow-md border border-slate-100 p-4 hover:shadow-lg transition cursor-pointer" data-crime-slug={crime.slug}>
              <div class="flex items-start justify-between mb-3">
                <span class="inline-block px-3 py-1 rounded-full bg-rose-600 text-white text-xs font-medium">
                  {crime.crimeType}
                </span>
                <span class="text-xs text-slate-500">
                  {formattedDate}
                </span>
              </div>

              <h3 class="text-small font-semibold text-slate-700 mb-2">
                {crime.headline}
              </h3>

              {crime.area && (
                <p class="text-xs text-slate-500 mb-3 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  {crime.area}
                </p>
              )}

              <div class="flex items-center justify-between pt-3 border-t border-slate-200">
                <a href={`/trinidad/crime/${crime.slug}`} class="text-xs text-rose-600 hover:text-rose-700 font-medium flex items-center gap-1">
                  View Details
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                  </svg>
                </a>

                <a href={crime.url} target="_blank" rel="noopener noreferrer" class="text-xs text-slate-500 hover:text-slate-700 flex items-center gap-1" title="Read original article">
                  <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                </a>
              </div>
            </article>
          );
        })}
      </div>
    </section>
  </main>

  <!-- Crime Detail Modal -->
  <CrimeDetailModal />
</Layout>

<script define:vars={{ crimes }}>
  // Event delegation for crime card clicks
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.querySelector('section');
    if (container) {
      container.addEventListener('click', (e) => {
        // Don't open modal if clicking on a link
        if (e.target.closest('a')) {
          return;
        }

        const card = e.target.closest('.crime-card');
        if (card) {
          const slug = card.dataset.crimeSlug;
          const crime = crimes.find(c => c.slug === slug);
          if (crime && window.openCrimeModal) {
            window.openCrimeModal(crime);
          }
        }
      });
    }
  });
</script>

<style>
  /* Hide scrollbar but keep functionality */
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
</style>
