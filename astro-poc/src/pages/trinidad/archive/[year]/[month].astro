---
/**
 * Monthly Archive Page - Redesigned with Dashboard-Style Insights
 * Auto-generates archive pages for each month that has crimes
 * URL: /trinidad/archive/2025/12
 */

import Layout from '../../../../layouts/Layout.astro';
import Breadcrumbs from '../../../../components/Breadcrumbs.astro';
import { getTrinidadCrimes, type Crime } from '../../../../lib/crimeData';

export async function getStaticPaths() {
  const crimes = await getTrinidadCrimes();

  // Group crimes by year/month
  const monthsMap = new Map<string, Crime[]>();

  crimes.forEach(crime => {
    const key = `${crime.year}-${String(crime.month).padStart(2, '0')}`;
    if (!monthsMap.has(key)) {
      monthsMap.set(key, []);
    }
    monthsMap.get(key)!.push(crime);
  });

  // Generate paths with all crimes for comparisons
  return Array.from(monthsMap.entries()).map(([key, monthCrimes]) => {
    const [year, month] = key.split('-');
    return {
      params: { year, month },
      props: {
        crimes: monthCrimes,
        allCrimes: crimes, // Need all crimes for comparisons
        year: parseInt(year),
        month: parseInt(month)
      },
    };
  });
}

interface Props {
  crimes: Crime[];
  allCrimes: Crime[];
  year: number;
  month: number;
}

const { crimes, allCrimes, year, month } = Astro.props;

const monthName = new Date(year, month - 1).toLocaleDateString('en-US', { month: 'long' });
const title = `${monthName} ${year} Crime Archive | Trinidad & Tobago`;
const description = `${crimes.length} crimes reported in Trinidad & Tobago during ${monthName} ${year}. Month-over-month trends, year-over-year comparisons, and detailed statistics.`;

// Group by crime type
const crimesByType = crimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const topCrimeTypes = Object.entries(crimesByType)
  .sort(([, a], [, b]) => b - a)
  .slice(0, 5);

// Get previous month's data for comparison
const prevMonth = month === 1 ? 12 : month - 1;
const prevYear = month === 1 ? year - 1 : year;
const prevMonthCrimes = allCrimes.filter(c => c.year === prevYear && c.month === prevMonth);

// Get same month from previous year
const lastYearCrimes = allCrimes.filter(c => c.year === year - 1 && c.month === month);

// Calculate month-over-month change
const momChange = crimes.length - prevMonthCrimes.length;
const momPercent = prevMonthCrimes.length > 0
  ? Math.round((momChange / prevMonthCrimes.length) * 100)
  : 0;

// Calculate year-over-year change
const yoyChange = crimes.length - lastYearCrimes.length;
const yoyPercent = lastYearCrimes.length > 0
  ? Math.round((yoyChange / lastYearCrimes.length) * 100)
  : 0;

// Find deadliest day
const crimesByDay = crimes.reduce((acc, crime) => {
  const day = new Date(crime.date).getDate();
  acc[day] = (acc[day] || 0) + 1;
  return acc;
}, {} as Record<number, number>);

const deadliestDay = Object.entries(crimesByDay)
  .sort(([, a], [, b]) => b - a)[0];

// Calculate top trending crime type (biggest increase from prev month)
const prevMonthByType = prevMonthCrimes.reduce((acc, crime) => {
  acc[crime.crimeType] = (acc[crime.crimeType] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const trendingCrime = Object.entries(crimesByType)
  .map(([type, count]) => {
    const prevCount = prevMonthByType[type] || 0;
    const change = count - prevCount;
    const percent = prevCount > 0 ? ((change / prevCount) * 100) : 0;
    return { type, count, change, percent };
  })
  .sort((a, b) => Math.abs(b.change) - Math.abs(a.change))[0];

// Breadcrumbs
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Trinidad & Tobago', href: '/trinidad/dashboard' },
  { label: 'Archives', href: '/trinidad/archive' },
  { label: `${monthName} ${year}` }
];
---

<Layout title={title} description={description}>
  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-5">
    <!-- Breadcrumbs -->
    <Breadcrumbs items={breadcrumbs} />

    <!-- Page Header -->
    <div class="mb-6">
      <h1 class="text-h1 font-bold text-slate-700 mb-2">{monthName} {year} Archive</h1>
      <p class="text-body text-slate-500">{crimes.length} crimes reported in Trinidad & Tobago</p>
    </div>

    <!-- Horizontal Scroll Stats Cards (Dashboard Style) -->
    <div class="relative mb-8">
      <div class="flex items-center gap-4 overflow-x-auto pb-4 snap-x snap-mandatory hide-scrollbar">
        <!-- Total Crimes Card -->
        <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
          <div class="text-xs font-semibold text-slate-500 mb-2">Total Crimes</div>
          <div class="text-display font-bold text-slate-700">{crimes.length}</div>
          {prevMonthCrimes.length > 0 && (
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={momChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {momChange >= 0 ? '↑' : '↓'} {Math.abs(momChange)} ({Math.abs(momPercent)}%)
              </span>
              <span>vs prev month</span>
            </div>
          )}
        </div>

        <!-- Year-over-Year Card -->
        {lastYearCrimes.length > 0 && (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">vs {monthName} {year - 1}</div>
            <div class="text-display font-bold text-slate-700">{lastYearCrimes.length}</div>
            <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
              <span class={yoyChange >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                {yoyChange >= 0 ? '↑' : '↓'} {Math.abs(yoyChange)} ({Math.abs(yoyPercent)}%)
              </span>
              <span>year-over-year</span>
            </div>
          </div>
        )}

        <!-- Top Crime Types (scrollable cards) -->
        {topCrimeTypes.map(([type, count]) => (
          <div class="flex-shrink-0 snap-start bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 w-64">
            <div class="text-xs font-semibold text-slate-500 mb-2">{type}</div>
            <div class="text-display font-bold text-slate-700">{count}</div>
            {prevMonthByType[type] && (
              <div class="text-xs text-slate-500 mt-2 flex items-center gap-1">
                {(() => {
                  const prevCount = prevMonthByType[type] || 0;
                  const change = count - prevCount;
                  const percent = prevCount > 0 ? Math.round((change / prevCount) * 100) : 0;
                  return (
                    <span class={change >= 0 ? 'text-red-600' : 'text-emerald-600'}>
                      {change >= 0 ? '↑' : '↓'} {Math.abs(change)} ({Math.abs(percent)}%)
                    </span>
                  );
                })()}
                <span>vs prev month</span>
              </div>
            )}
          </div>
        ))}
      </div>

      <!-- Scroll Hint (right side) -->
      <div class="absolute right-0 top-0 bottom-0 w-16 bg-gradient-to-l from-slate-100 via-slate-100/90 to-transparent pointer-events-none flex items-center justify-end pr-2">
        <svg class="w-4 h-4 text-rose-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </div>
    </div>

    <!-- Quick Insights Section -->
    <div class="bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-6 mb-8">
      <h2 class="text-h2 font-bold text-slate-700 mb-4">Quick Insights</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Deadliest Day -->
        {deadliestDay && (
          <div class="text-center">
            <div class="text-display font-bold text-rose-600 mb-1">
              {monthName} {deadliestDay[0]}
            </div>
            <div class="text-small text-slate-700 font-medium mb-1">Deadliest Day</div>
            <div class="text-xs text-slate-500">{deadliestDay[1]} crimes reported</div>
          </div>
        )}

        <!-- Trending Crime Type -->
        {trendingCrime && Math.abs(trendingCrime.change) > 0 && (
          <div class="text-center">
            <div class={`text-display font-bold mb-1 ${trendingCrime.change >= 0 ? 'text-red-600' : 'text-emerald-600'}`}>
              {trendingCrime.change >= 0 ? '↑' : '↓'} {Math.abs(Math.round(trendingCrime.percent))}%
            </div>
            <div class="text-small text-slate-700 font-medium mb-1">{trendingCrime.type}</div>
            <div class="text-xs text-slate-500">
              {trendingCrime.change >= 0 ? 'Increased' : 'Decreased'} from prev month
            </div>
          </div>
        )}

        <!-- Month-over-Month Trend -->
        {prevMonthCrimes.length > 0 && (
          <div class="text-center">
            <div class={`text-display font-bold mb-1 ${momChange >= 0 ? 'text-red-600' : 'text-emerald-600'}`}>
              {momChange >= 0 ? '↑' : '↓'} {Math.abs(momPercent)}%
            </div>
            <div class="text-small text-slate-700 font-medium mb-1">Overall Trend</div>
            <div class="text-xs text-slate-500">
              {momChange >= 0 ? 'More' : 'Fewer'} crimes than prev month
            </div>
          </div>
        )}
      </div>
    </div>

    <!-- Crime Headlines List -->
    <section>
      <h2 class="text-h2 font-bold text-slate-700 mb-4">All Headlines ({crimes.length})</h2>

      <div class="space-y-3">
        {crimes.map(crime => (
          <a
            href={`/trinidad/crime/${crime.slug}`}
            class="flex items-center justify-between bg-white/70 backdrop-blur-md rounded-lg shadow-sm border border-slate-200 p-4 hover:border-rose-600 hover:shadow-md transition group"
          >
            <div class="flex-1 min-w-0 pr-4">
              <div class="flex items-center gap-3 mb-2">
                <span class="px-3 py-1 rounded-full text-white text-xs font-medium bg-rose-600">
                  {crime.crimeType}
                </span>
                <span class="text-xs text-slate-500">{crime.date}</span>
              </div>
              <h3 class="text-small font-semibold text-slate-700 line-clamp-2 group-hover:text-rose-600 transition">
                {crime.headline}
              </h3>
              {crime.area && (
                <p class="text-xs text-slate-500 mt-1">{crime.area}</p>
              )}
            </div>
            <svg class="w-5 h-5 text-slate-400 group-hover:text-rose-600 group-hover:translate-x-1 transition flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ))}
      </div>
    </section>
  </main>
</Layout>

<style>
  /* Hide scrollbar but keep functionality */
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
</style>
