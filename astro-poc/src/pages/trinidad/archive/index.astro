---
/**
 * Archive Index Page
 * Lists all available monthly archives
 * URL: /trinidad/archive
 */

// Keep archive index static (pre-rendered at build time)
export const prerender = true;

import Layout from '../../../layouts/Layout.astro';
import Breadcrumbs from '../../../components/Breadcrumbs.astro';
import Hero from '../../../components/Hero.astro';
import SiteNotificationBanner from '../../../components/SiteNotificationBanner.astro';
import { getTrinidadCrimes } from '../../../lib/crimeData';
import { dataUpdateNotice } from '../../../config/siteNotifications';
import { getCountryName } from '../../../data/countries';
import { routes, buildRoute } from '../../../config/routes';

const crimes = await getTrinidadCrimes();

// Group by year and month
const archiveMap = new Map<string, { year: number; month: number; count: number }>();

crimes.forEach(crime => {
  const key = `${crime.year}-${String(crime.month).padStart(2, '0')}`;
  if (!archiveMap.has(key)) {
    archiveMap.set(key, { year: crime.year, month: crime.month, count: 0 });
  }
  archiveMap.get(key)!.count++;
});

// Sort by year/month descending (newest first)
const archives = Array.from(archiveMap.values()).sort((a, b) => {
  if (a.year !== b.year) return b.year - a.year;
  return b.month - a.month;
});

const now = new Date();
const currentYear = now.getFullYear();
const currentMonth = now.getMonth() + 1;

const title = "Trinidad & Tobago Crime Archives | Crime Hotspots";
const description = "Browse crime statistics archives for Trinidad & Tobago by month. View trends, statistics, and detailed reports.";
---

<Layout title={title} description={description}>
  <Hero
    title="Crime Archives"
    subtitle={`Browse ${crimes.length} crime incidents organized by month â€” Trinidad & Tobago`}
    compact={true}
    narrowContainer={true}
    primaryCTA={{ text: "Dashboard", href: routes.trinidad.dashboard, icon: "dashboard" }}
    secondaryCTA={{ text: "Headlines", href: routes.trinidad.headlines }}
  >
    <Breadcrumbs items={[
      { label: 'Home', href: routes.home },
      { label: getCountryName('tt'), href: routes.trinidad.dashboard },
      { label: 'Archive' }
    ]} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5">
    <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-3xl shadow-md p-6 sm:p-8 border border-slate-100 dark:border-[hsl(0_0%_18%)]">

    <!-- Site Notification Banner -->
    <SiteNotificationBanner notification={dataUpdateNotice} />

    <!-- Archive List -->
    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
      {archives.map(archive => {
        const monthName = new Date(archive.year, archive.month - 1).toLocaleDateString('en-US', { month: 'long' });
        return (
          <a
            href={buildRoute.archive(archive.year, String(archive.month).padStart(2, '0'))}
            class="block bg-white/70 dark:bg-[hsl(0_0%_8%)]/70 rounded-lg shadow-sm border border-slate-200 dark:border-[hsl(0_0%_15%)] p-6 hover:border-rose-600 hover:shadow-md active:shadow-lg transition group"
          >
            <div class="flex items-start justify-between">
              <div>
                <h2 class={`text-body font-bold transition ${archive.year === currentYear && archive.month === currentMonth ? 'text-rose-600 group-hover:text-rose-700' : 'text-slate-500 dark:text-[hsl(0_0%_55%)] group-hover:text-rose-600'}`}>
                  {monthName} <br>{archive.year}</br>
                </h2>
                <p class="text-tiny text-slate-500 dark:text-[hsl(0_0%_55%)] mt-1">
                  {archive.count} {archive.count === 1 ? 'crime' : 'crimes'}
                </p>
              </div>
              <svg class="w-5 h-5 text-slate-400 dark:text-[hsl(0_0%_45%)] group-hover:text-rose-600 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>

            <div class="mt-4 flex items-center text-xs text-slate-500 dark:text-[hsl(0_0%_55%)]">
              View full report
            </div>
          </a>
        );
      })}
    </div>

    {archives.length === 0 && (
      <div class="text-center py-12">
        <p class="text-body text-slate-600 dark:text-[hsl(0_0%_55%)]">No archives available yet.</p>
      </div>
    )}

    </div><!-- /card -->
  </main>
</Layout>
