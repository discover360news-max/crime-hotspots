---
/**
 * Area Comparison Tool
 * Side-by-side comparison of two areas
 * Pre-rendered with embedded stats — client-side rendering for instant comparisons
 *
 * Target keywords: "{area A} vs {area B} crime", "compare trinidad areas"
 */

// Pre-render at build time for fast LCP
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { getTrinidadCrimes, generateNameSlug } from '../../lib/crimeData';
import { loadFullAreaData } from '../../lib/areaAliases';
import { getSafetyContext } from '../../lib/safetyHelpers';
import { countCrimeType } from '../../lib/dashboardHelpers';
import { TRACKED_CRIME_TYPES, calculatePercentChange, filterToSamePeriod } from '../../lib/statisticsHelpers';

const allCrimes = await getTrinidadCrimes();
const areaData = await loadFullAreaData();

// Build slug → area mapping
const areasWithCrimes = new Set(allCrimes.map(c => c.area).filter(a => a));
const availableAreas = areaData
  .filter(a => areasWithCrimes.has(a.area))
  .map(a => {
    const slug = generateNameSlug(a.area);
    return { name: a.area, slug, region: a.region, knownAs: a.knownAs };
  })
  .sort((a, b) => a.name.localeCompare(b.name));

// Pre-compute stats for ALL areas at build time
const currentYear = new Date().getFullYear();
const previousYear = currentYear - 1;
const cutoff90d = new Date();
cutoff90d.setDate(cutoff90d.getDate() - 90);

const areaStatsMap: Record<string, {
  total90d: number;
  totalAll: number;
  murders: number;
  murderChange: number;
  safety: { score: number; level: string; primaryCrimeType?: string };
  breakdown: { type: string; count: number }[];
}> = {};

for (const area of availableAreas) {
  const crimes = allCrimes.filter(c => c.area === area.name);
  const recent90d = crimes.filter(c => c.dateObj >= cutoff90d);
  const crimesCurrent = filterToSamePeriod(crimes.filter(c => c.year === currentYear), currentYear);
  const crimesPrevious = filterToSamePeriod(crimes.filter(c => c.year === previousYear), previousYear);
  const safety = getSafetyContext(area.name, allCrimes);
  const breakdown = TRACKED_CRIME_TYPES.map(type => ({
    type,
    count: countCrimeType(recent90d, type),
  })).filter(c => c.count > 0);
  const murdersCurrent = countCrimeType(crimesCurrent, 'Murder');
  const murdersPrevious = countCrimeType(crimesPrevious, 'Murder');

  areaStatsMap[area.slug] = {
    total90d: recent90d.length,
    totalAll: crimes.length,
    murders: murdersCurrent,
    murderChange: calculatePercentChange(murdersPrevious, murdersCurrent),
    safety: { score: safety.score, level: safety.level, primaryCrimeType: safety.primaryCrimeType },
    breakdown,
  };
}

const pageTitle = 'Compare Areas - Trinidad Crime Statistics | Crime Hotspots';
const pageDescription = 'Compare crime statistics between any two areas in Trinidad & Tobago. Side-by-side safety scores and crime breakdowns.';

const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Trinidad & Tobago', href: '/trinidad/dashboard' },
  { label: 'Compare Areas' },
];
---

<Layout title={pageTitle} description={pageDescription}>
  <div class="max-w-6xl mx-auto px-4 py-6" data-pagefind-body>
    <Breadcrumbs items={breadcrumbs} />

    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 mb-2">Compare Areas</h1>
    <p class="text-sm text-slate-500 mb-6">Select two areas to compare their crime statistics side-by-side.</p>

    <!-- Area Selectors -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
      <div>
        <label for="selectA" class="block text-xs font-medium text-slate-500 mb-1">Area A</label>
        <select
          id="selectA"
          class="w-full px-4 py-3 rounded-lg border border-slate-300 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-rose-300 focus:border-rose-300"
        >
          <option value="">Select an area...</option>
          {availableAreas.map(a => (
            <option value={a.slug}>{a.name}</option>
          ))}
        </select>
      </div>
      <div>
        <label for="selectB" class="block text-xs font-medium text-slate-500 mb-1">Area B</label>
        <select
          id="selectB"
          class="w-full px-4 py-3 rounded-lg border border-slate-300 text-sm text-slate-700 bg-white focus:outline-none focus:ring-2 focus:ring-rose-300 focus:border-rose-300"
        >
          <option value="">Select an area...</option>
          {availableAreas.map(a => (
            <option value={a.slug}>{a.name}</option>
          ))}
        </select>
      </div>
    </div>

    <!-- Comparison Results (rendered client-side) -->
    <div id="comparisonResults"></div>

    <!-- Empty State -->
    <div id="emptyState" class="bg-slate-50 rounded-lg border border-slate-200 p-8 text-center">
      <svg class="w-12 h-12 text-slate-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
      </svg>
      <p class="text-sm text-slate-500 mb-2">Select two areas above to compare them.</p>
      <p class="text-xs text-slate-400">You'll see safety scores, crime counts, and breakdowns side by side.</p>
    </div>
  </div>
</Layout>

<script is:inline define:vars={{ availableAreas, areaStatsMap }}>
  const selectA = document.getElementById('selectA');
  const selectB = document.getElementById('selectB');
  const resultsEl = document.getElementById('comparisonResults');
  const emptyEl = document.getElementById('emptyState');

  // Build slug → area info lookup
  const slugToArea = {};
  availableAreas.forEach(a => { slugToArea[a.slug] = a; });

  // Set dropdowns from URL on load
  const params = new URLSearchParams(window.location.search);
  const initialA = params.get('a') || '';
  const initialB = params.get('b') || '';
  if (initialA) selectA.value = initialA;
  if (initialB) selectB.value = initialB;

  function getWinner(valA, valB) {
    if (valA === valB) return 'tie';
    return valA < valB ? 'a' : 'b';
  }

  function winnerClass(winner, side) {
    if (winner === 'tie') return 'text-slate-700';
    return winner === side ? 'text-emerald-600' : 'text-rose-600';
  }

  function levelLabel(level) {
    if (level === 'low') return 'Low Risk';
    if (level === 'neutral') return 'Moderate';
    return 'High Risk';
  }

  function levelColor(level) {
    if (level === 'low') return 'text-emerald-600';
    if (level === 'neutral') return 'text-slate-500';
    return 'text-amber-600';
  }

  function scoreBorder(winner, side) {
    if (winner === side) return 'border-emerald-300 bg-emerald-50';
    if (winner === 'tie') return 'border-slate-200 bg-white';
    return 'border-rose-200 bg-rose-50';
  }

  function renderComparison(slugA, slugB) {
    const areaA = slugToArea[slugA];
    const areaB = slugToArea[slugB];
    const statsA = areaStatsMap[slugA];
    const statsB = areaStatsMap[slugB];

    if (!areaA || !areaB || !statsA || !statsB) {
      resultsEl.innerHTML = '';
      emptyEl.style.display = '';
      return;
    }

    emptyEl.style.display = 'none';

    const safetyWinner = getWinner(statsA.safety.score, statsB.safety.score);
    const total90dWinner = getWinner(statsA.total90d, statsB.total90d);
    const murdersWinner = getWinner(statsA.murders, statsB.murders);

    // Merge breakdown types
    const allTypes = new Set([
      ...statsA.breakdown.map(b => b.type),
      ...statsB.breakdown.map(b => b.type),
    ]);
    let breakdownRows = '';
    allTypes.forEach(type => {
      const countA = (statsA.breakdown.find(b => b.type === type) || {}).count || 0;
      const countB = (statsB.breakdown.find(b => b.type === type) || {}).count || 0;
      const clsA = countA < countB ? 'text-emerald-600' : countA > countB ? 'text-rose-600' : 'text-slate-600';
      const clsB = countB < countA ? 'text-emerald-600' : countB > countA ? 'text-rose-600' : 'text-slate-600';
      breakdownRows += `<tr class="hover:bg-slate-50">
        <td class="px-4 py-2 text-slate-700">${type}</td>
        <td class="px-4 py-2 text-right font-medium ${clsA}">${countA}</td>
        <td class="px-4 py-2 text-right font-medium ${clsB}">${countB}</td>
      </tr>`;
    });

    const breakdownSection = allTypes.size > 0 ? `
      <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
        <div class="px-4 py-3 bg-slate-50 border-b border-slate-200">
          <h3 class="text-sm font-semibold text-slate-700">Crime Breakdown (90 Days)</h3>
        </div>
        <table class="w-full text-sm">
          <thead class="bg-slate-50/50 border-b border-slate-100">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-slate-500">Type</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-slate-500">${areaA.name}</th>
              <th class="px-4 py-2 text-right text-xs font-medium text-slate-500">${areaB.name}</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100">${breakdownRows}</tbody>
        </table>
      </div>` : '';

    const knownAsA = areaA.knownAs && areaA.knownAs !== areaA.name
      ? `<p class="text-xs text-slate-400">Also known as: ${areaA.knownAs}</p>` : '';
    const knownAsB = areaB.knownAs && areaB.knownAs !== areaB.name
      ? `<p class="text-xs text-slate-400">Also known as: ${areaB.knownAs}</p>` : '';

    resultsEl.innerHTML = `
      <div class="space-y-6">
        <div class="grid grid-cols-2 gap-4 text-center">
          <div class="bg-white rounded-lg border border-slate-200 p-4">
            <a href="/trinidad/area/${slugA}" class="text-base font-bold text-slate-800 hover:text-rose-600 transition">${areaA.name}</a>
            <p class="text-xs text-slate-400 mt-1">${areaA.region} Region</p>
            ${knownAsA}
          </div>
          <div class="bg-white rounded-lg border border-slate-200 p-4">
            <a href="/trinidad/area/${slugB}" class="text-base font-bold text-slate-800 hover:text-rose-600 transition">${areaB.name}</a>
            <p class="text-xs text-slate-400 mt-1">${areaB.region} Region</p>
            ${knownAsB}
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="rounded-lg border p-4 text-center ${scoreBorder(safetyWinner, 'a')}">
            <div class="text-3xl font-bold text-slate-800">${statsA.safety.score.toFixed(1)}</div>
            <div class="text-xs text-slate-500 mt-1">Risk Level /10</div>
            <div class="text-xs font-medium mt-1 ${levelColor(statsA.safety.level)}">${levelLabel(statsA.safety.level)}</div>
          </div>
          <div class="rounded-lg border p-4 text-center ${scoreBorder(safetyWinner, 'b')}">
            <div class="text-3xl font-bold text-slate-800">${statsB.safety.score.toFixed(1)}</div>
            <div class="text-xs text-slate-500 mt-1">Risk Level /10</div>
            <div class="text-xs font-medium mt-1 ${levelColor(statsB.safety.level)}">${levelLabel(statsB.safety.level)}</div>
          </div>
        </div>

        <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
          <table class="w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-4 py-3 text-left font-semibold text-slate-700">Metric</th>
                <th class="px-4 py-3 text-right font-semibold text-slate-700">${areaA.name}</th>
                <th class="px-4 py-3 text-right font-semibold text-slate-700">${areaB.name}</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-700">Total Incidents (90d)</td>
                <td class="px-4 py-3 text-right font-medium ${winnerClass(total90dWinner, 'a')}">${statsA.total90d}</td>
                <td class="px-4 py-3 text-right font-medium ${winnerClass(total90dWinner, 'b')}">${statsB.total90d}</td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-700">Murders (YTD)</td>
                <td class="px-4 py-3 text-right font-medium ${winnerClass(murdersWinner, 'a')}">${statsA.murders}</td>
                <td class="px-4 py-3 text-right font-medium ${winnerClass(murdersWinner, 'b')}">${statsB.murders}</td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-700">All-Time Incidents</td>
                <td class="px-4 py-3 text-right text-slate-600">${statsA.totalAll}</td>
                <td class="px-4 py-3 text-right text-slate-600">${statsB.totalAll}</td>
              </tr>
              <tr class="hover:bg-slate-50">
                <td class="px-4 py-3 font-medium text-slate-700">Primary Concern</td>
                <td class="px-4 py-3 text-right text-slate-600">${statsA.safety.primaryCrimeType || '—'}</td>
                <td class="px-4 py-3 text-right text-slate-600">${statsB.safety.primaryCrimeType || '—'}</td>
              </tr>
            </tbody>
          </table>
        </div>

        ${breakdownSection}
      </div>`;

    // Update page title for SEO (won't affect pre-rendered meta, but good for UX)
    document.title = areaA.name + ' vs ' + areaB.name + ' Crime Comparison | Crime Hotspots';
  }

  function updateComparison() {
    const a = selectA.value;
    const b = selectB.value;

    // Update URL without page reload
    const url = new URL(window.location);
    if (a) url.searchParams.set('a', a); else url.searchParams.delete('a');
    if (b) url.searchParams.set('b', b); else url.searchParams.delete('b');
    history.replaceState(null, '', url);

    if (a && b) {
      renderComparison(a, b);
    } else {
      resultsEl.innerHTML = '';
      emptyEl.style.display = '';
    }
  }

  if (selectA) selectA.addEventListener('change', updateComparison);
  if (selectB) selectB.addEventListener('change', updateComparison);

  // Render on load if params present
  if (initialA && initialB) {
    renderComparison(initialA, initialB);
  }
</script>
