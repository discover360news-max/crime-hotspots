---
/**
 * Blog Index Page
 * Displays all blog posts with country filtering
 */

import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import Hero from '../../components/Hero.astro';

const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const title = "Crime Statistics Blog â€” Weekly Crime Reports & Analysis | Crime Hotspots Caribbean";
const description = "Read in-depth Caribbean crime analysis and weekly reports. We uncover emerging crime trends in Trinidad and Guyana. Browse our latest data insights.";

function formatDate(date: Date) {
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(date).toLocaleDateString('en-US', options);
}
---

<Layout title={title} description={description}>
  <Hero
    compact
    narrowContainer={true}
    title="Crime Statistics Blog"
    subtitle="Weekly data-driven analysis of crime trends across the Caribbean."
  >
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: 'Blog' }
    ]} slot="before" />
  </Hero>

  <main class="max-w-3xl mx-auto px-4 sm:px-6 py-5">
    <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-3xl shadow-md p-6 sm:p-8 border border-slate-100 dark:border-[hsl(0_0%_18%)]">

    <!-- Country Filter + RSS -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex flex-wrap gap-2">
        <button id="filter-all" class="px-4 py-1 min-h-[22px] rounded-lg bg-rose-600 text-white font-medium hover:bg-rose-700 active:bg-rose-800 transition text-xs">
          All Countries
        </button>
        <button id="filter-tt" class="px-4 py-1 min-h-[22px] rounded-lg border-2 border-slate-300 dark:border-[hsl(0_0%_30%)] text-slate-700 dark:text-[hsl(0_0%_85%)] font-medium hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_14%)] active:bg-slate-100 transition text-xs">
          Trinidad & Tobago
        </button>
        <button id="filter-gy" class="px-4 py-1 min-h-[22px] rounded-lg border-2 border-slate-300 dark:border-[hsl(0_0%_30%)] text-slate-700 dark:text-[hsl(0_0%_85%)] font-medium hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_14%)] active:bg-slate-100 transition text-xs">
          Guyana
        </button>
      </div>
      <a href="/rss.xml" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-slate-300 dark:border-[hsl(0_0%_30%)] text-slate-500 dark:text-[hsl(0_0%_55%)] hover:text-rose-600 dark:hover:text-rose-400 hover:border-rose-300 dark:hover:border-rose-800 transition text-xs" title="Subscribe via RSS">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6.18 15.64a2.18 2.18 0 012.18 2.18C8.36 19.01 7.37 20 6.18 20 5 20 4 19.01 4 17.82a2.18 2.18 0 012.18-2.18M4 4.44A15.56 15.56 0 0119.56 20h-2.83A12.73 12.73 0 004 7.27V4.44m0 5.66a9.9 9.9 0 019.9 9.9h-2.83A7.07 7.07 0 004 12.93V10.1z"/>
        </svg>
        RSS
      </a>
    </div>

    <!-- Blog Posts List -->
    <div id="blog-posts" class="space-y-4">
      {sortedPosts.map((post) => (
        <article
          class="blog-post border-b border-slate-100 dark:border-[hsl(0_0%_15%)] last:border-0 pb-4 last:pb-0"
          data-country={post.data.country}
        >
          <a href={`/blog/${post.slug}`} class="flex gap-4 items-start group">
            <img src={post.data.image} alt={post.data.countryName} class="w-20 h-20 object-cover rounded-lg shrink-0">
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1 flex-wrap">
                <span class="text-caption font-bold px-2 py-0.5 rounded bg-rose-50 dark:bg-rose-950/50 text-rose-600 dark:text-rose-400">
                  {post.data.countryName}
                </span>
                <span class="text-caption text-slate-400 dark:text-[hsl(0_0%_50%)]">{formatDate(post.data.date)}</span>
              </div>
              <h2 class="text-body font-bold text-slate-800 dark:text-[hsl(0_0%_92%)] group-hover:text-rose-600 dark:group-hover:text-rose-400 transition leading-snug line-clamp-2">
                {post.data.title}
              </h2>
              <p class="text-caption text-slate-500 dark:text-[hsl(0_0%_60%)] mt-1 line-clamp-2">
                {post.data.excerpt}
              </p>
              <span class="text-caption text-slate-400 dark:text-[hsl(0_0%_50%)] mt-1 inline-block">{post.data.readTime}</span>
            </div>
          </a>
        </article>
      ))}
    </div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-12">
      <p class="text-slate-600 dark:text-[hsl(0_0%_65%)] text-body">No blog posts found for this filter.</p>
    </div>

    </div>
  </main>

  <!-- Filter Script -->
  <script is:inline>
    let currentFilter = 'all';

    function filterPosts() {
      const posts = document.querySelectorAll('.blog-post');
      const emptyState = document.getElementById('empty-state');
      let visibleCount = 0;

      posts.forEach(post => {
        const country = post.getAttribute('data-country');
        if (currentFilter === 'all' || country === currentFilter) {
          post.classList.remove('hidden');
          visibleCount++;
        } else {
          post.classList.add('hidden');
        }
      });

      if (visibleCount === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }
    }

    function updateFilterButtons(activeId) {
      ['filter-all', 'filter-tt', 'filter-gy'].forEach(id => {
        const button = document.getElementById(id);
        if (id === activeId) {
          button.classList.remove('border-2', 'border-slate-300', 'dark:border-[hsl(0_0%_30%)]', 'text-slate-700', 'dark:text-[hsl(0_0%_85%)]', 'hover:bg-slate-50', 'dark:hover:bg-[hsl(0_0%_14%)]');
          button.classList.add('bg-rose-600', 'text-white', 'hover:bg-rose-700');
        } else {
          button.classList.remove('bg-rose-600', 'text-white', 'hover:bg-rose-700');
          button.classList.add('border-2', 'border-slate-300', 'dark:border-[hsl(0_0%_30%)]', 'text-slate-700', 'dark:text-[hsl(0_0%_85%)]', 'hover:bg-slate-50', 'dark:hover:bg-[hsl(0_0%_14%)]');
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = {
        'filter-all': 'all',
        'filter-tt': 'tt',
        'filter-gy': 'gy'
      };

      Object.entries(filterButtons).forEach(([buttonId, filter]) => {
        const button = document.getElementById(buttonId);
        button.addEventListener('click', () => {
          currentFilter = filter;
          updateFilterButtons(buttonId);
          filterPosts();
        });
      });
    });
  </script>
</Layout>
