---
/**
 * Blog Post Page
 * Dynamic route for individual blog posts
 */

// Keep blog posts static (pre-rendered at build time)
export const prerender = true;

import Layout from '../../layouts/Layout.astro';
import Breadcrumbs from '../../components/Breadcrumbs.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { routes, buildRoute } from '../../config/routes';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const title = `${post.data.title} | Crime Hotspots Caribbean`;
const description = post.data.excerpt;

function formatDate(date: Date) {
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(date).toLocaleDateString('en-US', options);
}

// Determine dashboard link based on country
const dashboardLink = post.data.country === 'tt'
  ? routes.trinidad.dashboard
  : '/guyana/dashboard/';

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: routes.home },
  { label: 'Blog', href: routes.blog },
  { label: post.data.title }
];

// Get related posts (same country, most recent, excluding current)
const allPosts = await getCollection('blog');
const relatedPosts = allPosts
  .filter(p => p.slug !== post.slug && p.data.country === post.data.country)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

// BlogPosting Schema for SEO
const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.excerpt,
  "image": post.data.image,
  "datePublished": post.data.date.toISOString(),
  "author": {
    "@type": "Person",
    "name": post.data.author
  },
  "publisher": {
    "@type": "Organization",
    "name": "Crime Hotspots",
    "url": "https://crimehotspots.com"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://crimehotspots.com/blog/${post.slug}`
  },
  "articleSection": post.data.countryName,
  "keywords": ["crime statistics", post.data.countryName, "Caribbean crime data"]
};
---

<style>
  /* Blog Content Styling */
  .blog-content {
    color: #334155; /* slate-700 */
  }

  /* Headings */
  .blog-content :global(h2) {
    font-size: 1.5rem; /* h2 */
    line-height: 2rem;
    font-weight: 600;
    color: #334155; /* slate-700 */
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .blog-content :global(h3) {
    font-size: 1.25rem; /* h3 */
    line-height: 1.75rem;
    font-weight: 600;
    color: #334155; /* slate-700 */
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .blog-content :global(h4) {
    font-size: 1rem;
    line-height: 1.5rem;
    font-weight: 600;
    color: #475569; /* slate-600 */
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
  }

  /* Paragraphs */
  .blog-content :global(p) {
    font-size: 0.875rem; /* small */
    line-height: 1.625rem;
    color: #334155; /* slate-700 */
    margin-bottom: 1rem;
  }

  /* Lists */
  .blog-content :global(ul),
  .blog-content :global(ol) {
    font-size: 0.875rem; /* small */
    line-height: 1.625rem;
    color: #334155; /* slate-700 */
    margin-top: 1rem;
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .blog-content :global(ul) {
    list-style-type: disc;
  }

  .blog-content :global(ol) {
    list-style-type: decimal;
  }

  .blog-content :global(li) {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    padding-left: 0.25rem;
  }

  .blog-content :global(li > ul),
  .blog-content :global(li > ol) {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Strong/Bold */
  .blog-content :global(strong) {
    font-weight: 600;
    color: #1e293b; /* slate-800 */
  }

  /* Links */
  .blog-content :global(a) {
    color: #e11d48; /* rose-600 */
    text-decoration: underline;
    font-weight: 500;
  }

  .blog-content :global(a:hover) {
    color: #be123c; /* rose-700 */
  }

  /* Horizontal Rules */
  .blog-content :global(hr) {
    border: 0;
    border-top: 1px solid #e2e8f0; /* slate-200 */
    margin-top: 2rem;
    margin-bottom: 2rem;
  }

  /* Blockquotes */
  .blog-content :global(blockquote) {
    border-left: 4px solid #e11d48; /* rose-600 */
    padding-left: 1rem;
    margin-left: 0;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    font-style: italic;
    color: #475569; /* slate-600 */
  }

  /* Code */
  .blog-content :global(code) {
    background-color: #f1f5f9; /* slate-100 */
    color: #e11d48; /* rose-600 */
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    font-family: 'Monaco', 'Courier New', monospace;
  }

  .blog-content :global(pre) {
    background-color: #0f172a; /* slate-900 */
    color: #f8fafc; /* slate-50 */
    padding: 1rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .blog-content :global(pre code) {
    background-color: transparent;
    color: inherit;
    padding: 0;
    font-size: 0.875rem;
  }

  /* Dark Mode Overrides */
  :global(.dark) .blog-content {
    color: hsl(0 0% 82%);
  }
  :global(.dark) .blog-content :global(h2),
  :global(.dark) .blog-content :global(h3) {
    color: hsl(0 0% 88%);
  }
  :global(.dark) .blog-content :global(h4) {
    color: hsl(0 0% 75%);
  }
  :global(.dark) .blog-content :global(p),
  :global(.dark) .blog-content :global(li) {
    color: hsl(0 0% 82%);
  }
  :global(.dark) .blog-content :global(strong) {
    color: hsl(0 0% 92%);
  }
  :global(.dark) .blog-content :global(blockquote) {
    color: hsl(0 0% 70%);
  }
  :global(.dark) .blog-content :global(hr) {
    border-top-color: hsl(0 0% 22%);
  }
  :global(.dark) .blog-content :global(code) {
    background-color: hsl(0 0% 14%);
    color: #fb7185; /* rose-400 */
  }
  :global(.dark) .blog-content :global(th) {
    background-color: hsl(0 0% 10%);
    color: hsl(0 0% 85%);
  }
  :global(.dark) .blog-content :global(td) {
    color: hsl(0 0% 80%);
  }
  :global(.dark) .blog-content :global(th),
  :global(.dark) .blog-content :global(td) {
    border-color: hsl(0 0% 22%);
  }

  /* Tables */
  .blog-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
  }

  .blog-content :global(th),
  .blog-content :global(td) {
    border: 1px solid #e2e8f0; /* slate-200 */
    padding: 0.75rem;
    text-align: left;
  }

  .blog-content :global(th) {
    background-color: #f8fafc; /* slate-50 */
    font-weight: 600;
    color: #334155; /* slate-700 */
  }

  .blog-content :global(td) {
    color: #334155; /* slate-700 */
  }
</style>

<Layout title={title} description={description} ogImage={post.data.image}>
  <!-- BlogPosting Schema for SEO -->
  <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />

  <main class="flex-1 w-full max-w-3xl mx-auto px-4 sm:px-6 py-4 sm:py-12 text-slate-700 dark:text-[hsl(0_0%_82%)]">
    <!-- Breadcrumbs -->
    <Breadcrumbs items={breadcrumbItems} />

    <article>
      <!-- Hero Image (above card) -->
      <div class="mb-6 sm:mb-8 rounded-2xl overflow-hidden">
        <img
          src={post.data.image}
          alt={post.data.countryName}
          class="w-full h-48 sm:h-64 md:h-80 object-cover"
        >
      </div>

      <!-- Article Card -->
      <div class="bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md rounded-3xl shadow-md p-6 sm:p-8 border border-slate-100 dark:border-[hsl(0_0%_18%)] leading-relaxed">
        <!-- Article Header -->
        <header class="mb-6 sm:mb-8">
          <div class="flex items-center gap-2 mb-3 sm:mb-4">
            <span class="text-caption font-bold px-3 py-1 rounded bg-rose-100 dark:bg-rose-950/50 text-rose-700 dark:text-rose-400">
              {post.data.countryName}
            </span>
            <span class="text-caption text-slate-500 dark:text-[hsl(0_0%_55%)]">{formatDate(post.data.date)}</span>
          </div>
          <h1 class="text-display font-bold text-slate-900 dark:text-[hsl(0_0%_95%)] leading-tight mb-3 sm:mb-4">{post.data.title}</h1>
          <div class="flex items-center gap-4 text-caption text-slate-600 dark:text-[hsl(0_0%_70%)]">
            <span>{post.data.author}</span>
            <span>•</span>
            <span>{post.data.readTime}</span>
          </div>
        </header>

        <!-- Article Body -->
        <div class="blog-content">
          <Content />
        </div>

        <!-- Social Share Buttons -->
        <div class="mt-8 sm:mt-12 pt-6 sm:pt-8 border-t border-slate-200 dark:border-[hsl(0_0%_18%)]">
          <h3 class="text-heading font-bold mb-4 text-slate-900 dark:text-[hsl(0_0%_92%)] leading-snug">Share this article</h3>
          <div class="flex flex-wrap gap-3">
            <button
              id="share-facebook"
              class="px-4 py-1.5 min-h-button bg-[#1877F2] text-white rounded-lg hover:bg-[#0d6efd] transition text-caption font-bold"
            >
              Facebook
            </button>
            <button
              id="share-twitter"
              class="px-4 py-1.5 min-h-button bg-slate-900 text-white rounded-lg hover:bg-slate-700 transition text-caption font-bold"
            >
              X (Twitter)
            </button>
            <button
              id="share-whatsapp"
              class="px-4 py-1.5 min-h-button bg-[#25D366] text-white rounded-lg hover:bg-[#1ebe5c] transition text-caption font-bold"
            >
              WhatsApp
            </button>
            <button
              id="share-copy"
              class="px-4 py-1.5 min-h-button bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition text-caption font-bold"
            >
              Copy Link
            </button>
          </div>
        </div>

        <!-- Related Dashboard -->
        <div class="mt-8 sm:mt-12 p-4 sm:p-6 bg-rose-50/70 dark:bg-rose-950/30 rounded-lg border border-rose-200 dark:border-rose-900/60">
          <h3 class="text-heading font-bold mb-3 text-slate-900 dark:text-[hsl(0_0%_92%)] leading-snug">View Interactive Dashboard</h3>
          <p class="text-body text-slate-600 dark:text-[hsl(0_0%_70%)] mb-4">Explore the full crime statistics dashboard for detailed visualizations and filters.</p>
          <a
            href={dashboardLink}
            class="inline-block px-4 py-1.5 min-h-button bg-rose-600 text-white font-bold rounded-lg hover:bg-rose-700 active:bg-rose-800 transition text-caption"
          >
            View {post.data.countryName} Dashboard
          </a>
        </div>
      </div>

      <!-- More Reports (outside card) -->
      {relatedPosts.length > 0 && (
        <div class="mt-8 sm:mt-12">
          <h3 class="text-heading font-bold mb-4 text-slate-900 dark:text-[hsl(0_0%_92%)] leading-snug">More Weekly Reports</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            {relatedPosts.map((related) => (
              <a href={buildRoute.blogPost(related.slug)} class="block bg-white/85 dark:bg-[hsl(0_0%_10%)] backdrop-blur-md rounded-lg border border-slate-200 dark:border-[hsl(0_0%_18%)] p-4 hover:shadow-md hover:border-rose-200 dark:hover:border-rose-800 transition-all">
                <span class="text-caption text-slate-500 dark:text-[hsl(0_0%_55%)]">{formatDate(related.data.date)}</span>
                <h4 class="text-caption font-bold text-slate-900 dark:text-[hsl(0_0%_90%)] mt-1 line-clamp-2">{related.data.title}</h4>
                <span class="text-caption text-rose-600 mt-2 block">{related.data.readTime}</span>
              </a>
            ))}
          </div>
          <div class="mt-4 text-center">
            <a href={routes.blog} class="text-caption text-rose-600 hover:text-rose-700 font-bold">
              View all reports →
            </a>
          </div>
        </div>
      )}

      <!-- Back to Blog -->
      <div class="mt-6 sm:mt-8">
        <a href={routes.blog} class="text-rose-600 hover:text-rose-700 dark:text-rose-400 dark:hover:text-rose-300 font-bold text-caption">
          ← Back to Blog
        </a>
      </div>
    </article>
  </main>

  <!-- Social Share Script -->
  <script is:inline define:vars={{ title: post.data.title }}>
    document.addEventListener('DOMContentLoaded', () => {
      const url = window.location.href;
      const text = title;

      document.getElementById('share-facebook').addEventListener('click', () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
      });

      document.getElementById('share-twitter').addEventListener('click', () => {
        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
      });

      document.getElementById('share-whatsapp').addEventListener('click', () => {
        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
      });

      document.getElementById('share-copy').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(url);
          const btn = document.getElementById('share-copy');
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  </script>
</Layout>
