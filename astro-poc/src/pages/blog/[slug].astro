---
/**
 * Blog Post Page
 * Dynamic route for individual blog posts
 */

import Layout from '../../layouts/Layout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const title = `${post.data.title} | Crime Hotspots Caribbean`;
const description = post.data.excerpt;

function formatDate(date: Date) {
  const options: Intl.DateTimeFormatOptions = { year: 'numeric', month: 'long', day: 'numeric' };
  return new Date(date).toLocaleDateString('en-US', options);
}

// Determine dashboard link based on country
const dashboardLink = post.data.country === 'tt'
  ? '/trinidad/dashboard'
  : '/guyana/dashboard';
---

<Layout title={title} description={description} ogImage={post.data.image}>
  <main class="container mx-auto px-4 py-8 sm:py-12 max-w-4xl">
    <article>
      <!-- Hero Image -->
      <div class="mb-6 sm:mb-8 rounded-lg overflow-hidden">
        <img
          src={post.data.image}
          alt={post.data.countryName}
          class="w-full h-48 sm:h-64 md:h-96 object-cover"
        >
      </div>

      <!-- Article Header -->
      <header class="mb-6 sm:mb-8">
        <div class="flex items-center gap-2 mb-3 sm:mb-4">
          <span class="text-tiny font-semibold px-3 py-1 rounded bg-rose-100 text-rose-700">
            {post.data.countryName}
          </span>
          <span class="text-small text-slate-500">{formatDate(post.data.date)}</span>
        </div>
        <h1 class="text-h1 sm:text-display font-bold text-slate-900 mb-3 sm:mb-4">{post.data.title}</h1>
        <div class="flex items-center gap-4 text-small text-slate-600">
          <span>{post.data.author}</span>
          <span>•</span>
          <span>{post.data.readTime}</span>
        </div>
      </header>

      <!-- Article Body -->
      <div class="prose prose-slate max-w-none
        prose-headings:text-slate-900 prose-headings:font-semibold
        prose-h2:text-h2 prose-h2:mt-8 prose-h2:mb-4
        prose-h3:text-h3 prose-h3:mt-6 prose-h3:mb-3
        prose-p:text-small prose-p:text-slate-700 prose-p:mb-4 prose-p:leading-relaxed
        prose-ul:text-small prose-ul:text-slate-700 prose-ul:my-4
        prose-li:my-1
        prose-strong:text-slate-900 prose-strong:font-semibold
        prose-a:text-rose-600 prose-a:no-underline hover:prose-a:underline
      ">
        <Content />
      </div>

      <!-- Social Share Buttons -->
      <div class="mt-8 sm:mt-12 pt-6 sm:pt-8 border-t border-slate-200">
        <h3 class="text-h3 font-semibold mb-4 text-slate-900">Share this article</h3>
        <div class="flex flex-wrap gap-3">
          <button
            id="share-facebook"
            class="px-4 py-1.5 min-h-[22px] bg-slate-400 text-white rounded-lg hover:bg-blue-700 transition text-xs font-medium"
          >
            Facebook
          </button>
          <button
            id="share-twitter"
            class="px-4 py-1.5 min-h-[22px] bg-slate-400 text-white rounded-lg hover:bg-sky-500 transition text-xs font-medium"
          >
            X (Twitter)
          </button>
          <button
            id="share-whatsapp"
            class="px-4 py-1.5 min-h-[22px] bg-slate-400 text-white rounded-lg hover:bg-green-700 transition text-xs font-medium"
          >
            WhatsApp
          </button>
          <button
            id="share-copy"
            class="px-4 py-1.5 min-h-[22px] bg-slate-400 text-white rounded-lg hover:bg-slate-700 transition text-xs font-medium"
          >
            Copy Link
          </button>
        </div>
      </div>

      <!-- Related Dashboard -->
      <div class="mt-8 sm:mt-12 p-4 sm:p-6 bg-rose-50/70 backdrop-blur-md rounded-lg border border-rose-200">
        <h3 class="text-h3 font-semibold mb-3 text-slate-900">View Interactive Dashboard</h3>
        <p class="text-small text-slate-600 mb-4">Explore the full crime statistics dashboard for detailed visualizations and filters.</p>
        <a
          href={dashboardLink}
          class="inline-block px-4 py-1.5 min-h-[22px] bg-rose-600 text-white font-medium rounded-lg hover:bg-rose-700 transition text-small"
        >
          View {post.data.countryName} Dashboard
        </a>
      </div>

      <!-- Back to Blog -->
      <div class="mt-6 sm:mt-8">
        <a href="/blog" class="text-rose-600 hover:text-rose-700 font-medium text-small">
          ← Back to Blog
        </a>
      </div>
    </article>
  </main>

  <!-- Social Share Script -->
  <script is:inline define:vars={{ title: post.data.title }}>
    document.addEventListener('DOMContentLoaded', () => {
      const url = window.location.href;
      const text = title;

      document.getElementById('share-facebook').addEventListener('click', () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
      });

      document.getElementById('share-twitter').addEventListener('click', () => {
        window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`, '_blank');
      });

      document.getElementById('share-whatsapp').addEventListener('click', () => {
        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');
      });

      document.getElementById('share-copy').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(url);
          const btn = document.getElementById('share-copy');
          const originalText = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(() => {
            btn.textContent = originalText;
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      });
    });
  </script>
</Layout>
