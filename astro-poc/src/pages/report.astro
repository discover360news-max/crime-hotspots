---
/**
 * Anonymous Crime Reporting Form
 * Cloudflare Turnstile CAPTCHA + honeypot anti-bot protection
 */

import Layout from '../layouts/Layout.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import { routes } from '../config/routes';

const title = "Report a Crime Anonymously — Crime Hotspots Caribbean";
const description = "Help build safer communities: report crime anonymously via our secure platform. Use our reliable crime tip line for the Caribbean. Submit a report now.";
---

<Layout title={title} description={description} includeTurnstile={true}>
  <!-- PapaParse for reliable CSV parsing -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <main class="flex-1 w-full max-w-2xl mx-auto p-6 text-slate-700 dark:text-[hsl(0_0%_82%)]">
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: 'Report a Crime' }
    ]} />

    <h1 class="text-display font-semibold mb-3 text-center text-slate-700 dark:text-[hsl(0_0%_95%)]">Report a Crime (Anonymously)</h1>
    <p class="text-xs text-slate-600 dark:text-[hsl(0_0%_65%)] mb-4 text-center">
      Your report is anonymous. Please provide as much detail as possible to help us identify trends and verify reports.
    </p>

    <form id="reportForm" class="space-y-4 bg-white/70 dark:bg-[hsl(0_0%_8%_/_0.7)] backdrop-blur-md p-6 rounded-2xl shadow-lg border border-slate-100 dark:border-[hsl(0_0%_18%)]">
      <!-- Honeypot -->
      <input type="text" id="hp_field" name="hp_field" autocomplete="off" style="display:none !important" aria-hidden="true" />

      <!-- Incident Details Section -->
      <div class="space-y-4 pb-4 border-b border-slate-200 dark:border-[hsl(0_0%_22%)]">
        <h3 class="text-small font-semibold text-slate-600 dark:text-[hsl(0_0%_75%)] uppercase tracking-wide">Incident Details</h3>

        <div>
          <label for="reportDate" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Date of Incident <span class="text-rose-600">*</span>
          </label>
          <input id="reportDate" name="reportDate" type="date" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-700 dark:text-[hsl(0_0%_85%)]" required />
        </div>

        <div>
          <label for="reportCrimeType" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Crime Type <span class="text-rose-600">*</span>
          </label>
          <select id="reportCrimeType" name="reportCrimeType" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-700 dark:text-[hsl(0_0%_85%)]" required>
            <option value="">Select a crime</option>
            <option>Assault</option>
            <option>Burglary</option>
            <option>Home Invasion</option>
            <option>Kidnapping</option>
            <option>Murder</option>
            <option>Robbery</option>
            <option>Shooting</option>
            <option>Seizures</option>
            <option>Theft</option>
            <option>Other</option>
          </select>
        </div>
      </div>

      <!-- Location Section -->
      <div class="space-y-4 pb-4 border-b border-slate-200 dark:border-[hsl(0_0%_22%)]">
        <h3 class="text-small font-semibold text-slate-600 dark:text-[hsl(0_0%_75%)] uppercase tracking-wide">Location</h3>

        <div>
          <label for="reportCountry" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Country / Island <span class="text-rose-600">*</span>
          </label>
          <select id="reportCountry" name="reportCountry" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-700 dark:text-[hsl(0_0%_85%)]" required>
            <option value="">Select a country</option>
          </select>
        </div>

        <div>
          <label for="reportArea" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Area <span class="text-xs font-normal text-slate-500 dark:text-[hsl(0_0%_55%)]">(optional)</span>
          </label>
          <select id="reportArea" name="reportArea" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-500 dark:text-[hsl(0_0%_65%)]">
            <option value="">Select area (optional)</option>
          </select>
        </div>

        <div>
          <label for="reportStreet" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Street / Location <span class="text-xs font-normal text-slate-500 dark:text-[hsl(0_0%_55%)]">(optional)</span>
          </label>
          <input id="reportStreet" name="reportStreet" type="text" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-500 dark:text-[hsl(0_0%_65%)] dark:placeholder-[hsl(0_0%_45%)]" placeholder="e.g., Main Street near the plaza" />
        </div>
      </div>

      <!-- Description Section -->
      <div class="space-y-4">
        <h3 class="text-small font-semibold text-slate-600 dark:text-[hsl(0_0%_75%)] uppercase tracking-wide">Description</h3>

        <div>
          <label for="reportHeadline" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Headline <span class="text-rose-600">*</span>
            <span class="text-xs font-normal text-slate-500 dark:text-[hsl(0_0%_55%)]">(120 chars max)</span>
          </label>
          <input id="reportHeadline" name="reportHeadline" maxlength="120" type="text" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-500 dark:text-[hsl(0_0%_65%)] dark:placeholder-[hsl(0_0%_45%)]" placeholder="Brief summary of the incident" required />
        </div>

        <div>
          <label for="reportDetails" class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_65%)] block mb-2">
            Details <span class="text-rose-600">*</span>
          </label>
          <textarea id="reportDetails" name="reportDetails" rows="4" class="w-full px-3 py-2 border border-slate-300 dark:border-[hsl(0_0%_25%)] dark:bg-[hsl(0_0%_12%)] rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-rose-500 text-xs text-slate-500 dark:text-[hsl(0_0%_65%)] dark:placeholder-[hsl(0_0%_45%)]" placeholder="Provide as much detail as possible to help us verify the report" required></textarea>
        </div>
      </div>

      <!-- Cloudflare Turnstile Widget (invisible mode — zero height to prevent CLS) -->
      <!-- With ?render=explicit mode, config is passed to render() function, NOT via data attributes -->
      <div id="reportTurnstile" class="cf-turnstile" style="height: 0; overflow: hidden;"></div>
      <div class="flex items-center justify-between mt-4">
        <div class="text-xs text-slate-500 dark:text-[hsl(0_0%_55%)]">
          You'll receive a unique anonymous report ID.
        </div>
        <button
          id="reportSubmit"
          type="submit"
          class="px-6 py-2.5 bg-rose-600 text-white rounded-lg hover:bg-rose-700 active:bg-rose-800 transition font-medium text-xs"
        >
          Submit
        </button>
      </div>
    </form>

    <!-- Confirmation Screen -->
    <div
      id="reportSuccess"
      class="hidden fixed inset-0 bg-white/70 dark:bg-[hsl(0_0%_3%_/_0.85)] backdrop-blur-md flex flex-col items-center justify-center z-50 text-center p-8 transition-all duration-700"
    >
      <div class="bg-white/80 dark:bg-[hsl(0_0%_10%_/_0.9)] backdrop-blur-xl rounded-2xl shadow-xl p-8 max-w-md w-full border border-slate-200 dark:border-[hsl(0_0%_22%)]">
        <!-- Success Icon -->
        <div class="flex justify-center mb-4">
          <div class="w-16 h-16 bg-emerald-100 dark:bg-emerald-950/50 rounded-full flex items-center justify-center">
            <svg class="w-8 h-8 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
        </div>

        <!-- Thank You Message -->
        <h2 class="text-display font-bold text-slate-700 dark:text-[hsl(0_0%_92%)] mb-2">Thank You!</h2>
        <p class="text-body text-slate-600 dark:text-[hsl(0_0%_70%)] mb-6">
          Your anonymous report has been submitted successfully. Save this ID for your records.
        </p>

        <!-- Report ID -->
        <div class="bg-rose-50 dark:bg-rose-950/40 border-2 border-rose-200 dark:border-rose-800 text-rose-700 dark:text-rose-400 font-mono text-heading font-bold py-4 px-6 rounded-lg mb-4 select-all" id="reportIdDisplay">
          ID-XXXX-XXXX
        </div>

        <!-- Copy Button -->
        <button
          id="copyIdBtn"
          class="w-full px-4 py-2.5 mb-6 bg-rose-600 text-white rounded-lg hover:bg-rose-700 active:bg-rose-800 transition font-medium text-small flex items-center justify-center gap-2"
        >
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
          </svg>
          Copy ID
        </button>

        <!-- Divider -->
        <div class="border-t border-slate-200 dark:border-[hsl(0_0%_22%)] mb-6"></div>

        <!-- Next Steps -->
        <p class="text-xs font-semibold text-slate-500 dark:text-[hsl(0_0%_55%)] mb-3 uppercase tracking-wide">What's Next?</p>
        <div class="grid grid-cols-2 gap-3 mb-4">
          <button
            id="exploreCountryBtn"
            type="button"
            class="px-4 py-2.5 bg-rose-600 text-white rounded-lg hover:bg-rose-700 active:bg-rose-800 transition font-medium text-xs flex items-center justify-center gap-1.5"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            Explore
          </button>
          <a href={routes.report} class="px-4 py-2.5 bg-white dark:bg-[hsl(0_0%_12%)] border-2 border-slate-300 dark:border-[hsl(0_0%_30%)] text-slate-700 dark:text-[hsl(0_0%_85%)] rounded-lg hover:border-rose-600 hover:text-rose-600 dark:hover:border-rose-500 dark:hover:text-rose-400 transition font-medium text-xs flex items-center justify-center gap-1.5">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Submit Another
          </a>
        </div>

        <!-- Home Link -->
        <a href="/" class="text-small text-slate-500 dark:text-[hsl(0_0%_55%)] hover:text-rose-600 dark:hover:text-rose-400 underline">
          Return to Homepage
        </a>
      </div>
    </div>

    <!-- Feedback -->
    <div id="reportResult" class="hidden mt-6 text-center p-4 rounded-xl bg-rose-50 text-rose-700 font-medium shadow-sm text-small"></div>
  </main>

  <!-- Client-side form logic -->
  <script is:inline>
    // Global callback for Turnstile - tracks when invisible widget completes
    let turnstileReady = false;
    window.onReportTurnstileSuccess = function(token) {
      console.log('Turnstile ready:', token ? 'Yes' : 'No');
      turnstileReady = true;
    };
  </script>

  <script>
    import { COUNTRIES, APPS_SCRIPT_URL } from '../data/countries';
    import { generateId, cleanAreaName, getValidatedLocalStorage, validateHoneypot, RateLimiter } from '../utils/formHelpers';
    import { validateForm } from '../utils/reportValidation';

    const countrySelect = document.getElementById("reportCountry") as HTMLSelectElement;
    const areaSelect = document.getElementById("reportArea") as HTMLSelectElement;
    const form = document.getElementById("reportForm") as HTMLFormElement;
    const resultBox = document.getElementById("reportResult") as HTMLDivElement;
    const submitBtn = document.getElementById("reportSubmit") as HTMLButtonElement;
    const hp = document.getElementById("hp_field") as HTMLInputElement;

    // --- Data Loading ---
    function loadCountries() {
      countrySelect.innerHTML = `<option value="">Select a Country</option>`;
      COUNTRIES.filter(c => c.available).forEach((country) => {
        const option = document.createElement("option");
        option.value = country.id;
        option.textContent = country.name;
        countrySelect.appendChild(option);
      });
    }

    async function loadAreas(country: any) {
      areaSelect.disabled = true;
      areaSelect.innerHTML = `<option>Loading Areas...</option>`;

      const csvUrl = country?.csvUrl;

      if (!csvUrl) {
        areaSelect.innerHTML = `<option>N/A (No area data for ${country.name})</option>`;
        areaSelect.value = "N/A";
        areaSelect.disabled = true;
        return;
      }

      // Use PapaParse for reliable CSV parsing (same as Vite version)
      if (!(window as any).Papa) {
        areaSelect.innerHTML = `<option>CSV parser not loaded</option>`;
        return;
      }

      (window as any).Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function (results: any) {
          const areaNames = results.data
            .map((r: any) => r.Area)
            .filter((area: string) => area && area.trim().length > 0)
            .map(cleanAreaName)
            // Deduplicate and sort
            .filter((value: string, index: number, self: string[]) => self.indexOf(value) === index)
            .sort((a: string, b: string) => a.localeCompare(b));

          areaSelect.innerHTML = `<option value="">Select Area (Optional)</option>`;
          areaNames.forEach((area: string) => {
            const option = document.createElement("option");
            option.value = area;
            option.textContent = area;
            areaSelect.appendChild(option);
          });

          areaSelect.disabled = false;

          const savedArea = getValidatedLocalStorage("ccw_selected_area", (val) => {
            return /^[a-zA-Z0-9\s\-,]+$/.test(val) && val.length < 100 && areaNames.includes(val);
          });
          if (savedArea) {
            areaSelect.value = savedArea;
          }
        },
        error: (err: any) => {
          console.error("Area CSV parse error:", err);
          areaSelect.innerHTML = `<option>Error loading areas</option>`;
        }
      });
    }

    // --- Rate Limiter Instance ---
    const submitLimiter = new RateLimiter(3, 3600000); // 3 per hour

    // --- Form Submission ---
    async function handleSubmit(e: Event) {
      e.preventDefault();

      // Rate limiting check
      if (!submitLimiter.canMakeRequest()) {
        const waitTime = Math.ceil(submitLimiter.getTimeUntilNextRequest() / 60000);
        resultBox.classList.remove("hidden");
        resultBox.classList.add('bg-rose-50', 'border-rose-200', 'text-rose-700');
        resultBox.textContent = `⏱️ Rate limit exceeded. Please wait ${waitTime} minute(s) before submitting again.`;
        return;
      }

      // Honeypot validation
      if (!validateHoneypot(hp)) {
        console.warn('Bot detected by honeypot');
        return;
      }

      // Form validation
      const formData = new FormData(form);
      const validationErrors = validateForm(formData);

      if (validationErrors.length > 0) {
        resultBox.classList.remove("hidden");
        resultBox.classList.add('bg-rose-50', 'border-rose-200');
        resultBox.innerHTML = '<p class="font-semibold mb-2 text-rose-700">Please fix the following errors:</p>' +
          validationErrors.map(err => `<p class="text-rose-700">• ${err}</p>`).join('');
        return;
      }

      // Get Turnstile token
      let token = formData.get('cf-turnstile-response');

      // For invisible mode, wait a moment if token not ready
      if (!token || token === '') {
        // Give invisible widget a moment to generate token
        submitBtn.disabled = true;
        submitBtn.textContent = "Verifying...";

        await new Promise(resolve => setTimeout(resolve, 1500));

        // Re-check token after wait
        const newFormData = new FormData(form);
        token = newFormData.get('cf-turnstile-response');

        if (!token || token === '') {
          resultBox.classList.remove("hidden");
          resultBox.classList.add('bg-rose-50', 'border-rose-200', 'text-rose-700');
          resultBox.textContent = "❌ Security verification failed. Please refresh the page and try again.";
          submitBtn.disabled = false;
          submitBtn.textContent = "Submit";
          return;
        }
      }

      const countryId = countrySelect.value;
      const country = COUNTRIES.find((c) => c.id === countryId);

      const payload = {
        id: generateId(countryId.toUpperCase()),
        countryId,
        countryName: country?.name || "Unknown",
        date: (document.getElementById('reportDate') as HTMLInputElement).value,
        crimeType: (document.getElementById('reportCrimeType') as HTMLSelectElement).value,
        area: (document.getElementById('reportArea') as HTMLSelectElement).value,
        street: (document.getElementById('reportStreet') as HTMLInputElement).value,
        headline: (document.getElementById('reportHeadline') as HTMLInputElement).value,
        details: (document.getElementById('reportDetails') as HTMLTextAreaElement).value,
        ua: navigator.userAgent,
        "cf-token": token
      };

      submitBtn.disabled = true;
      submitBtn.textContent = "Submitting…";
      resultBox.classList.add("hidden");

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain" },
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (data.success) {
          const idDisplay = document.getElementById("reportIdDisplay")!;
          const successScreen = document.getElementById("reportSuccess")!;
          const copyBtn = document.getElementById("copyIdBtn")!;

          idDisplay.textContent = payload.id;
          successScreen.classList.remove("hidden");
          successScreen.classList.add("opacity-0");
          setTimeout(() => {
            successScreen.classList.remove("opacity-0");
            successScreen.classList.add("opacity-100");
          }, 50);

          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(payload.id);
              copyBtn.textContent = "✓ Copied!";
              setTimeout(() => (copyBtn.textContent = "Copy ID"), 2000);
            } catch (err) {
              console.warn('Clipboard API failed:', err);
              copyBtn.textContent = "❌ Copy failed";
            }
          });

          // Wire explore button to open Section Picker for the reported country
          const exploreBtn = document.getElementById("exploreCountryBtn");
          if (exploreBtn && country) {
            exploreBtn.textContent = `Explore ${country.name}`;
            exploreBtn.addEventListener("click", () => {
              // Hide success screen so modal is visible above it
              successScreen.classList.add("hidden");
              (window as any).openSectionPickerModal(countryId, country.name);
            });
          }

          form.classList.add("hidden");
          resultBox.classList.add("hidden");

        } else {
          resultBox.classList.remove("hidden");
          resultBox.textContent = `❌ Submission failed. ${data.message || "Please try again."}`;
        }

      } catch (err) {
        resultBox.classList.remove("hidden");
        resultBox.textContent = "❌ Submission failed. Please try again.";
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit";
        try {
          if ((window as any).turnstile && typeof (window as any).turnstile.reset === 'function') {
            (window as any).turnstile.reset();
          }
        } catch (error) {
          console.error('Turnstile reset failed:', error);
        }
      }
    }

    // --- Explicit Turnstile Rendering ---
    // With ?render=explicit mode, pass ALL config to render() function
    // Do NOT use data attributes when using explicit rendering
    function renderTurnstile() {
      if (typeof (window as any).turnstile === 'undefined') {
        console.warn('Turnstile not loaded yet, retrying...');
        setTimeout(renderTurnstile, 100);
        return;
      }

      try {
        const container = document.getElementById('reportTurnstile');
        if (container && !container.hasAttribute('data-rendered')) {
          // Pass selector and full config object
          // NOTE: Turnstile site key is PUBLIC by design (like reCAPTCHA site keys)
          // The SECRET key for verification is stored securely in Google Apps Script
          (window as any).turnstile.render('#reportTurnstile', {
            sitekey: '0x4AAAAAAB_ThEy2ACY1KEYQ', // Public site key - safe to expose client-side
            size: 'invisible',
            theme: 'light',
            callback: (window as any).onReportTurnstileSuccess  // Function reference
          });
          container.setAttribute('data-rendered', 'true');
          console.log('Turnstile widget rendered explicitly');
        }
      } catch (error) {
        console.error('Turnstile render error:', error);
      }
    }

    // --- Initialize ---
    // astro:page-load fires on initial load (with ClientRouter) and after each navigation
    document.addEventListener("astro:page-load", () => {
      // Render Turnstile widget
      renderTurnstile();

      // Initialize honeypot tracking
      sessionStorage.setItem('formLoadTime', Date.now().toString());
      sessionStorage.setItem('mouseMovements', '0');

      // Track focus on honeypot field
      if (hp) {
        hp.addEventListener('focus', function() {
          this.dataset.focused = 'true';
        });
      }

      // Track mouse movements
      let moveCount = 0;
      document.addEventListener('mousemove', () => {
        moveCount++;
        sessionStorage.setItem('mouseMovements', moveCount.toString());
      });

      // Populate countries
      loadCountries();

      // Initially disable area dropdown
      areaSelect.disabled = true;
      areaSelect.innerHTML = `<option>Select a country first</option>`;

      // Auto-memory: check if last country is saved
      const savedCountryId = getValidatedLocalStorage("ccw_selected_country", (val) => {
        return COUNTRIES.some(c => c.id === val);
      });
      if (savedCountryId) {
        const country = COUNTRIES.find((c) => c.id === savedCountryId);
        if (country) {
          countrySelect.value = savedCountryId;
          loadAreas(country);
        }
      }

      // Country change event
      countrySelect.addEventListener("change", (e) => {
        const selectedId = (e.target as HTMLSelectElement).value;

        localStorage.setItem("ccw_selected_country", selectedId);

        if (!selectedId) {
          areaSelect.disabled = true;
          areaSelect.innerHTML = `<option>Select a country first</option>`;
          return;
        }

        const country = COUNTRIES.find((c) => c.id === selectedId);
        loadAreas(country);
      });

      // Save area selection
      areaSelect.addEventListener("change", (e) => {
        const selectedArea = (e.target as HTMLSelectElement).value;
        if (selectedArea) {
          localStorage.setItem("ccw_selected_area", selectedArea);
        }
      });

      // Form submission
      form.addEventListener("submit", handleSubmit);
    });
  </script>
</Layout>
