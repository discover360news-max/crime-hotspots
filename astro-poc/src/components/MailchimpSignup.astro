---
/**
 * Email Signup Component
 * Collects email + area name via Google Apps Script endpoint
 * Stores signups in "Email Signups" Google Sheet
 */

interface Props {
  areaName?: string;
}

const { areaName } = Astro.props;
---

<div class="email-signup bg-white/70 dark:bg-[hsl(0_0%_8%)]/70 backdrop-blur-md rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] p-5">
  <div class="flex items-start gap-3">
    <svg class="w-5 h-5 text-rose-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
    </svg>
    <div class="flex-1">
      <h3 class="text-sm font-semibold text-slate-800 dark:text-[hsl(0_0%_90%)] mb-1">
        {areaName ? `Get updates for ${areaName}` : 'Get crime updates'}
      </h3>
      <p class="text-xs text-slate-500 dark:text-[hsl(0_0%_55%)] mb-3">
        Receive weekly crime summaries and safety alerts. No spam.
      </p>

      <form class="email-signup-form flex gap-2" data-area={areaName || ''}>
        {/* Honeypot - hidden anti-spam field */}
        <div style="position: absolute; left: -5000px;" aria-hidden="true">
          <input type="text" name="honeypot" tabindex="-1" value="" />
        </div>

        <input
          type="email"
          name="email"
          required
          placeholder="your@email.com"
          class="flex-1 px-3 py-2 rounded-lg border border-slate-300 dark:border-[hsl(0_0%_22%)] bg-white dark:bg-[hsl(0_0%_5%)] text-sm text-slate-700 dark:text-[hsl(0_0%_90%)] placeholder-slate-400 dark:placeholder-[hsl(0_0%_40%)] focus:outline-none focus:ring-2 focus:ring-rose-300 focus:border-rose-300"
        />
        <button
          type="submit"
          class="email-signup-btn px-4 py-2 rounded-lg bg-rose-600 text-white text-xs font-medium hover:bg-rose-700 active:bg-rose-800 transition"
        >
          Subscribe
        </button>
      </form>

      <p class="email-signup-status text-xs mt-2 text-slate-400 dark:text-[hsl(0_0%_50%)]">
        Free. Unsubscribe anytime.
      </p>
    </div>
  </div>
</div>

<script is:inline>
  document.querySelectorAll('.email-signup-form').forEach(function(form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      var honeypot = form.querySelector('[name="honeypot"]');
      if (honeypot && honeypot.value) return;

      var emailInput = form.querySelector('[name="email"]');
      var email = emailInput.value.trim();
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        updateStatus(form, 'Please enter a valid email.', 'text-rose-500');
        return;
      }

      var area = form.dataset.area || 'Unknown';
      var btn = form.querySelector('.email-signup-btn');
      btn.disabled = true;
      btn.textContent = '...';

      var url = 'https://script.google.com/macros/s/AKfycbzIvXmh2o1unXQFKsNNesdBvGuV4PBln78YPO4L0MGZ1pgUJsUm1pyqbJrE3thKYdGA/exec';

      fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify({ email: email, area: area })
      })
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.success) {
          updateStatus(form, 'Subscribed! You\'ll receive updates soon.', 'text-emerald-600');
          emailInput.value = '';
          emailInput.disabled = true;
          btn.textContent = 'Done';
        } else {
          updateStatus(form, data.error || 'Something went wrong. Try again.', 'text-rose-500');
          btn.disabled = false;
          btn.textContent = 'Subscribe';
        }
      })
      .catch(function() {
        updateStatus(form, 'Network error. Please try again.', 'text-rose-500');
        btn.disabled = false;
        btn.textContent = 'Subscribe';
      });
    });
  });

  function updateStatus(form, message, colorClass) {
    var status = form.closest('.email-signup').querySelector('.email-signup-status');
    if (status) {
      status.textContent = message;
      status.className = 'email-signup-status text-xs mt-2 ' + colorClass;
    }
  }
</script>
