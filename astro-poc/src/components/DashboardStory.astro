---
/**
 * DashboardStory — narrative summary at the top of the dashboard
 * "This week: 47 incidents across Trinidad. Laventille leads with 8."
 * Server-rendered, compact, zero interactivity
 */
import type { Crime } from '../lib/crimeData';
import { getHotAreas } from '../lib/trendingHelpers';
import { countCrimeType } from '../lib/dashboardHelpers';

interface Props {
  allCrimes: Crime[];
}

const { allCrimes } = Astro.props;

// This week's crimes
const now = new Date();
const weekAgo = new Date();
weekAgo.setDate(now.getDate() - 7);
const twoWeeksAgo = new Date();
twoWeeksAgo.setDate(now.getDate() - 14);

const thisWeekCrimes = allCrimes.filter(c => c.dateObj >= weekAgo);
const lastWeekCrimes = allCrimes.filter(c => c.dateObj >= twoWeeksAgo && c.dateObj < weekAgo);

// Top area this week
const hotAreas = getHotAreas(allCrimes, 1);
const topArea = hotAreas[0];

// Murders comparison — uses countCrimeType which correctly:
// - Applies victimCount for primary Murder (double murder = 2)
// - Counts each "Murder" occurrence in related crimes (Murder, Murder = 2)
// - Does NOT use victimCount when Murder is a related crime (robbery victimCount won't inflate murder stats)
const murdersThisWeek = countCrimeType(thisWeekCrimes, 'Murder');
const murdersLastWeek = countCrimeType(lastWeekCrimes, 'Murder');
const murderChange = murdersLastWeek > 0
  ? Math.round(((murdersThisWeek - murdersLastWeek) / murdersLastWeek) * 100)
  : 0;

// Overall week change
const weekChange = lastWeekCrimes.length > 0
  ? Math.round(((thisWeekCrimes.length - lastWeekCrimes.length) / lastWeekCrimes.length) * 100)
  : 0;
---

{thisWeekCrimes.length > 0 && (
  <div class="rounded-lg border border-slate-200 dark:border-[hsl(0_0%_15%)] bg-white/70 dark:bg-[hsl(0_0%_5%)] p-3 mb-4">
    <div class="flex items-start gap-2">
      <span class="relative flex h-2 w-2 mt-1.5 shrink-0">
        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span>
        <span class="relative inline-flex rounded-full h-2 w-2 bg-rose-500"></span>
      </span>
      <p class="text-sm text-slate-600 dark:text-[hsl(0_0%_80%)] leading-relaxed">
        This week: <span class="font-bold text-slate-700 dark:text-[hsl(0_0%_90%)]">{thisWeekCrimes.length} incidents</span> reported
        across Trinidad{weekChange !== 0 && (
          <span class={weekChange > 0 ? 'text-rose-600' : 'text-emerald-600'}>
            {' '}({weekChange > 0 ? '+' : ''}{weekChange}% vs last week)
          </span>
        )}.
        {topArea && (
          <> <span class="font-medium">{topArea.area}</span> leads with {topArea.count}.</>
        )}
        {murdersThisWeek > 0 && murderChange !== 0 && (
          <> Murders <span class={murderChange > 0 ? 'font-medium text-rose-600' : 'font-medium text-emerald-600'}>
            {`${murderChange > 0 ? 'up' : 'down'} ${Math.abs(murderChange)}%`}
          </span> week-over-week.</>
        )}
      </p>
    </div>
  </div>
)}
