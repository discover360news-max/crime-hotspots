---
/**
 * Blog Rotating Banner Component
 * Auto-rotates through latest blog posts for a specific country
 * Links to blog listing page
 */

import { getCollection } from 'astro:content';

interface Props {
  country: 'tt' | 'gy'; // Country code to filter blog posts
  limit?: number; // Number of posts to rotate (default: 3)
}

const { country, limit = 3 } = Astro.props;

// Fetch latest blog posts for this country
const allPosts = await getCollection('blog', ({ data }) => data.country === country);
const latestPosts = allPosts
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, limit);

// If no posts, don't render
if (latestPosts.length === 0) return null;
---

<div
  class="blog-rotating-banner border border-slate-600 rounded-lg px-3 py-1 md:px-4 md:py-2 mb-4 overflow-hidden"
  data-post-count={latestPosts.length}
>
  <a href="/blog" class="flex items-center gap-2 md:gap-3 group">
    <!-- Horn Icon -->
    <div class="flex-shrink-0">
      <svg
        class="w-4 h-4 md:w-5 md:h-5 text-slate-600"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
        aria-hidden="true"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"
        />
      </svg>
    </div>

    <!-- Rotating Blog Titles -->
    <div class="flex-1 min-w-0 relative h-5 md:h-6 overflow-hidden">
      {latestPosts.map((post, index) => (
        <div
          class="blog-title absolute inset-0 flex items-center transition-all duration-500"
          data-index={index}
          style={index === 0 ? 'opacity: 1; transform: translateY(0);' : 'opacity: 0; transform: translateY(100%);'}
        >
          <span class="text-xs md:text-sm font-medium text-slate-600 group-hover:underline truncate">
            {post.data.title}
          </span>
        </div>
      ))}
    </div>

    <!-- Arrow Icon (indicates clickable) -->
    <div class="flex-shrink-0">
      <svg
        class="w-4 h-4 text-slate-600 group-hover:translate-x-1 transition-transform"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 5l7 7-7 7"
        />
      </svg>
    </div>
  </a>
</div>

<script>
  function initBlogRotator() {
    const banner = document.querySelector('.blog-rotating-banner');
    if (!banner) return;

    const titles = banner.querySelectorAll('.blog-title');
    const postCount = parseInt(banner.getAttribute('data-post-count') || '0');

    // Only rotate if there are multiple posts
    if (postCount <= 1) return;

    let currentIndex = 0;

    function rotateTitles() {
      // Hide current title (slide up and fade out)
      titles[currentIndex].style.opacity = '0';
      titles[currentIndex].style.transform = 'translateY(-100%)';

      // Move to next title
      currentIndex = (currentIndex + 1) % postCount;

      // Show next title (slide up from bottom and fade in)
      titles[currentIndex].style.opacity = '1';
      titles[currentIndex].style.transform = 'translateY(0)';
    }

    // Rotate every 5 seconds
    setInterval(rotateTitles, 5000);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initBlogRotator);

  // Re-initialize after view transitions (Astro feature)
  document.addEventListener('astro:page-load', initBlogRotator);
</script>

<style>
  .blog-rotating-banner {
    background: linear-gradient(to right, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.9));
    backdrop-filter: blur(10px);
  }

  .blog-title {
    will-change: transform, opacity;
  }
</style>
