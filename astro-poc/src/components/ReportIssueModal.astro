---
/**
 * Report Issue Modal Component
 * Allows users to report incorrect/incomplete crime information
 * Pre-fills crime data and lets users describe the issue
 */

import { APPS_SCRIPT_URL } from '../data/countries';

interface Props {
  crimeSlug: string;
  crimeHeadline: string;
  crimeDate: string;
  crimeType: string;
  crimeArea: string;
  crimeRegion: string;
  crimeStreet?: string;
  crimeSummary?: string;
  crimeSource?: string;
  crimeUrl?: string;
  idPrefix?: string; // Unique prefix for IDs to prevent duplicates when multiple instances exist
  showButton?: boolean; // Whether to render the trigger button (default: false)
}

const {
  crimeSlug,
  crimeHeadline,
  crimeDate,
  crimeType,
  crimeArea,
  crimeRegion,
  crimeStreet,
  crimeSummary,
  crimeSource,
  crimeUrl,
  idPrefix = '', // Default to empty string
  showButton = false // Default to not showing button
} = Astro.props;
---

<!-- Report Issue Button (only render if showButton is true) -->
{showButton && (
  <button
    id={`${idPrefix}reportIssueBtn`}
    class="px-4 py-1.5 min-h-[22px] flex items-center justify-center gap-2 border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs whitespace-nowrap"
  >
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </svg>
    Report Issue
  </button>
)}

<!-- Modal Overlay -->
<div
  id={`${idPrefix}reportIssueModal`}
  class="fixed inset-0 bg-black/50 z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4"
>
  <!-- Modal Content -->
  <div
    id={`${idPrefix}reportIssueContent`}
    class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto opacity-0 scale-95 transition-all duration-300"
  >
    <!-- Modal Header -->
    <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
      <h2 class="text-h2 font-bold text-slate-700">Report Issue</h2>
      <button
        id={`${idPrefix}closeModalBtn`}
        class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 active:bg-slate-200 transition text-slate-500 hover:text-slate-700"
        aria-label="Close"
      >
        <span class="text-2xl leading-none">×</span>
      </button>
    </div>

    <!-- Form -->
    <form id={`${idPrefix}reportIssueForm`} class="p-6 space-y-6">
      <!-- Crime Info Preview -->
      <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
        <p class="text-xs font-semibold text-slate-500 mb-2">Reporting issue for:</p>
        <p class="text-sm font-semibold text-slate-700">{crimeHeadline}</p>
        <p class="text-xs text-slate-500 mt-1">{crimeDate} • {crimeArea}</p>
      </div>

      <!-- Issue Type Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          What's wrong? <span class="text-rose-600">*</span>
        </label>
        <div class="space-y-2">
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Incorrect Headline/Summary"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Incorrect Headline/Summary</span>
          </label>
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Wrong Date/Location"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Wrong Date/Location</span>
          </label>
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Duplicate Entry"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Duplicate Entry</span>
          </label>
        </div>
      </div>

      <!-- Information Source -->
      <div>
        <label for="informationSource" class="block text-sm font-semibold text-slate-700 mb-2">
          Source of Your Information <span class="text-rose-600">*</span>
        </label>
        <select
          id="informationSource"
          name="informationSource"
          required
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent"
        >
          <option value="">Select a source</option>
          <option value="Eye-witness">Eye-witness</option>
          <option value="News Article">News Article (different source)</option>
          <option value="Social Media">Social Media</option>
          <option value="Local Knowledge">Local Knowledge</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Description -->
      <div>
        <label for="issueDescription" class="block text-sm font-semibold text-slate-700 mb-2">
          Please describe the issue <span class="text-rose-600">*</span>
        </label>
        <textarea
          id="issueDescription"
          name="issueDescription"
          required
          rows="4"
          placeholder="Provide details about what's incorrect and what the correct information should be..."
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent resize-none"
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">Minimum 20 characters</p>
      </div>

      <!-- Contact Email (Optional) -->
      <div>
        <label for="contactEmail" class="block text-sm font-semibold text-slate-700 mb-2">
          Contact Email (Optional)
        </label>
        <input
          type="email"
          id="contactEmail"
          name="contactEmail"
          placeholder="your@email.com"
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent"
        />
        <p class="text-xs text-slate-500 mt-1">If you'd like us to follow up with you</p>
      </div>

      <!-- Hidden fields with crime data -->
      <input type="hidden" name="crimeSlug" value={crimeSlug} />
      <input type="hidden" name="crimeHeadline" value={crimeHeadline} />
      <input type="hidden" name="crimeDate" value={crimeDate} />
      <input type="hidden" name="crimeType" value={crimeType} />
      <input type="hidden" name="crimeArea" value={crimeArea} />
      <input type="hidden" name="crimeRegion" value={crimeRegion} />
      {crimeStreet && <input type="hidden" name="crimeStreet" value={crimeStreet} />}
      {crimeSummary && <input type="hidden" name="crimeSummary" value={crimeSummary} />}
      {crimeSource && <input type="hidden" name="crimeSource" value={crimeSource} />}
      {crimeUrl && <input type="hidden" name="crimeUrl" value={crimeUrl} />}

      <!-- Turnstile container - widget will be rendered explicitly when modal opens -->
      <!-- CRITICAL: cf-turnstile class is REQUIRED even with explicit rendering -->
      <div id={`${idPrefix}reportIssueTurnstile`} class="cf-turnstile"></div>

      <!-- Result Message -->
      <div id={`${idPrefix}reportIssueResult`} class="hidden p-4 rounded-lg border"></div>

      <!-- Submit Button -->
      <div class="flex gap-3 justify-end">
        <button
          type="button"
          id={`${idPrefix}cancelReportBtn`}
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 transition font-medium text-xs"
        >
          Cancel
        </button>
        <button
          type="submit"
          id={`${idPrefix}submitReportBtn`}
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg bg-rose-600 text-white hover:bg-rose-700 active:bg-rose-800 transition font-medium text-xs"
        >
          Submit Report
        </button>
      </div>
    </form>
  </div>
</div>

<script is:inline>
  // Global callback for Turnstile success (Report Issue Modal)
  window.onReportIssueTurnstileSuccess = function(token) {
    console.log('Report Issue Turnstile ready:', token ? 'Yes' : 'No');
  };
</script>

<script define:vars={{ idPrefix, APPS_SCRIPT_URL }}>
  // Wrap everything in DOMContentLoaded to ensure DOM is ready
  document.addEventListener('DOMContentLoaded', () => {

    const openBtn = document.getElementById(`${idPrefix}reportIssueBtn`);
    const closeBtn = document.getElementById(`${idPrefix}closeModalBtn`);
    const cancelBtn = document.getElementById(`${idPrefix}cancelReportBtn`);
    const modal = document.getElementById(`${idPrefix}reportIssueModal`);
    const modalContent = document.getElementById(`${idPrefix}reportIssueContent`);
    const form = document.getElementById(`${idPrefix}reportIssueForm`);
    const resultBox = document.getElementById(`${idPrefix}reportIssueResult`);
    const submitBtn = document.getElementById(`${idPrefix}submitReportBtn`);

    console.log('ReportIssueModal DEBUG:', {
      idPrefix: idPrefix || '(empty)',
      buttonId: `${idPrefix}reportIssueBtn`,
      openBtn: openBtn,
      modal: modal
    });

    let turnstileRendered = false;

  // Render Turnstile widget explicitly
  function renderTurnstileWidget() {
    if (turnstileRendered) return;

    if (typeof window.turnstile === 'undefined') {
      console.warn('Turnstile not loaded yet, retrying...');
      setTimeout(renderTurnstileWidget, 100);
      return;
    }

    try {
      const container = document.getElementById(`${idPrefix}reportIssueTurnstile`);
      if (container && !container.hasAttribute('data-rendered')) {
        // NOTE: Turnstile site key is PUBLIC by design (like reCAPTCHA site keys)
        // The SECRET key for verification is stored securely in Google Apps Script
        window.turnstile.render(container, {
          sitekey: '0x4AAAAAAB_ThEy2ACY1KEYQ', // Public site key - safe to expose client-side
          theme: 'light',
          callback: window.onReportIssueTurnstileSuccess  // Function reference, not string
        });
        container.setAttribute('data-rendered', 'true');
        turnstileRendered = true;
        console.log(`Report Issue Turnstile widget rendered (${idPrefix || 'default'})`);
      }
    } catch (error) {
      console.error('Turnstile render error:', error);
    }
  }

  // Open modal
  openBtn?.addEventListener('click', () => {
    console.log('Report Issue button clicked!', { modal, modalContent });
    if (modal && modalContent) {
      modal.classList.remove('invisible', 'opacity-0');
      modal.classList.add('visible', 'opacity-100');
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      }, 50);

      // Render Turnstile when modal opens
      renderTurnstileWidget();
    }
  });

  // Listen for custom event from CrimeDetailModal to trigger Turnstile rendering
  window.addEventListener('openReportIssueModal', (e) => {
    console.log('openReportIssueModal event received', e.detail);
    renderTurnstileWidget();
  });

  // Close modal function
  function closeModal() {
    if (modal && modalContent) {
      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        modal.classList.remove('visible', 'opacity-100');
        modal.classList.add('invisible', 'opacity-0');
      }, 300);
    }
  }

  // Close button
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  // Close on overlay click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!resultBox || !submitBtn) return;

    const formData = new FormData(form);

    // Validate at least one issue type selected
    const issueTypes = formData.getAll('issueType');
    if (issueTypes.length === 0) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Please select at least one issue type</p>';
      return;
    }

    // Validate description length
    const description = formData.get('issueDescription');
    if (description && description.toString().trim().length < 20) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Please provide at least 20 characters in the description</p>';
      return;
    }

    // Validate Turnstile token
    const turnstileToken = formData.get('cf-turnstile-response');
    if (!turnstileToken) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Security validation required. Please refresh the page.</p>';
      return;
    }

    // Prepare payload
    const payload = {
      reportType: 'crime-issue',
      issueTypes: issueTypes,
      informationSource: formData.get('informationSource'),
      description: description,
      contactEmail: formData.get('contactEmail'),
      // Crime data
      crimeSlug: formData.get('crimeSlug'),
      crimeHeadline: formData.get('crimeHeadline'),
      crimeDate: formData.get('crimeDate'),
      crimeType: formData.get('crimeType'),
      crimeArea: formData.get('crimeArea'),
      crimeRegion: formData.get('crimeRegion'),
      crimeStreet: formData.get('crimeStreet'),
      crimeSummary: formData.get('crimeSummary'),
      crimeSource: formData.get('crimeSource'),
      crimeUrl: formData.get('crimeUrl'),
      // Security (backend expects 'cf-token')
      'cf-token': turnstileToken,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent
    };

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    resultBox.classList.add('hidden');

    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (data.success) {
        resultBox.classList.remove('hidden', 'bg-rose-50', 'border-rose-200');
        resultBox.classList.add('bg-emerald-50', 'border-emerald-200');
        resultBox.innerHTML = '<p class="text-emerald-700 text-sm font-semibold">✓ Thank you! Your report has been submitted.</p><p class="text-emerald-600 text-xs mt-1">We\'ll review this information and update the record if needed.</p>';

        // Reset form after 2 seconds
        setTimeout(() => {
          form.reset();
          closeModal();
          resultBox.classList.add('hidden');
        }, 3000);
      } else {
        throw new Error(data.message || 'Submission failed');
      }
    } catch (error) {
      console.error('Submission error:', error);
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">❌ Submission failed. Please try again.</p>';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Report';
    }
  });
  }); // End DOMContentLoaded
</script>
