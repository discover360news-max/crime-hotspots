---
/**
 * Report Issue Modal Component
 * Allows users to report incorrect/incomplete crime information
 * Pre-fills crime data and lets users describe the issue
 */

interface Props {
  crimeSlug: string;
  crimeHeadline: string;
  crimeDate: string;
  crimeType: string;
  crimeArea: string;
  crimeRegion: string;
  crimeStreet?: string;
  crimeSummary?: string;
  crimeSource?: string;
  crimeUrl?: string;
}

const {
  crimeSlug,
  crimeHeadline,
  crimeDate,
  crimeType,
  crimeArea,
  crimeRegion,
  crimeStreet,
  crimeSummary,
  crimeSource,
  crimeUrl
} = Astro.props;
---

<!-- Report Issue Button -->
<button
  id="reportIssueBtn"
  class="px-4 py-1.5 min-h-[22px] flex items-center justify-center gap-2 border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 transition font-medium text-xs whitespace-nowrap"
>
  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
  </svg>
  Report Issue
</button>

<!-- Modal Overlay -->
<div
  id="reportIssueModal"
  class="fixed inset-0 bg-black/50 z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4"
>
  <!-- Modal Content -->
  <div
    id="reportIssueContent"
    class="bg-white rounded-xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto opacity-0 scale-95 transition-all duration-300"
  >
    <!-- Modal Header -->
    <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
      <h2 class="text-h2 font-bold text-slate-700">Report Issue</h2>
      <button
        id="closeModalBtn"
        class="w-8 h-8 flex items-center justify-center rounded hover:bg-slate-100 transition text-slate-500 hover:text-slate-700"
        aria-label="Close"
      >
        <span class="text-2xl leading-none">×</span>
      </button>
    </div>

    <!-- Form -->
    <form id="reportIssueForm" class="p-6 space-y-6">
      <!-- Crime Info Preview -->
      <div class="p-4 bg-slate-50 rounded-lg border border-slate-200">
        <p class="text-xs font-semibold text-slate-500 mb-2">Reporting issue for:</p>
        <p class="text-sm font-semibold text-slate-700">{crimeHeadline}</p>
        <p class="text-xs text-slate-500 mt-1">{crimeDate} • {crimeArea}</p>
      </div>

      <!-- Issue Type Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-700 mb-2">
          What's wrong? <span class="text-rose-600">*</span>
        </label>
        <div class="space-y-2">
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Incorrect Headline/Summary"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Incorrect Headline/Summary</span>
          </label>
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Wrong Date/Location"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Wrong Date/Location</span>
          </label>
          <label class="flex items-start gap-2 cursor-pointer">
            <input
              type="checkbox"
              name="issueType"
              value="Duplicate Entry"
              class="mt-1"
            />
            <span class="text-sm text-slate-700">Duplicate Entry</span>
          </label>
        </div>
      </div>

      <!-- Information Source -->
      <div>
        <label for="informationSource" class="block text-sm font-semibold text-slate-700 mb-2">
          Source of Your Information <span class="text-rose-600">*</span>
        </label>
        <select
          id="informationSource"
          name="informationSource"
          required
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent"
        >
          <option value="">Select a source</option>
          <option value="Eye-witness">Eye-witness</option>
          <option value="News Article">News Article (different source)</option>
          <option value="Social Media">Social Media</option>
          <option value="Local Knowledge">Local Knowledge</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <!-- Description -->
      <div>
        <label for="issueDescription" class="block text-sm font-semibold text-slate-700 mb-2">
          Please describe the issue <span class="text-rose-600">*</span>
        </label>
        <textarea
          id="issueDescription"
          name="issueDescription"
          required
          rows="4"
          placeholder="Provide details about what's incorrect and what the correct information should be..."
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent resize-none"
        ></textarea>
        <p class="text-xs text-slate-500 mt-1">Minimum 20 characters</p>
      </div>

      <!-- Contact Email (Optional) -->
      <div>
        <label for="contactEmail" class="block text-sm font-semibold text-slate-700 mb-2">
          Contact Email (Optional)
        </label>
        <input
          type="email"
          id="contactEmail"
          name="contactEmail"
          placeholder="your@email.com"
          class="w-full px-3 py-2 border border-slate-300 rounded-lg text-sm text-slate-700 focus:ring-2 focus:ring-rose-600 focus:border-transparent"
        />
        <p class="text-xs text-slate-500 mt-1">If you'd like us to follow up with you</p>
      </div>

      <!-- Hidden fields with crime data -->
      <input type="hidden" name="crimeSlug" value={crimeSlug} />
      <input type="hidden" name="crimeHeadline" value={crimeHeadline} />
      <input type="hidden" name="crimeDate" value={crimeDate} />
      <input type="hidden" name="crimeType" value={crimeType} />
      <input type="hidden" name="crimeArea" value={crimeArea} />
      <input type="hidden" name="crimeRegion" value={crimeRegion} />
      {crimeStreet && <input type="hidden" name="crimeStreet" value={crimeStreet} />}
      {crimeSummary && <input type="hidden" name="crimeSummary" value={crimeSummary} />}
      {crimeSource && <input type="hidden" name="crimeSource" value={crimeSource} />}
      {crimeUrl && <input type="hidden" name="crimeUrl" value={crimeUrl} />}

      <!-- Cloudflare Turnstile CAPTCHA -->
      <div class="cf-turnstile"
           data-sitekey="0x4AAAAAAB_ThEy2ACY1KEYQ"
           data-theme="light"></div>

      <!-- Result Message -->
      <div id="reportIssueResult" class="hidden p-4 rounded-lg border"></div>

      <!-- Submit Button -->
      <div class="flex gap-3 justify-end">
        <button
          type="button"
          id="cancelReportBtn"
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-50 transition font-medium text-xs"
        >
          Cancel
        </button>
        <button
          type="submit"
          id="submitReportBtn"
          class="px-4 py-1.5 min-h-[22px] flex items-center justify-center rounded-lg bg-rose-600 text-white hover:bg-rose-700 transition font-medium text-xs"
        >
          Submit Report
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Turnstile TypeScript declaration
  declare global {
    interface Window {
      turnstile: {
        render: (container: Element, options: { sitekey: string; theme: string }) => string;
        reset: (widgetId: string) => void;
      };
    }
  }

  // Google Apps Script endpoint (same as reportStandalone.js)
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbysi5VEpdS2nL9Ci9BWTn0ydXWA_IdR7j_3MR_EW5uK92N62xbt5OB0sKu2wMLGhkb7/exec";

  const openBtn = document.getElementById('reportIssueBtn');
  const closeBtn = document.getElementById('closeModalBtn');
  const cancelBtn = document.getElementById('cancelReportBtn');
  const modal = document.getElementById('reportIssueModal');
  const modalContent = document.getElementById('reportIssueContent');
  const form = document.getElementById('reportIssueForm') as HTMLFormElement;
  const resultBox = document.getElementById('reportIssueResult');
  const submitBtn = document.getElementById('submitReportBtn');

  let turnstileWidgetId: string | null = null;

  // Open modal
  openBtn?.addEventListener('click', () => {
    if (modal && modalContent) {
      modal.classList.remove('invisible', 'opacity-0');
      modal.classList.add('visible', 'opacity-100');
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');

        // Render Turnstile widget when modal becomes visible
        if (typeof window.turnstile !== 'undefined' && !turnstileWidgetId) {
          const turnstileContainer = document.querySelector('.cf-turnstile');
          if (turnstileContainer && !turnstileContainer.hasChildNodes()) {
            turnstileWidgetId = window.turnstile.render(turnstileContainer, {
              sitekey: '0x4AAAAAAB_ThEy2ACY1KEYQ',
              theme: 'light',
            });
          }
        }
      }, 50);
    }
  });

  // Close modal function
  function closeModal() {
    if (modal && modalContent) {
      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        modal.classList.remove('visible', 'opacity-100');
        modal.classList.add('invisible', 'opacity-0');

        // Reset Turnstile widget when modal closes
        if (typeof window.turnstile !== 'undefined' && turnstileWidgetId) {
          window.turnstile.reset(turnstileWidgetId);
        }
      }, 300);
    }
  }

  // Close button
  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  // Close on overlay click
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Form submission
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!resultBox || !submitBtn) return;

    const formData = new FormData(form);

    // Validate at least one issue type selected
    const issueTypes = formData.getAll('issueType');
    if (issueTypes.length === 0) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Please select at least one issue type</p>';
      return;
    }

    // Validate description length
    const description = formData.get('issueDescription') as string;
    if (description.trim().length < 20) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Please provide at least 20 characters in the description</p>';
      return;
    }

    // Validate Turnstile token
    const turnstileToken = formData.get('cf-turnstile-response') as string;
    if (!turnstileToken) {
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">Security validation required. Please refresh the page.</p>';
      return;
    }

    // Prepare payload
    const payload = {
      reportType: 'crime-issue',
      issueTypes: issueTypes,
      informationSource: formData.get('informationSource'),
      description: description,
      contactEmail: formData.get('contactEmail'),
      // Crime data
      crimeSlug: formData.get('crimeSlug'),
      crimeHeadline: formData.get('crimeHeadline'),
      crimeDate: formData.get('crimeDate'),
      crimeType: formData.get('crimeType'),
      crimeArea: formData.get('crimeArea'),
      crimeRegion: formData.get('crimeRegion'),
      crimeStreet: formData.get('crimeStreet'),
      crimeSummary: formData.get('crimeSummary'),
      crimeSource: formData.get('crimeSource'),
      crimeUrl: formData.get('crimeUrl'),
      // Security (backend expects 'cf-token')
      'cf-token': turnstileToken,
      timestamp: new Date().toISOString(),
      userAgent: navigator.userAgent
    };

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
    resultBox.classList.add('hidden');

    try {
      const response = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (data.success) {
        resultBox.classList.remove('hidden', 'bg-rose-50', 'border-rose-200');
        resultBox.classList.add('bg-emerald-50', 'border-emerald-200');
        resultBox.innerHTML = '<p class="text-emerald-700 text-sm font-semibold">✓ Thank you! Your report has been submitted.</p><p class="text-emerald-600 text-xs mt-1">We\'ll review this information and update the record if needed.</p>';

        // Reset form after 2 seconds
        setTimeout(() => {
          form.reset();
          closeModal();
          resultBox.classList.add('hidden');
        }, 3000);
      } else {
        throw new Error(data.message || 'Submission failed');
      }
    } catch (error) {
      console.error('Submission error:', error);
      resultBox.classList.remove('hidden', 'bg-emerald-50', 'border-emerald-200');
      resultBox.classList.add('bg-rose-50', 'border-rose-200');
      resultBox.innerHTML = '<p class="text-rose-700 text-sm">❌ Submission failed. Please try again.</p>';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Report';
    }
  });
</script>
