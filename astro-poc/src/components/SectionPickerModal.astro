---
/**
 * Section Picker Modal
 * Shows available sections for a selected island on the homepage
 * Sections are driven dynamically from countries.ts config
 */
import { COUNTRIES } from '../data/countries';

const availableCountries = COUNTRIES.filter(c => c.available && c.sections?.length);
---

<!-- Modal Overlay -->
<div
  id="sectionPickerModal"
  class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 opacity-0 invisible transition-all duration-300 flex items-center justify-center p-4"
  data-pagefind-ignore
>
  <!-- Modal Content -->
  <div
    id="sectionPickerModalContent"
    class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl max-w-md w-full opacity-0 scale-95 transition-all duration-300"
  >
    <!-- Header -->
    <div class="sticky top-0 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 py-4 flex items-center justify-between rounded-t-2xl">
      <h2 id="sectionPickerTitle" class="text-h2 font-bold text-slate-700">Select Section</h2>
      <button
        id="closeSectionPickerModal"
        class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-slate-100 active:bg-slate-200 transition text-slate-500 hover:text-slate-700"
        aria-label="Close"
      >
        <span class="text-2xl leading-none">&times;</span>
      </button>
    </div>

    <!-- Section Buttons (one container per country, toggled by JS) -->
    {availableCountries.map((country) => (
      <div
        class="section-picker-list hidden p-6 space-y-3 max-h-[60vh] overflow-y-auto"
        data-country-id={country.id}
      >
        {country.sections!.map((section) => (
          <a
            href={section.url}
            class="group relative bg-white/80 backdrop-blur-md border-2 border-slate-200 rounded-lg p-4 hover:border-rose-600 hover:shadow-lg transition-all duration-300 flex items-center justify-between"
          >
            <div>
              <h3 class="text-small font-bold text-slate-700 group-hover:text-rose-600 transition mb-1">
                {section.label}
              </h3>
              <p class="text-xs text-slate-500">{section.description}</p>
            </div>
            <svg class="w-5 h-5 text-slate-400 group-hover:text-rose-600 group-hover:translate-x-1 transition shrink-0 ml-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ))}
      </div>
    ))}

    <!-- Footer Help Text -->
    <div class="px-6 pb-6 pt-2">
      <p class="text-xs text-slate-500 text-center">
        Don't see your island? <a href="/report" class="text-rose-600 hover:text-rose-700 underline">Submit a report</a> to help us expand.
      </p>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('sectionPickerModal');
  const modalContent = document.getElementById('sectionPickerModalContent');
  const closeBtn = document.getElementById('closeSectionPickerModal');
  const titleEl = document.getElementById('sectionPickerTitle');
  const sectionLists = document.querySelectorAll('.section-picker-list');

  // Country names lookup (built from data attributes)
  const countryNames: Record<string, string> = {};
  document.querySelectorAll<HTMLElement>('[data-section-country-name]').forEach(el => {
    const id = el.dataset.sectionCountryId;
    const name = el.dataset.sectionCountryName;
    if (id && name) countryNames[id] = name;
  });

  // Global function to open modal for a specific country
  (window as any).openSectionPickerModal = function(countryId: string, countryName: string) {
    if (!modal || !modalContent) return;

    // Update title
    if (titleEl) titleEl.textContent = countryName;

    // Show the correct section list
    sectionLists.forEach(list => {
      if ((list as HTMLElement).dataset.countryId === countryId) {
        list.classList.remove('hidden');
      } else {
        list.classList.add('hidden');
      }
    });

    // Animate in
    modal.classList.remove('invisible', 'opacity-0');
    modal.classList.add('visible', 'opacity-100');
    setTimeout(() => {
      modalContent.classList.remove('opacity-0', 'scale-95');
      modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
  };

  function closeModal() {
    if (!modal || !modalContent) return;
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => {
      modal.classList.remove('visible', 'opacity-100');
      modal.classList.add('invisible', 'opacity-0');
    }, 300);
  }

  closeBtn?.addEventListener('click', closeModal);

  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('visible')) {
      closeModal();
    }
  });
</script>
