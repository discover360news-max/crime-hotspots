---
/**
 * CrimeDetailModal Component
 * Modal that displays full crime details without navigating away
 * Keeps SEO benefits while improving UX
 */
import ReportIssueModal from './ReportIssueModal.astro';
---

<!-- Modal Backdrop -->
<div id="crimeDetailBackdrop" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300 pointer-events-none"></div>

<!-- Modal -->
<div id="crimeDetailModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
  <div id="crimeDetailContent" class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
    <!-- Modal Header -->
    <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between rounded-t-2xl">
      <h2 class="text-lg font-bold text-slate-700">Crime Details</h2>
      <button id="closeCrimeDetailBtn" class="p-2 rounded-full text-slate-600 hover:bg-slate-100 active:bg-slate-200 transition-all" aria-label="Close modal">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <!-- Headline -->
      <h1 id="modalHeadline" class="text-2xl font-bold text-slate-700 mb-4"></h1>

      <!-- Metadata -->
      <div id="modalMetadata" class="flex flex-wrap items-center gap-3 text-xs mb-6"></div>

      <!-- Summary -->
      <div id="modalSummary" class="mb-6"></div>

      <!-- Details Grid -->
      <div id="modalDetails" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 p-4 bg-slate-50 rounded-lg"></div>

      <!-- Safety Context -->
      <div id="modalSafetyContext" class="mt-6 mb-6"></div>

      <!-- Action Buttons -->
      <div class="flex flex-col gap-3 pt-4 border-t border-slate-200">
        <div class="flex items-center gap-3">
          <a id="modalViewFullBtn" href="#" class="flex-1 px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 active:bg-rose-800 transition text-sm font-medium text-center">
            View Full Page
          </a>
          <a id="modalSourceBtn" href="#" target="_blank" rel="noopener noreferrer" class="flex-1 px-4 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition text-sm font-medium flex items-center justify-center gap-2">
            Read Original
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </div>

        <!-- Report Issue Button -->
        <button id="modalReportIssueBtn" class="w-full px-4 py-1.5 min-h-[22px] flex items-center justify-center gap-2 border border-rose-600 text-rose-600 rounded-lg hover:bg-rose-50 active:bg-rose-100 transition font-medium text-xs">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Report Issue with This Crime
        </button>

        <!-- Share Section -->
        <div class="flex items-center gap-2">
          <span class="text-xs text-slate-500">Share:</span>
          <button id="shareTwitterBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on X (Twitter)">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </button>
          <button id="shareFacebookBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on Facebook">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </button>
          <button id="shareWhatsAppBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on WhatsApp">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
            </svg>
          </button>
          <button id="copyLinkBtn" class="p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Copy link">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </button>
          <span id="copyFeedback" class="text-xs text-emerald-600 opacity-0 transition-opacity">Copied!</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden ReportIssueModal - Values will be updated dynamically -->
<ReportIssueModal
  idPrefix="modal"
  crimeSlug=""
  crimeHeadline=""
  crimeDate=""
  crimeType=""
  crimeArea=""
  crimeRegion=""
  crimeStreet=""
  crimeSummary=""
  crimeSource=""
  crimeUrl=""
/>

<script>
  const backdrop = document.getElementById('crimeDetailBackdrop');
  const modal = document.getElementById('crimeDetailModal');
  const content = document.getElementById('crimeDetailContent');
  const closeBtn = document.getElementById('closeCrimeDetailBtn');

  let currentCrimeUrl = '';
  let currentCrimeHeadline = '';
  let currentCrimeData = null; // Store full crime object

  // XSS Prevention: Escape HTML special characters
  function escapeHtml(str) {
    if (str == null) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  // XSS Prevention: Sanitize URLs (only allow http/https/relative)
  function sanitizeUrl(url) {
    if (url == null) return '';
    const trimmed = String(url).trim();
    if (trimmed.startsWith('/')) return trimmed;
    if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) return trimmed;
    return ''; // Block javascript:, data:, etc.
  }

  // Safety Context Calculator (client-side version of safetyHelpers.ts)
  function calculateAreaSafetyContext(areaName, allCrimes) {
    // Filter to recent crimes (last 90 days)
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - 90);

    const recentCrimesInArea = allCrimes.filter(c => {
      // Use dateObj if available, otherwise parse date string
      const crimeDate = c.dateObj ? new Date(c.dateObj) : new Date(c.date);
      return c.area === areaName && crimeDate >= cutoffDate;
    });

    const totalRecentCrimes = allCrimes.filter(c => {
      // Use dateObj if available, otherwise parse date string
      const crimeDate = c.dateObj ? new Date(c.dateObj) : new Date(c.date);
      return crimeDate >= cutoffDate;
    });

    // Calculate score
    const areaCrimeCount = recentCrimesInArea.length;
    const totalCrimeCount = totalRecentCrimes.length;

    if (totalCrimeCount === 0) {
      return { score: 1, level: 'low', tip: 'No recent data available for this area.', primaryCrimeType: 'None' };
    }

    const density = (areaCrimeCount / totalCrimeCount) * 100;

    // Score calculation (same as backend)
    let score;
    if (density <= 0.5) score = 1 + density;
    else if (density <= 1) score = 2 + (density - 0.5) * 2;
    else if (density <= 2) score = 3 + (density - 1);
    else if (density <= 3) score = 4 + (density - 2);
    else if (density <= 4) score = 5 + (density - 3);
    else if (density <= 5) score = 6 + (density - 4);
    else if (density <= 7) score = 7 + (density - 5) / 2;
    else if (density <= 10) score = 8 + (density - 7) / 3;
    else score = 9 + Math.min((density - 10) / 10, 1);

    score = Math.max(1, Math.min(10, Math.round(score * 10) / 10));

    // Get primary crime type
    const crimeTypeCounts = {};
    recentCrimesInArea.forEach(crime => {
      const type = crime.primaryCrimeType || crime.crimeType || 'Unknown';
      crimeTypeCounts[type] = (crimeTypeCounts[type] || 0) + 1;
    });

    const primaryCrimeType = Object.entries(crimeTypeCounts)
      .sort((a, b) => b[1] - a[1])[0]?.[0] || 'General Crime';

    // Determine level
    let level;
    if (score > 7) level = 'high';
    else if (score >= 4) level = 'neutral';
    else level = 'low';

    // Deterministic hash for area-seeded tip selection
    function hashStr(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      return Math.abs(hash);
    }

    const seed = hashStr(areaName.toLowerCase());

    // Get tip — expanded tips mirroring safetyHelpers.ts
    const highCrimeTips = {
      'Vehicle Theft': [
        "The 'Empty Seat' Protocol: Vehicle break-ins are a primary driver of the score in this zone. Never leave bags, charging cables, or even loose change visible; an empty car is rarely a target.",
        "Steering Lock Deterrent: Visible anti-theft devices like steering wheel locks reduce vehicle theft attempts significantly. A visual deterrent is often more effective than a hidden alarm in high-risk zones.",
        "Park Smart Strategy: In this area, vehicles parked in well-lit, high-traffic spots are targeted far less frequently. Avoid parking near blind corners, overgrown hedges, or unmonitored lots."
      ],
      'Robbery': [
        "Active Awareness Zone: This area has high reports of 'distraction' incidents. We recommend keeping mobile devices tucked away and avoiding the use of headphones while walking to remain fully alert.",
        "The Buddy System: Incident data shows that individuals walking alone after dark account for the majority of robbery reports here. Travel with a companion when possible during evening hours.",
        "Cash Minimisation: Avoid carrying large amounts of cash in this area. Use contactless payment methods where possible, and keep valuables distributed across pockets rather than in a single bag."
      ],
      'Burglary': [
        "Secondary Security Deterrence: Standard locks are often bypassed in this area's incident reports. Consider secondary deterrents like steering wheel locks or reinforced door strike plates for home security.",
        "The 'Occupied Home' Signal: Burglaries in this zone spike when homes appear vacant. Use timer-controlled lights, keep a radio on low volume, and vary your daily routine to avoid predictable absence patterns.",
        "Entry Point Audit: Most burglaries here target side windows and back doors. Ensure all secondary entry points have reinforced locks and consider window security film as a low-cost deterrent."
      ],
      'Murder': [
        "Conflict Avoidance Priority: Homicide data in this zone shows a strong correlation with interpersonal disputes. Avoid confrontations, leave heated situations immediately, and contact authorities if you feel threatened.",
        "Route Planning: Certain corridors in high-risk areas see disproportionate violent crime. Stick to main roads with active foot traffic, avoid shortcuts through isolated areas, and vary your travel routes regularly.",
        "Emergency Preparedness: In areas with elevated violent crime, keep your phone charged and accessible. Know the nearest police station location and have emergency contacts on speed dial."
      ],
      'Shooting': [
        "Sound Awareness Protocol: If you hear what sounds like gunfire, do not investigate. Move immediately to a solid interior wall or below window level, and call emergency services from a secure position.",
        "Avoid Congregating in Hotspots: Shooting incidents in this area often occur at specific gathering points. Stay aware of your surroundings and avoid lingering in areas with a history of incidents, especially after dark."
      ],
      default: [
        "Lighting & Line-of-Sight: Incident data here correlates with low-visibility hours. If possible, park only under active streetlights and avoid 'shortcuts' through alleys or unlit residential passages.",
        "General Alertness Protocol: This area's elevated score warrants heightened awareness. Keep valuables concealed, stay on well-trafficked routes, and trust your instincts if a situation feels unsafe.",
        "Report & Prevent: Active reporting helps law enforcement allocate resources effectively. If you witness suspicious activity in this zone, report it promptly — even anonymous tips help reduce repeat incidents."
      ]
    };

    const neutralTips = [
      "Baseline Awareness: This area currently maintains a stable safety standing. To help keep it that way, remain aware of your surroundings during 'transition times' like sunrise and sunset when visibility changes.",
      "The 9 PM Routine: Maintaining a '9 PM Routine'—checking that all car doors, house doors, and windows are locked every night—is often the difference between a neutral score and a high-crime score.",
      "Strategic Lighting Maintenance: Check that your porch and motion-sensor lights are in working order. Well-lit neighborhoods statistically discourage the types of property 'probing' common in mid-tier areas.",
      "Community Connection: Introduce yourself to your immediate neighbors. In areas with average crime scores, a connected block where people look out for each other's homes is the strongest deterrent available.",
      "Vehicle 'Clean-Floor' Policy: Even in stable areas, leaving an empty box or a gym bag in your car can invite a window smash. Keep your car interior completely clear to avoid 'curiosity' break-ins.",
      "The 'Walk With Purpose' Principle: In areas with moderate activity, how you carry yourself matters. Walking confidently, making brief eye contact, and moving with direction signals awareness to potential opportunists.",
      "Digital Footprint Caution: Avoid posting real-time location updates on social media when you're away from home. Burglars in moderate-risk areas increasingly use social media to identify empty properties.",
      "Landscaping as Security: Overgrown hedges and tall fences near entry points create concealment opportunities. Keep shrubs trimmed below window height and ensure your front door is visible from the street.",
      "Spare Key Discipline: Never hide a spare key under mats, flower pots, or fake rocks. In areas with this crime profile, these are the first places checked. Use a trusted neighbor or a combination lockbox instead.",
      "After-Dark Parking Protocol: When returning home after dark, park as close to your entrance as possible. Have your keys ready before you exit the vehicle and move directly to your door without lingering.",
      "Window Security Check: Ground-floor windows in mid-tier areas are common entry points for opportunistic crime. Ensure all accessible windows have functioning locks and consider adding window pins for extra security.",
      "Noise as Deterrent: A barking dog, a radio left on, or a TV timer can all signal occupancy. In areas with this safety profile, the perception of someone being home is often enough to deter a break-in attempt.",
      "Cash Point Awareness: ATM-related incidents are more common in moderate areas during off-peak hours. Use machines inside banks or well-lit commercial areas, and shield your PIN entry from view."
    ];

    const lowTips = [
      "Maintain the Standard: Keep up the great neighborhood lighting and locked-door habits that have made this area one of the safest in the region.",
      "Neighborhood Watch Excellence: Continue participating in community watch programs to maintain this area's superior safety standing.",
      "Security Maintenance: Regular checks of home security systems and outdoor lighting help maintain your area's excellent safety record.",
      "Community Vigilance: Your area's low crime rate is a testament to community cooperation. Continue reporting suspicious activity to maintain this achievement.",
      "Proactive Awareness: While your area enjoys low crime rates, maintaining basic security practices ensures it stays that way for years to come.",
      "Welcome New Residents: A strong community fabric is the foundation of low-crime neighborhoods. Welcoming new neighbors and sharing local safety norms helps preserve the culture that keeps crime rates low.",
      "Celebrate the Achievement: Your area's safety record is maintained by the collective habits of residents. Recognize that every locked door and reported concern contributes to this outcome.",
      "Youth Engagement: Low-crime areas that invest in youth activities and community programs tend to sustain their safety advantage long-term. Support or volunteer with local initiatives when possible.",
      "Emergency Preparedness: Even in the safest areas, having an emergency plan for natural disasters or unexpected events keeps your household resilient. Review your plan annually with all household members.",
      "Share What Works: Your neighborhood's safety practices can inspire other communities. Consider sharing your community watch strategies or security tips with adjacent areas to help raise the regional standard.",
      "Seasonal Vigilance: Crime patterns can shift during holiday seasons even in safe areas. Maintain your security routines during festive periods when homes may be unoccupied for travel.",
      "Digital Security Extension: Your physical safety record is strong — extend that discipline to your digital life. Use strong passwords, enable two-factor authentication, and be cautious with unsolicited messages."
    ];

    let tip;
    if (level === 'high') {
      const tips = highCrimeTips[primaryCrimeType] || highCrimeTips.default;
      tip = tips[seed % tips.length];
    } else if (level === 'neutral') {
      tip = neutralTips[seed % neutralTips.length];
    } else {
      tip = lowTips[seed % lowTips.length];
    }

    // Get positive note (seeded, not random)
    let positiveNote;
    if (level === 'high') {
      const highNotes = [
        "High Community Guardianship: Residents in this area are historically proactive about reporting suspicious activity early.",
        "Resilient Community Network: Despite the elevated score, this area shows strong community bonds with active neighbourhood watch participation and rapid incident reporting.",
        "Improving Trajectory: Recent reporting patterns suggest growing community engagement in crime prevention, which historically precedes measurable improvements in area safety scores.",
        "Active Law Enforcement Presence: This area benefits from increased police patrols and community policing initiatives, reflecting a collaborative effort between residents and authorities."
      ];
      positiveNote = highNotes[seed % highNotes.length];
    } else if (level === 'low') {
      const lowNotes = [
        `Safety Top Percentile: ${areaName} ranks in the top 10% for safety within the city, maintaining a consistently lower-than-average incident rate over the last 12 months.`,
        `The "Safe Haven" Status: With a safety score of ${score.toFixed(1)}, this area qualifies as a 'Safe Haven' zone, making it one of the most residentially stable pockets in the region.`,
        `Pedestrian-Friendly Rating: Low reports of street-level incidents make this one of the most pedestrian-friendly hotspots in our database for evening commutes and outdoor activity.`,
        `Property Stability Win: Residential property crimes remain significantly below the municipal average here, suggesting a high standard of home security and neighborly vigilance.`,
        `Family-Friendly Designation: ${areaName}'s consistently low incident rate makes it one of the most recommended areas for families seeking a safe residential environment.`,
        `Business Confidence Zone: Low crime areas like ${areaName} attract higher commercial investment, creating a positive cycle of foot traffic, lighting, and community presence that reinforces safety.`,
        `Evening Activity Safe Zone: With minimal after-dark incidents, ${areaName} supports an active evening culture — residents report feeling comfortable walking, jogging, and socialising well into the night.`,
        `Community Trust Index: Areas with scores this low typically show the highest levels of inter-neighbour trust, translating to faster incident response and stronger collective vigilance.`
      ];
      positiveNote = lowNotes[seed % lowNotes.length];
    }

    return { score, level, tip, positiveNote, primaryCrimeType };
  }

  // Generate Safety Context HTML
  function generateSafetyContextHTML(areaName, context) {
    const styles = {
      high: {
        bg: 'bg-amber-50',
        border: 'border-amber-200',
        icon: 'text-amber-600',
        title: 'text-amber-800',
        text: 'text-slate-700',
        label: 'Active Safety Alert',
        iconPath: 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z'
      },
      neutral: {
        bg: 'bg-slate-50',
        border: 'border-slate-200',
        icon: 'text-slate-500',
        title: 'text-slate-700',
        text: 'text-slate-600',
        label: 'Community Standing: Stable',
        iconPath: 'M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z'
      },
      low: {
        bg: 'bg-emerald-50',
        border: 'border-emerald-200',
        icon: 'text-emerald-600',
        title: 'text-emerald-800',
        text: 'text-slate-700',
        label: 'Safe Haven Status',
        iconPath: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z'
      }
    };

    const style = styles[context.level];

    return `
      <div class="${style.bg} ${style.border} border rounded-lg p-5">
        <div class="flex items-start gap-3">
          <div class="${style.icon} flex-shrink-0 mt-0.5">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${style.iconPath}" />
            </svg>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-semibold ${style.title} mb-1">
              ${style.label} - ${escapeHtml(areaName)}
            </h3>
            <div class="text-xs text-slate-500 mb-3">
              Risk Level: ${context.score.toFixed(1)}/10
              ${context.primaryCrimeType ? ` • Primary Concern: ${escapeHtml(context.primaryCrimeType)}` : ''}
            </div>
            <p class="text-sm ${style.text} leading-relaxed mb-3">
              ${escapeHtml(context.tip)}
            </p>
            ${context.positiveNote ? `
              <div class="mt-3 pt-3 border-t border-slate-200">
                <p class="text-sm text-slate-600 leading-relaxed italic">
                  ${escapeHtml(context.positiveNote)}
                </p>
              </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
  }

  // Generate Feedback Toggle HTML for modal
  function generateFeedbackToggleHTML(areaName, pageUrl, pageTitle) {
    const key = `feedback_safety_${areaName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;
    const existingVote = localStorage.getItem(key);
    const showVote = existingVote === null;

    return `
      <div class="feedback-toggle mt-4" data-area="${escapeHtml(areaName)}" data-url="${escapeHtml(pageUrl)}" data-title="${escapeHtml(pageTitle)}">
        <div class="feedback-vote ${showVote ? '' : 'hidden'} flex items-center justify-between p-4 bg-white border border-slate-200 rounded-lg">
          <span class="text-sm text-slate-600 font-medium">Was this safety insight helpful?</span>
          <div class="flex items-center gap-2">
            <button class="feedback-btn px-4 py-1.5 min-h-[22px] border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 active:bg-slate-100 transition font-medium text-xs" data-vote="yes" aria-label="Yes, this was helpful">Yes</button>
            <button class="feedback-btn px-4 py-1.5 min-h-[22px] border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 active:bg-slate-100 transition font-medium text-xs" data-vote="no" aria-label="No, this was not helpful">No</button>
          </div>
        </div>
        <div class="feedback-thanks ${showVote ? 'hidden' : ''} p-4 bg-white border border-slate-200 rounded-lg">
          <div class="flex items-center gap-2 mb-3">
            <span class="feedback-spark relative inline-flex items-center justify-center w-5 h-5">
              <svg class="w-4 h-4 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
            </span>
            <span class="text-sm text-slate-700 font-medium">Thanks for your feedback</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs text-slate-500">Share this page:</span>
            <button class="feedback-share-twitter p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on X (Twitter)" aria-label="Share on X (Twitter)">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
            </button>
            <button class="feedback-share-facebook p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on Facebook" aria-label="Share on Facebook">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
            </button>
            <button class="feedback-share-whatsapp p-2 rounded-lg border border-slate-300 text-slate-600 hover:bg-slate-50 transition" title="Share on WhatsApp" aria-label="Share on WhatsApp">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
            </button>
          </div>
        </div>
      </div>
    `;
  }

  // Initialize feedback toggle event listeners for modal
  function initModalFeedbackToggle(container) {
    if (!container) return;
    const areaName = container.dataset.area || '';
    const pageUrl = container.dataset.url || window.location.href;
    const pageTitle = container.dataset.title || document.title;
    const key = `feedback_safety_${areaName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;

    const voteEl = container.querySelector('.feedback-vote');
    const thanksEl = container.querySelector('.feedback-thanks');
    if (!voteEl || !thanksEl) return;

    // Already voted - state is handled by generateFeedbackToggleHTML
    if (localStorage.getItem(key) !== null) return;

    container.querySelectorAll('.feedback-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const vote = btn.dataset.vote || 'yes';
        localStorage.setItem(key, vote);

        voteEl.classList.add('hidden');
        thanksEl.classList.remove('hidden');

        const spark = thanksEl.querySelector('.feedback-spark');
        if (spark) {
          spark.classList.add('animate');
          setTimeout(() => spark.classList.remove('animate'), 700);
        }
      });
    });

    container.querySelector('.feedback-share-twitter')?.addEventListener('click', () => {
      const text = encodeURIComponent(pageTitle);
      const url = encodeURIComponent(pageUrl);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
    });

    container.querySelector('.feedback-share-facebook')?.addEventListener('click', () => {
      const url = encodeURIComponent(pageUrl);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=420');
    });

    container.querySelector('.feedback-share-whatsapp')?.addEventListener('click', () => {
      const text = encodeURIComponent(`${pageTitle} - ${pageUrl}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    });
  }

  // Function to open modal with crime data
  function openCrimeModal(crime) {
    if (!backdrop || !modal || !content) return;

    // Format date
    const formattedDate = new Date(crime.date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Populate modal content
    document.getElementById('modalHeadline').textContent = crime.headline;

    // Metadata (date, crime type, location)
    const metadata = document.getElementById('modalMetadata');

    // Build related crimes pills if they exist (with XSS escaping)
    let relatedCrimesPills = '';
    if (crime.relatedCrimeTypes && crime.relatedCrimeTypes.trim()) {
      const relatedCrimes = crime.relatedCrimeTypes.split(',').map(c => c.trim());
      relatedCrimesPills = relatedCrimes.map(relatedCrime =>
        `<span class="px-3 py-1 rounded-full bg-slate-300 text-slate-700 font-medium">${escapeHtml(relatedCrime)}</span>`
      ).join('');
    }

    metadata.innerHTML = `
      <time class="text-slate-500">${escapeHtml(formattedDate)}</time>
      <span class="px-3 py-1 rounded-full bg-rose-600 text-white font-medium">${escapeHtml(crime.crimeType)}</span>
      ${relatedCrimesPills}
      <span class="text-slate-500">${crime.street ? `${escapeHtml(crime.street)}, ` : ''}${escapeHtml(crime.area)}</span>
    `;

    // Summary (with XSS escaping)
    const summaryEl = document.getElementById('modalSummary');
    if (crime.summary) {
      summaryEl.innerHTML = `<p class="text-base text-slate-700 leading-relaxed">${escapeHtml(crime.summary)}</p>`;
    } else {
      summaryEl.innerHTML = '';
    }

    // Details grid (with XSS escaping)
    const detailsEl = document.getElementById('modalDetails');
    detailsEl.innerHTML = `
      <dt class="text-xs font-semibold text-slate-500">Region:</dt>
      <dd class="text-xs text-slate-700">${escapeHtml(crime.region)}</dd>
      ${crime.source ? `
        <dt class="text-xs font-semibold text-slate-500">Source:</dt>
        <dd class="text-xs text-slate-700">${escapeHtml(crime.source)}</dd>
      ` : ''}
    `;

    // Calculate and populate safety context
    const allCrimes = window.__crimesData || [];
    const safetyContext = calculateAreaSafetyContext(crime.area, allCrimes);

    // Populate safety context + feedback toggle
    const safetyContextEl = document.getElementById('modalSafetyContext');
    if (safetyContextEl) {
      const feedbackUrl = `https://crimehotspots.com/trinidad/crime/${crime.slug}`;
      safetyContextEl.innerHTML = generateSafetyContextHTML(crime.area, safetyContext)
        + generateFeedbackToggleHTML(crime.area, feedbackUrl, crime.headline);
      initModalFeedbackToggle(safetyContextEl.querySelector('.feedback-toggle'));
    }

    // Update button links (with URL sanitization)
    document.getElementById('modalViewFullBtn').href = `/trinidad/crime/${encodeURIComponent(crime.slug)}`;
    const sourceBtn = document.getElementById('modalSourceBtn');
    const safeUrl = sanitizeUrl(crime.url);
    if (safeUrl) {
      sourceBtn.href = safeUrl;
      sourceBtn.style.display = 'flex';
    } else {
      sourceBtn.style.display = 'none';
    }

    // Store for sharing and reporting
    currentCrimeUrl = `https://crimehotspots.com/trinidad/crime/${crime.slug}`;
    currentCrimeHeadline = crime.headline;
    currentCrimeData = crime; // Store full crime object for Report Issue

    // Show modal
    backdrop.classList.remove('hidden', 'pointer-events-none');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    requestAnimationFrame(() => {
      backdrop.classList.remove('opacity-0');
      backdrop.classList.add('opacity-100');
      content.classList.remove('scale-95', 'opacity-0');
      content.classList.add('scale-100', 'opacity-100');
    });
  }

  function closeCrimeModal() {
    if (!backdrop || !modal || !content) return;

    backdrop.classList.remove('opacity-100');
    backdrop.classList.add('opacity-0');
    content.classList.remove('scale-100', 'opacity-100');
    content.classList.add('scale-95', 'opacity-0');

    setTimeout(() => {
      backdrop.classList.add('hidden', 'pointer-events-none');
      modal.classList.add('hidden');
      document.body.style.overflow = '';
    }, 300);
  }

  // Event listeners
  if (closeBtn) {
    closeBtn.addEventListener('click', closeCrimeModal);
  }

  if (backdrop) {
    backdrop.addEventListener('click', closeCrimeModal);
  }

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && backdrop && !backdrop.classList.contains('hidden')) {
      closeCrimeModal();
    }
  });

  // Share button handlers
  const shareTwitterBtn = document.getElementById('shareTwitterBtn');
  const shareFacebookBtn = document.getElementById('shareFacebookBtn');
  const shareWhatsAppBtn = document.getElementById('shareWhatsAppBtn');
  const copyLinkBtn = document.getElementById('copyLinkBtn');
  const copyFeedback = document.getElementById('copyFeedback');

  if (shareTwitterBtn) {
    shareTwitterBtn.addEventListener('click', () => {
      const text = encodeURIComponent(currentCrimeHeadline);
      const url = encodeURIComponent(currentCrimeUrl);
      window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank', 'width=550,height=420');
    });
  }

  if (shareFacebookBtn) {
    shareFacebookBtn.addEventListener('click', () => {
      const url = encodeURIComponent(currentCrimeUrl);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=420');
    });
  }

  if (shareWhatsAppBtn) {
    shareWhatsAppBtn.addEventListener('click', () => {
      const text = encodeURIComponent(`${currentCrimeHeadline} - ${currentCrimeUrl}`);
      window.open(`https://wa.me/?text=${text}`, '_blank');
    });
  }

  if (copyLinkBtn && copyFeedback) {
    copyLinkBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(currentCrimeUrl);
        copyFeedback.classList.remove('opacity-0');
        copyFeedback.classList.add('opacity-100');
        setTimeout(() => {
          copyFeedback.classList.remove('opacity-100');
          copyFeedback.classList.add('opacity-0');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  }

  // Function to open modal by slug (for map markers and other external calls)
  function openCrimeDetailModal(slug) {
    // Get crimes from global variable (set by dashboardDataLoader)
    const crimes = window.__crimesData || [];
    const crime = crimes.find(c => c.slug === slug);

    if (crime) {
      openCrimeModal(crime);
    } else {
      console.error('Crime not found:', slug);
    }
  }

  // Handle Report Issue button click
  const modalReportIssueBtn = document.getElementById('modalReportIssueBtn');
  if (modalReportIssueBtn) {
    modalReportIssueBtn.addEventListener('click', () => {
      if (!currentCrimeData) {
        console.error('No crime data available');
        return;
      }

      console.log('Opening report issue modal with crime data:', currentCrimeData);

      // Update hidden form fields with current crime data
      const form = document.getElementById('modalreportIssueForm');
      if (!form) {
        console.error('Form not found: modalreportIssueForm');
        return;
      }

      try {
        // Update required hidden fields
        const slugInput = form.querySelector('input[name="crimeSlug"]');
        const headlineInput = form.querySelector('input[name="crimeHeadline"]');
        const dateInput = form.querySelector('input[name="crimeDate"]');
        const typeInput = form.querySelector('input[name="crimeType"]');
        const areaInput = form.querySelector('input[name="crimeArea"]');
        const regionInput = form.querySelector('input[name="crimeRegion"]');

        if (!slugInput || !headlineInput || !dateInput || !typeInput || !areaInput || !regionInput) {
          console.error('Required form fields not found', {
            slug: !!slugInput,
            headline: !!headlineInput,
            date: !!dateInput,
            type: !!typeInput,
            area: !!areaInput,
            region: !!regionInput
          });
          return;
        }

        slugInput.value = currentCrimeData.slug || '';
        headlineInput.value = currentCrimeData.headline || '';
        dateInput.value = currentCrimeData.date || '';
        typeInput.value = currentCrimeData.crimeType || '';
        areaInput.value = currentCrimeData.area || '';
        regionInput.value = currentCrimeData.region || '';

        // Update optional fields
        const streetInput = form.querySelector('input[name="crimeStreet"]');
        if (streetInput) streetInput.value = currentCrimeData.street || '';

        const summaryInput = form.querySelector('input[name="crimeSummary"]');
        if (summaryInput) summaryInput.value = currentCrimeData.summary || '';

        const sourceInput = form.querySelector('input[name="crimeSource"]');
        if (sourceInput) sourceInput.value = currentCrimeData.source || '';

        const urlInput = form.querySelector('input[name="crimeUrl"]');
        if (urlInput) urlInput.value = currentCrimeData.url || '';

        // Update preview text in the modal
        const previewHeadline = form.querySelector('.text-sm.font-semibold.text-slate-700');
        if (previewHeadline) previewHeadline.textContent = currentCrimeData.headline || '';

        const previewMeta = form.querySelector('.text-xs.text-slate-500.mt-1');
        if (previewMeta) previewMeta.textContent = `${currentCrimeData.date || ''} • ${currentCrimeData.area || ''}`;

        console.log('Form fields populated successfully');
      } catch (error) {
        console.error('Error populating form fields:', error);
        return;
      }

      // Directly open the ReportIssueModal
      const reportIssueModal = document.getElementById('modalreportIssueModal');
      const reportIssueContent = document.getElementById('modalreportIssueContent');

      if (reportIssueModal && reportIssueContent) {
        reportIssueModal.classList.remove('invisible', 'opacity-0');
        reportIssueModal.classList.add('visible', 'opacity-100');
        setTimeout(() => {
          reportIssueContent.classList.remove('opacity-0', 'scale-95');
          reportIssueContent.classList.add('opacity-100', 'scale-100');
        }, 50);

        // Trigger Turnstile rendering by dispatching a custom event
        window.dispatchEvent(new CustomEvent('openReportIssueModal', { detail: { idPrefix: 'modal' } }));
      }
    });
  }

  // Expose functions globally so cards/markers can call them
  window.openCrimeModal = openCrimeModal;
  window.openCrimeDetailModal = openCrimeDetailModal;
</script>
