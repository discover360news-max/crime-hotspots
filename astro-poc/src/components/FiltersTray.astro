---
/**
 * FiltersTray Component
 * Reusable slide-out filter tray for dashboards and headlines
 * Includes year filter and crime type filter
 */

interface Props {
  showYearFilter?: boolean;
  showCrimeTypeFilter?: boolean;
}

const { showYearFilter = true, showCrimeTypeFilter = false } = Astro.props;

// Crime types for filter checkboxes
const crimeTypes = [
  'Murder',
  'Robbery',
  'Home Invasion',
  'Theft',
  'Shooting',
  'Assault',
  'Burglary',
  'Seizures',
  'Kidnapping'
];
---

<!-- Filters Tray -->
<div id="filtersTray" class="fixed inset-0 z-50 pointer-events-none overflow-hidden">
  <!-- Backdrop -->
  <div id="filtersBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300 pointer-events-none"></div>

  <!-- Tray Content -->
  <div id="filtersTrayContent" class="absolute right-0 top-0 h-full w-80 bg-white/85 dark:bg-[hsl(0_0%_8%)]/90 backdrop-blur-lg rounded-l-2xl shadow-2xl transform translate-x-full transition-transform duration-300 pointer-events-auto overflow-y-auto">
    <div class="p-5">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-bold text-slate-700 dark:text-[hsl(0_0%_92%)]">Filters</h2>
        <button id="closeFiltersBtn" class="text-slate-400 dark:text-[hsl(0_0%_50%)] hover:text-slate-600 dark:hover:text-[hsl(0_0%_75%)] transition">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>

      <!-- Filter Options -->
      <div class="space-y-6">
        <!-- Year Filter -->
        {showYearFilter && (
          <div>
            <label for="yearFilter" class="block text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_85%)] mb-2">Select Year</label>
            <select id="yearFilter" class="filter-select w-full pl-4 pr-10 py-2.5 border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-500 dark:text-[hsl(0_0%_55%)] rounded-lg hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] transition font-medium text-xs bg-white/50 dark:bg-[hsl(0_0%_10%)]">
              <!-- Options populated dynamically by JavaScript -->
            </select>
          </div>
        )}

        <!-- Crime Type Filter -->
        {showCrimeTypeFilter && (
          <div>
            <label for="crimeTypeFilter" class="block text-sm font-medium text-slate-700 dark:text-[hsl(0_0%_85%)] mb-2">Crime Types</label>
            <select
              id="crimeTypeFilter"
              class="filter-select w-full pl-4 pr-10 py-2.5 border border-slate-300 dark:border-[hsl(0_0%_22%)] text-slate-500 dark:text-[hsl(0_0%_55%)] rounded-lg hover:bg-slate-50 dark:hover:bg-[hsl(0_0%_12%)] transition font-medium text-xs bg-white/50 dark:bg-[hsl(0_0%_10%)]"
            >
              <option value="" selected>All Crime Types</option>
              {crimeTypes.map((crimeType) => (
                <option value={crimeType}>
                  {crimeType}
                </option>
              ))}
            </select>
          </div>
        )}

        <!-- Future filters can be added here via slots -->
        <slot />
      </div>
    </div>
  </div>
</div>

<script>
  // Fresh DOM query each call — never capture references at module level.
  // Module scripts run ONCE per session; SPA navigation swaps the body,
  // making any top-level element references stale on re-visit.

  function openFiltersTray() {
    const filtersTray = document.getElementById('filtersTray');
    const filtersBackdrop = document.getElementById('filtersBackdrop');
    const filtersTrayContent = document.getElementById('filtersTrayContent');
    if (!filtersTray || !filtersBackdrop || !filtersTrayContent) return;

    filtersTray.classList.remove('pointer-events-none');
    filtersBackdrop.classList.remove('pointer-events-none');
    setTimeout(() => {
      filtersBackdrop.classList.remove('opacity-0');
      filtersTrayContent.classList.remove('translate-x-full');
    }, 10);
  }

  function closeFiltersTray() {
    const filtersTray = document.getElementById('filtersTray');
    const filtersBackdrop = document.getElementById('filtersBackdrop');
    const filtersTrayContent = document.getElementById('filtersTrayContent');
    if (!filtersTray || !filtersBackdrop || !filtersTrayContent) return;

    filtersBackdrop.classList.add('opacity-0');
    filtersTrayContent.classList.add('translate-x-full');
    setTimeout(() => {
      filtersTray.classList.add('pointer-events-none');
      filtersBackdrop.classList.add('pointer-events-none');
    }, 300);
  }

  // Keydown registered once at module level — queries DOM fresh each invocation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const filtersTray = document.getElementById('filtersTray');
      if (filtersTray && !filtersTray.classList.contains('pointer-events-none')) {
        closeFiltersTray();
      }
    }
  });

  // Re-attach click listeners on every navigation (astro:page-load fires on
  // initial load + after each SPA navigation via ClientRouter)
  document.addEventListener('astro:page-load', () => {
    const filtersBtn = document.getElementById('filtersBtn');
    const filtersBackdrop = document.getElementById('filtersBackdrop');
    const closeFiltersBtn = document.getElementById('closeFiltersBtn');

    if (filtersBtn) filtersBtn.addEventListener('click', openFiltersTray);
    if (closeFiltersBtn) closeFiltersBtn.addEventListener('click', closeFiltersTray);
    if (filtersBackdrop) filtersBackdrop.addEventListener('click', closeFiltersTray);
  });
</script>
