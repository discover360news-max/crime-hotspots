---
/**
 * Trending Hotspots Component
 *
 * Two sections to increase page views per session:
 * 1. "Hot Areas This Week" — Top 5 areas by crime count (server-rendered)
 * 2. "Your Recent Views" — Last 3 crime pages visited (client-side localStorage)
 *
 * Placement: Between article and SafetyContext on crime detail pages.
 * Also rendered in CrimeDetailModal via modalHtmlGenerators.ts.
 *
 * Created: February 8, 2026
 */

import { getHotAreas } from '../lib/trendingHelpers';
import { buildRoute, routes } from '../config/routes';
import type { Crime } from '../lib/crimeData';

interface Props {
  allCrimes: Crime[];
  currentSlug: string;
  currentHeadline: string;
  currentArea: string;
}

const { allCrimes, currentSlug, currentHeadline, currentArea } = Astro.props;

// Compute hot areas server-side (reuses already-loaded allCrimes array)
const hotAreas = getHotAreas(allCrimes, 5);

// Heat dot color by rank
const getHeatColor = (rank: number): string => {
  if (rank === 1) return 'bg-rose-500';
  if (rank <= 3) return 'bg-rose-400';
  return 'bg-rose-300';
};
---

<div class="mt-6 space-y-4" data-pagefind-ignore>
  {/* Section 1: Hot Areas This Week (server-rendered) */}
  {hotAreas.length > 0 && (
    <aside class="p-4 bg-slate-50/80 dark:bg-[hsl(0_0%_6%)/80] backdrop-blur-sm rounded-lg border border-slate-200 dark:border-[hsl(0_0%_18%)]">
      <h2 class="text-caption font-bold text-slate-700 dark:text-[hsl(0_0%_85%)] mb-3 flex items-center gap-2 uppercase tracking-wider">
        <svg class="w-4 h-4 text-rose-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 23a7 7 0 01-7-7c0-3.15 2.26-5.97 4.5-8.5.45-.5 1.55-.5 2 0C13.74 10.03 19 12.85 19 16a7 7 0 01-7 7zm0-12.5c-1.5 2-3.5 4.5-3.5 5.5a3.5 3.5 0 107 0c0-1-2-3.5-3.5-5.5z"/>
        </svg>
        Hot Areas This Week
      </h2>

      <div class="space-y-2">
        {hotAreas.map((hotArea) => (
          <a
            href={buildRoute.area(hotArea.areaSlug)}
            class="block p-3 bg-white dark:bg-[hsl(0_0%_10%)] rounded-lg border border-slate-100 dark:border-[hsl(0_0%_15%)] hover:border-rose-200 dark:hover:border-rose-800 hover:shadow-sm transition-all group"
          >
            <div class="flex items-center gap-2">
              <span class={`w-2 h-2 rounded-full flex-shrink-0 ${getHeatColor(hotArea.rank)}`}></span>
              <div class="flex-1 min-w-0">
                <p class="text-caption font-bold text-slate-700 dark:text-[hsl(0_0%_88%)] group-hover:text-rose-600 dark:group-hover:text-rose-400 transition-colors truncate">
                  {hotArea.area}
                </p>
              </div>
              <span class="text-caption px-1.5 py-0.5 bg-rose-50 dark:bg-rose-950/50 text-rose-600 dark:text-rose-400 rounded flex-shrink-0">
                {hotArea.count} {hotArea.count === 1 ? 'crime' : 'crimes'}
              </span>
              <svg class="w-3 h-3 text-slate-300 group-hover:text-rose-400 transition-colors flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </div>
          </a>
        ))}
      </div>

      <a
        href={routes.trinidad.areas}
        class="mt-3 flex items-center justify-center gap-1 w-full py-2 text-caption font-bold text-rose-600 hover:text-rose-700 hover:bg-rose-50 dark:hover:bg-rose-950/40 rounded-lg transition-colors"
      >
        View all areas
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </aside>
  )}

  {/* Section 2: Your Recent Views (client-side, hidden by default) */}
  <aside id="recentViewsSection" class="hidden p-4 bg-slate-50/80 dark:bg-[hsl(0_0%_6%)/80] backdrop-blur-sm rounded-lg border border-slate-200 dark:border-[hsl(0_0%_18%)]">
    <h2 class="text-sm font-bold text-slate-700 dark:text-[hsl(0_0%_85%)] mb-3 flex items-center gap-2">
      <svg class="w-4 h-4 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Your Recent Views
    </h2>
    <div id="recentViewsCards" class="space-y-2"></div>
  </aside>
</div>

{/* Hidden element to pass server data to client script */}
<div id="trendingHotspotsData" class="hidden"
  data-slug={currentSlug}
  data-headline={currentHeadline}
  data-area={currentArea}
></div>

<script>
  import { trackRecentView, getRecentViews } from '../lib/trendingHelpers';
  import { buildRoute } from '../config/routes';
  import { escapeHtml } from '../lib/escapeHtml';

  const dataEl = document.getElementById('trendingHotspotsData');
  if (dataEl) {
    const slug = dataEl.dataset.slug || '';
    const headline = dataEl.dataset.headline || '';
    const area = dataEl.dataset.area || '';

    // Track current page view
    if (slug) {
      trackRecentView(slug, headline, area);
    }

    // Populate recent views
    const recentViews = getRecentViews(slug, 3);
    if (recentViews.length > 0) {
      const section = document.getElementById('recentViewsSection');
      const container = document.getElementById('recentViewsCards');
      if (section && container) {
        container.innerHTML = recentViews.map(view => {
          const crimeUrl = buildRoute.crime(view.slug);
          // Use CSS custom properties (var(--ch-*)) for dark mode compat — dark: classes
          // are not reliably scanned inside JS string literals by Tailwind v4's JIT.
          return `
            <a href="${escapeHtml(crimeUrl)}" class="block p-3 rounded-lg border hover:border-rose-200 hover:shadow-sm transition-all group" style="background:var(--ch-surface);border-color:var(--ch-border)">
              <div class="flex items-start gap-2">
                <span class="w-2 h-2 rounded-full mt-1.5 flex-shrink-0 bg-slate-400"></span>
                <div class="flex-1 min-w-0">
                  <p class="text-caption font-bold transition-colors line-clamp-2" style="color:var(--ch-text)">
                    ${escapeHtml(view.headline)}
                  </p>
                  <span class="text-caption" style="color:var(--ch-text-muted)">${escapeHtml(view.area)}</span>
                </div>
                <svg class="w-3 h-3 text-slate-300 group-hover:text-rose-400 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          `;
        }).join('');
        section.classList.remove('hidden');
      }
    }
  }
</script>
