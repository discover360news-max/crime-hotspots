# January 2026 Features (Archived)

**Archived from:** `docs/claude-context/recent-features.md`
**Current features list:** `docs/claude-context/site-features.md`

---

### Dynamic OG Image for Murder Count (Jan 28)

Build-time OG image generation using satori (JSX → SVG) + sharp (SVG → PNG). 1200x630 design with murder count, YoY change, murder rate, branding. Regenerates daily with GitHub Actions rebuild.

**Files Created:** `src/lib/generateOgImage.ts`, `public/fonts/Inter-Regular.otf`, `Inter-Bold.otf`
**Files Modified:** `murder-count.astro`, `Layout.astro` (og:image:width/height meta tags)
**Dependencies Added:** `satori`, `sharp`

---

### Murder Count Page Performance (Jan 28)

Turnstile CAPTCHA made opt-in via `includeTurnstile` prop (defaults false). Pagefind disabled on murder count page. Eliminates 3 requests (~60-80KB). Pages needing Turnstile: report, headlines, dashboard, archive/[year]/[month], crime/[slug].

---

### Security Hardening Audit (Jan 27)

Removed stale Google Fonts from CSP, added Secure cookie flag, added `escapeHtml()` to GAS email templates. Updated `@astrojs/cloudflare` to 12.6.12 (SSRF fix). **Grade: A-.**

---

### LCP Font Optimization + Hero Compact (Jan 27)

Self-hosted Inter font (woff2) — eliminated Google Fonts external request chain (~200-500ms LCP saving). Added `compact` variant and `<slot>` support to `Hero.astro`. Headlines page uses compact Hero.

---

### Safety Context System (Jan 26)

Area-based crime scores (1-10 scale) using 90-day rolling window crime density. Color-coded contextual safety tips: high risk (>7, amber), neutral (4-6, slate), low (<4, emerald). Integrated into crime detail pages AND CrimeDetailModal.

**Files Created:** `src/lib/safetyHelpers.ts`, `src/components/SafetyContext.astro`
**Gotcha:** Modal requires `window.__crimesData` to be populated. Client-side calculation must use `dateObj` field.

---

### Component Refactoring (Jan 26)

Created reusable components: `Hero.astro` (102 lines), `StatCards.astro` (48 lines), `DataTable.astro` (32 lines). Refactored statistics page to use them.

---

### Hybrid → Full SSR Switch (Jan 26 → Feb 4)

Initially implemented 90-day hybrid rendering (Jan 26). Switched to full SSR + CDN cache (Feb 4) because old crime pages 404'd silently, causing GSC to report 446+ canonical issues. Now: all crime pages SSR, CDN-Cache-Control: 24h, browser cache: 1h.

**Never:** Add `prerender = true` back to `[slug].astro`.

---

### SEO Phase 1: Statistics & Internal Linking (Jan 23)

Statistics page three-tier crime rate system (previous year final / current YTD / projected). Dynamic year handling (auto-calculates from `getFullYear()`). Murder count title optimized for exact query "how many murders in trinidad 2026". Internal linking network between dashboard ↔ statistics ↔ murder count.

**Key formulas:** Crime rate: `(count / 1500000) * 100000`. Projection: `(count / daysElapsed) * 365`.

---

### Murder Count 2026 Page (Jan 22)

iOS-style flip counter with split-flap animation (staggered 80ms digit flipping, 3D perspective). Responsive scaling for 2-4 digits. Share buttons (WhatsApp, Facebook, X, Copy Link). JSON-LD structured data.

**Files Created:** `murder-count.astro`, `FlipCounter.astro`, `flip-counter.css`, `flipCounter.ts`
**Technical:** CSS `line-height` clipping for split-digit effect, `data-digits` for responsive scaling.

---

### Related Crime Pills (Jan 10)

Visual pills for related crime types (gray slate-300) next to primary (rose-600). Auto-parses comma-separated `relatedCrimeTypes` field. CSV parsing fix: `parseCSVLine()` for quoted fields, `stripQuotes()` for smart quotes.

**Files Modified:** `[slug].astro`, `CrimeDetailModal.astro`, `areaAliases.ts`

---

### Report Page Refactoring (Jan 9)

Extracted `formHelpers.ts` (165 lines) and `reportValidation.ts` (146 lines). Report page 672 → 522 lines. Added Report Issue button to CrimeDetailModal. Fixed Turnstile explicit rendering error 600010.

**Key Learnings:**
- Turnstile explicit mode: use EITHER data attributes OR render() config, not both
- Components on same page need `idPrefix` for unique IDs
- Centralized Apps Script URL via `countries.ts` export

---

### Component Audit (Jan 9)

Audited 21 components, archived TextInfoPopup.astro (replaced by InfoPopup.astro). 20/21 actively in use.

---

### Automated Cloudflare Deployment (Jan 8)

Integrated Cloudflare API deployment trigger into GitHub Actions. Runs on: push to main, scheduled (6 AM UTC), manual dispatch. Uses secrets: CLOUDFLARE_ACCOUNT_ID, CLOUDFLARE_API_TOKEN, CLOUDFLARE_PROJECT_NAME.

**Files:** `.github/workflows/deploy.yml`

---

### Traffic Analysis & SEO Foundation (Jan 5)

Analyzed traffic: 99% bots, ~4 real humans/day. Bot Fight Mode blocking 1,150 malicious requests/day. Google Search Console: 1,728 pages discovered, sitemap submitted. Zero-budget social growth strategy planned.

---

### 2026 Crime Format & Victim Count (Jan 5)

Updated GAS scripts for 2026 format: primaryCrimeType + relatedCrimeTypes + victim count multipliers. Added CRIME_TYPE_CONFIG. Backward compatible with 2025 data.

**Critical Rule:** Victim count ONLY applies to primary crime type. Related crimes always +1.

---

### LCP Optimization & Map Modal UX (Jan 4)

Conditional resource loading (Leaflet only on map pages, ~150KB saving). Image optimization: Trinidad PNG → JPG (75KB → 41KB). Resource hints: dns-prefetch, preconnect. Map marker "View Details" opens modal instead of navigating.

**Impact:** ~500-900ms LCP reduction, ~184KB saved.

---

### Area Tooltips (Jan 3)

AreaNameTooltip on dashboard Top Areas. Viewport boundary detection with 8px padding. Fixed duplicate listeners with `data-tooltip-initialized` flag. Click: tap shows, tap outside hides.

---

### Headlines Date Accordion & Victim Count (Jan 3)

DateAccordion groups crimes by date. Smart display: accordions when no filters, flat grid when filtering. Headers show "X victims" instead of "X crimes" (uses victimCount field, defaults to 1).

---

### Victim Count System (Jan 1)

Added victimCount field to crime schema. Configurable per crime type in `crimeTypeConfig.ts`. Retired Gemini automation, transitioned to manual Google Form entry.

---

### Social Media Stats Triple-Mode (Jan 1)

Fixed date boundaries to noon (prevents timezone edge cases). Three modes: daily (3-day lag), monthly (no lag), custom (manual range). `SOCIAL_CONFIG.lagDays = 3`.
